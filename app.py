from flask import Flask, request, jsonify
import os
import requests
import logging
import random
import time
from datetime import datetime, timedelta

app = Flask(__name__)
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(name)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
BOT_TOKEN = os.environ.get('BOT_TOKEN')
if not BOT_TOKEN:
    logger.error("‚ùå BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")
    raise ValueError("BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è!")

# –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π –¥–∏–∞–ª–æ–≥–æ–≤
conversations = {}
user_data = {}

def send_message(chat_id, text, parse_mode='Markdown'):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram API"""
    try:
        url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
        payload = {
            'chat_id': chat_id,
            'text': text,
            'parse_mode': parse_mode
        }
        
        response = requests.post(url, json=payload, timeout=10)
        
        if response.status_code != 200:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {response.text}")
        else:
            logger.info(f"‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ {chat_id}")
        
        return response.json()
    except Exception as e:
        logger.error(f"üö® –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ: {e}")
        return None

def get_conversation_state(chat_id):
    """–ü–æ–ª—É—á–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º"""
    if chat_id not in conversations:
        conversations[chat_id] = {
            'step': 'start',
            'question': '',
            'last_message_time': time.time(),
            'message_count': 0,
            'name': '',
            'interest_shown': False,
            'objections': []
        }
    return conversations[chat_id]

def update_conversation_state(chat_id, updates):
    """–û–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞"""
    state = get_conversation_state(chat_id)
    state.update(updates)
    state['last_message_time'] = time.time()
    state['message_count'] += 1

def generate_human_response(user_message, state):
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–π –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∏–∞–ª–æ–≥–∞"""
    user_message_lower = user_message.lower()
    step = state['step']
    
    # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    greetings = ['–ø—Ä–∏–≤–µ—Ç', '–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π', '–¥–æ–±—Ä—ã–π', '–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ', 'hi', 'hello', 'start']
    if any(greet in user_message_lower for greet in greetings) or step == 'start':
        responses = [
            "–ü—Ä–∏–≤–µ—Ç! üëã –Ø –ê–Ω–Ω–∞, –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ç–∞—Ä–æ–ª–æ–≥. –†–∞–¥–∞ –≤–∞—Å –≤–∏–¥–µ—Ç—å!\n\n–ö–∞–∫ —è –º–æ–≥—É –≤–∞–º –ø–æ–º–æ—á—å? –ú–æ–∂–µ—Ç, –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π —Ö–æ—Ç–µ–ª–æ—Å—å –±—ã –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç –∫–∞—Ä—Ç?",
            "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –ê–Ω–Ω–∞, –ø—Ä–∞–∫—Ç–∏–∫—É—é—â–∏–π —Ç–∞—Ä–æ–ª–æ–≥ —Å 8-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º. –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ, —á—Ç–æ –≤–∞—Å –ø—Ä–∏–≤–µ–ª–æ –∫–æ –º–Ω–µ —Å–µ–≥–æ–¥–Ω—è? –ï—Å—Ç—å –ª–∏ —Å–∏—Ç—É–∞—Ü–∏—è, –≤ –∫–æ—Ç–æ—Ä–æ–π –Ω—É–∂–Ω–∞ —è—Å–Ω–æ—Å—Ç—å?",
            "–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é! –ú–µ–Ω—è –∑–æ–≤—É—Ç –ê–Ω–Ω–∞, —è –ø–æ–º–æ–≥–∞—é –ª—é–¥—è–º –Ω–∞—Ö–æ–¥–∏—Ç—å –æ—Ç–≤–µ—Ç—ã —Å –ø–æ–º–æ—â—å—é –¢–∞—Ä–æ. –ß—Ç–æ –≤–∞—Å –±–µ—Å–ø–æ–∫–æ–∏—Ç –∏–ª–∏ –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –∂–∏–∑–Ω–∏?"
        ]
        return random.choice(responses)
    
    # –í–æ–ø—Ä–æ—Å—ã –æ —Å—Ç–æ–∏–º–æ—Å—Ç–∏
    price_keywords = ['—Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç', '—Ü–µ–Ω–∞', '—Å—Ç–æ–∏–º–æ—Å—Ç—å', '–ø–ª–∞—Ç–Ω–æ', '–±–µ—Å–ø–ª–∞—Ç–Ω–æ', '–¥–µ–Ω—å–≥–∏']
    if any(keyword in user_message_lower for keyword in price_keywords):
        state['interest_shown'] = True
        responses = [
            "–û—Ç–ª–∏—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å! –£ –º–µ–Ω—è –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–æ—Ä–º–∞—Ç–æ–≤ —Ä–∞–±–æ—Ç—ã:\n\n‚Ä¢ *–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è*: —è –∑–∞–¥–∞–º –≤–∞–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å–æ–≤, –ø–æ–π–º—É –≤–∞—à—É —Å–∏—Ç—É–∞—Ü–∏—é –∏ —Å–∫–∞–∂—É, —Å–º–æ–≥—É –ª–∏ —è –ø–æ–º–æ—á—å\n‚Ä¢ *–ü–æ–ª–Ω—ã–π —Ä–∞—Å–∫–ª–∞–¥ –¢–∞—Ä–æ*: 1490 —Ä—É–±. - –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å–∏—Ç—É–∞—Ü–∏–∏ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏\n\n–ß—Ç–æ –≤–∞—Å –±–æ–ª—å—à–µ –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?",
            "–¶–µ–Ω–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≥–ª—É–±–∏–Ω—ã –∞–Ω–∞–ª–∏–∑–∞, –∫–æ—Ç–æ—Ä—ã–π –≤–∞–º –Ω—É–∂–µ–Ω. –û–±—ã—á–Ω–æ —è –¥–µ–ª–∞—é –¥–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞:\n\n1. *–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ä–∞–∑–±–æ—Ä*: 10-15 –º–∏–Ω—É—Ç, —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å, —Å–º–æ–≥—É –ª–∏ —è –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω–∞ –≤ –≤–∞—à–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏\n2. *–ü–æ–ª–Ω—ã–π —Ä–∞—Å–∫–ª–∞–¥*: 1490 —Ä—É–±. - 40-50 –º–∏–Ω—É—Ç –¥–µ—Ç–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å –∫–∞—Ä—Ç–∞–º–∏\n\n–•–æ—Ç–∏—Ç–µ –Ω–∞—á–∞—Ç—å —Å –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ —Ä–∞–∑–±–æ—Ä–∞?",
            "–Ø —Ä–∞–±–æ—Ç–∞—é —Ç–∞–∫: —Å–Ω–∞—á–∞–ª–∞ –º—ã –±–µ—Å–ø–ª–∞—Ç–Ω–æ –æ–±—Å—É–¥–∏–º –≤–∞—à—É —Å–∏—Ç—É–∞—Ü–∏—é (15 –º–∏–Ω—É—Ç), —è –ø–æ–π–º—É, —Å–º–æ–≥—É –ª–∏ –ø–æ–º–æ—á—å. –ï—Å–ª–∏ –¥–∞ - –¥–µ–ª–∞—é –ø–æ–ª–Ω—ã–π —Ä–∞—Å–∫–ª–∞–¥ –∑–∞ 1490 —Ä—É–±.\n\n–≠—Ç–æ —á–µ—Å—Ç–Ω–æ –ø–æ –æ—Ç–Ω–æ—à–µ–Ω–∏—é –∫ –≤–∞–º - –≤—ã –ø–ª–∞—Ç–∏—Ç–µ —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ –º–æ—è —Ä–∞–±–æ—Ç–∞ –±—É–¥–µ—Ç –ø–æ–ª–µ–∑–Ω–∞. –ö–∞–∫ –≤–∞–º —Ç–∞–∫–æ–π –ø–æ–¥—Ö–æ–¥?"
        ]
        return random.choice(responses)
    
    # –í–æ–ø—Ä–æ—Å—ã –æ –ø—Ä–æ—Ü–µ—Å—Å–µ
    process_keywords = ['–∫–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç', '–∫–∞–∫ –ø—Ä–æ—Ö–æ–¥–∏—Ç', '–ø—Ä–æ—Ü–µ—Å—Å', '–¥–µ–ª–∞–µ—à—å', '—Ä–∞–±–æ—Ç–∞–µ—à—å']
    if any(keyword in user_message_lower for keyword in process_keywords):
        responses = [
            "–Ø —Ä–∞–±–æ—Ç–∞—é –æ—á–µ–Ω—å –ø—Ä–æ—Å—Ç–æ:\n1. –í—ã —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—Ç–µ –æ —Å–∏—Ç—É–∞—Ü–∏–∏ (–º–æ–∂–Ω–æ –∫—Ä–∞—Ç–∫–æ)\n2. –Ø –∑–∞–¥–∞—é —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ\n3. –î–µ–ª–∞—é —Ä–∞—Å–∫–ª–∞–¥ –∏–∑ 5-7 –∫–∞—Ä—Ç, –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç–∏\n4. –û–±—ä—è—Å–Ω—è—é, —á—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –∫–∞—Ä—Ç—ã, –¥–∞—é —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏\n5. –í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —à–∞–≥–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥—É—Ç —É–ª—É—á—à–∏—Ç—å —Å–∏—Ç—É–∞—Ü–∏—é\n\n–í —Å—Ä–µ–¥–Ω–µ–º –Ω–∞ –≤—Å–µ —É—Ö–æ–¥–∏—Ç –æ–∫–æ–ª–æ —á–∞—Å–∞ –º–æ–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏.",
            "–ü—Ä–æ—Ü–µ—Å—Å –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫:\n‚Ä¢ –í—ã –¥–µ–ª–∏—Ç–µ—Å—å —Ç–µ–º, —á—Ç–æ –≤–∞—Å –≤–æ–ª–Ω—É–µ—Ç\n‚Ä¢ –Ø –ø–æ–¥–∫–ª—é—á–∞—é—Å—å –∫ —ç–Ω–µ—Ä–≥–∏–∏ —Å–∏—Ç—É–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –∫–∞—Ä—Ç—ã\n‚Ä¢ –î–µ–ª–∞—é —Ä–∞—Å–∫–ª–∞–¥ –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é —Å–≤—è–∑–∏ –º–µ–∂–¥—É –∫–∞—Ä—Ç–∞–º–∏\n‚Ä¢ –î–∞—é –Ω–µ –ø—Ä–æ—Å—Ç–æ ¬´–ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ¬ª, –∞ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã\n‚Ä¢ –û—Ç–≤–µ—á–∞—é –Ω–∞ –≤–∞—à–∏ –≤–æ–ø—Ä–æ—Å—ã –ø–æ —Ä–∞—Å–∫–ª–∞–¥—É\n\n–≠—Ç–æ –¥–∏–∞–ª–æ–≥, –∞ –Ω–µ –º–æ–Ω–æ–ª–æ–≥. –í–∞–∂–Ω–æ, —á—Ç–æ–±—ã –≤—ã –ø–æ–Ω–∏–º–∞–ª–∏ –∫–∞–∂–¥—ã–π —ç—Ç–∞–ø.",
            "–ú–æ—è —Ä–∞–±–æ—Ç–∞ - —ç—Ç–æ –¥–∏–∞–ª–æ–≥ —Å –∫–∞—Ä—Ç–∞–º–∏ –∏ —Å –≤–∞–º–∏. –°–Ω–∞—á–∞–ª–∞ —è —Å–ª—É—à–∞—é –≤–∞—à—É –∏—Å—Ç–æ—Ä–∏—é, –ø–æ—Ç–æ–º —Å–ø—Ä–∞—à–∏–≤–∞—é –∫–∞—Ä—Ç—ã, —á—Ç–æ –æ–Ω–∏ –¥—É–º–∞—é—Ç –æ–± —ç—Ç–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏, –∞ –∑–∞—Ç–µ–º —Å–æ–µ–¥–∏–Ω—è—é –∏—Ö –æ—Ç–≤–µ—Ç—ã —Å —Ä–µ–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω—å—é. –ü–æ–ª—É—á–∞–µ—Ç—Å—è –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑, –∞ –Ω–µ –≥–∞–¥–∞–Ω–∏–µ. –•–æ—Ç–∏—Ç–µ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å?"
        ]
        return random.choice(responses)
    
    # –í–æ–ø—Ä–æ—Å—ã –æ–± —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    effect_keywords = ['–ø–æ–º–æ–∂–µ—à—å', '—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ', '—Ä–µ–∑—É–ª—å—Ç–∞—Ç', '—Ä–∞–±–æ—Ç–∞–µ—Ç', '–≥–∞—Ä–∞–Ω—Ç–∏—è', '—Ç–æ—á–Ω–æ—Å—Ç—å']
    if any(keyword in user_message_lower for keyword in effect_keywords):
        responses = [
            "–Ø –Ω–µ –¥–∞—é –≥–∞—Ä–∞–Ω—Ç–∏–π –≤ —Å—Ç–∏–ª–µ ¬´–≤—Å–µ —Å–±—É–¥–µ—Ç—Å—è¬ª, –ø–æ—Ç–æ–º—É —á—Ç–æ —É –Ω–∞—Å –≤—Å–µ—Ö –µ—Å—Ç—å —Å–≤–æ–±–æ–¥–Ω–∞—è –≤–æ–ª—è. –ù–æ —è –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É—é:\n‚Ä¢ –ü–æ–ª–Ω—É—é –æ—Ç–¥–∞—á—É —Å –º–æ–µ–π —Å—Ç–æ—Ä–æ–Ω—ã\n‚Ä¢ –ß–µ—Å—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å–∏—Ç—É–∞—Ü–∏–∏\n‚Ä¢ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏\n‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∫—É –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ\n\n–ò–∑ –æ—Ç–∑—ã–≤–æ–≤: 90% –∫–ª–∏–µ–Ω—Ç–æ–≤ –≥–æ–≤–æ—Ä—è—Ç, —á—Ç–æ –ø–æ–ª—É—á–∏–ª–∏ —è—Å–Ω–æ—Å—Ç—å –∏ –ø–æ–Ω—è–ª–∏, –∫–∞–∫ –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –¥–∞–ª—å—à–µ.",
            "–¢–∞—Ä–æ ‚Äî —ç—Ç–æ –Ω–µ –º–∞–≥–∏—è, –∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∞–Ω–∞–ª–∏–∑–∞. –Ø –ø–æ–º–æ–≥–∞—é —É–≤–∏–¥–µ—Ç—å —Å–∏—Ç—É–∞—Ü–∏—é —Å —Ä–∞–∑–Ω—ã—Ö —Å—Ç–æ—Ä–æ–Ω, –ø–æ–Ω—è—Ç—å —Å–∫—Ä—ã—Ç—ã–µ –º–æ—Ç–∏–≤—ã, –ø—Ä–µ–¥–≤–∏–¥–µ—Ç—å –≤–æ–∑–º–æ–∂–Ω—ã–µ —Ä–∞–∑–≤–∏—Ç–∏—è —Å–æ–±—ã—Ç–∏–π. –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–æ–≥–æ, –∫–∞–∫ –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é. –ú–æ–∏ –∫–ª–∏–µ–Ω—Ç—ã —á–∞—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–µ—Å—è—Ü–µ–≤ —Å –Ω–æ–≤—ã–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏ ‚Äî —ç—Ç–æ –ª—É—á—à–∏–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å.",
            "–Ø —Ä–∞–±–æ—Ç–∞—é —Å –¢–∞—Ä–æ 8 –ª–µ—Ç, –ø—Ä–æ–≤–µ–ª–∞ –±–æ–ª–µ–µ 3000 –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π. –ú–Ω–æ–≥–∏–µ –∫–ª–∏–µ–Ω—Ç—ã –ø—Ä–∏—Ö–æ–¥—è—Ç –ø–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º. –ö–∞—Ä—Ç—ã —Ä–µ–¥–∫–æ –æ—à–∏–±–∞—é—Ç—Å—è, –µ—Å–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç. –•–æ—Ç–∏—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞ —Å–≤–æ–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏?"
        ]
        return random.choice(responses)
    
    # –í–æ–ø—Ä–æ—Å—ã –æ —Å—Ä–æ–∫–∞—Ö
    time_keywords = ['—Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏', '–¥–æ–ª–≥–æ', '–±—ã—Å—Ç—Ä–æ', '—Å—Ä–æ–∫', '–∫–æ–≥–¥–∞', '–∑–∞–¥–µ—Ä–∂–∫–∞']
    if any(keyword in user_message_lower for keyword in time_keywords):
        responses = [
            "–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ä–∞–∑–±–æ—Ä –∑–∞–Ω–∏–º–∞–µ—Ç 10-15 –º–∏–Ω—É—Ç –≤ –ø–µ—Ä–µ–ø–∏—Å–∫–µ. –ü–æ–ª–Ω—ã–π —Ä–∞—Å–∫–ª–∞–¥ —è –æ–±—ã—á–Ω–æ –¥–µ–ª–∞—é –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã, –Ω–æ –µ—Å–ª–∏ —Å–∏—Ç—É–∞—Ü–∏—è —Å—Ä–æ—á–Ω–∞—è ‚Äî –º–æ–≥—É —É–ª–æ–∂–∏—Ç—å—Å—è –≤ 2-3 —á–∞—Å–∞.",
            "–°–µ–≥–æ–¥–Ω—è —è –º–æ–≥—É –≤–∑—è—Ç—å –µ—â–µ 2 –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏. –ï—Å–ª–∏ –æ–ø–ª–∞—Ç–∏—Ç–µ –≤ –±–ª–∏–∂–∞–π—à–∏–µ –ø–∞—Ä—É —á–∞—Å–æ–≤ ‚Äî —Å–¥–µ–ª–∞—é –≤–∞—à —Ä–∞—Å–∫–ª–∞–¥ —Å–µ–≥–æ–¥–Ω—è –≤–µ—á–µ—Ä–æ–º. –ò–Ω–∞—á–µ ‚Äî –∑–∞–≤—Ç—Ä–∞ —É—Ç—Ä–æ–º.",
            "–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –Ω–∞–¥ —Ä–∞—Å–∫–ª–∞–¥–æ–º ‚Äî –æ–∫–æ–ª–æ —á–∞—Å–∞. –ü–ª—é—Å –≤—Ä–µ–º—è –Ω–∞ –Ω–∞—à—É –ø–µ—Ä–µ–ø–∏—Å–∫—É. –û–±—ã—á–Ω–æ –≤—Å–µ —É–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è –≤ –æ–¥–∏–Ω –¥–µ–Ω—å. –í—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –±—ã—Å—Ç—Ä–æ?"
        ]
        return random.choice(responses)
    
    # –û–ø–∞—Å–µ–Ω–∏—è –∏ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è
    objection_keywords = ['–¥–æ—Ä–æ–≥–æ', '–Ω–µ —É–≤–µ—Ä–µ–Ω', '—Å–æ–º–Ω–µ–≤–∞—é—Å—å', '—Å—Ç—Ä–∞—à–Ω–æ', '–±–æ—é—Å—å', '–Ω–µ –≤–µ—Ä—é']
    if any(keyword in user_message_lower for keyword in objection_keywords):
        state['objections'].append(user_message)
        
        if '–¥–æ—Ä–æ–≥' in user_message_lower:
            responses = [
                "–ü–æ–Ω–∏–º–∞—é, —á—Ç–æ 1490 —Ä—É–±. ‚Äî —ç—Ç–æ –¥–µ–Ω—å–≥–∏. –î–∞–≤–∞–π—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–∏–º —Å –¥—Ä—É–≥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã: –æ–¥–Ω–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∂–∏–∑–Ω–µ–Ω–Ω–∞—è —Å–¥–µ–ª–∫–∞ –∏–ª–∏ —É–ø—É—â–µ–Ω–Ω–∞—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –º–æ–≥—É—Ç —Å—Ç–æ–∏—Ç—å –≥–æ—Ä–∞–∑–¥–æ –¥–æ—Ä–æ–∂–µ. –Ø –ø–æ–º–æ–≥–∞—é –∏–∑–±–µ–∂–∞—Ç—å —Ç–∞–∫–∏—Ö –æ—à–∏–±–æ–∫.",
                "–°–æ–≥–ª–∞—Å–Ω–∞, —ç—Ç–æ –Ω–µ –∫–æ–ø–µ–π–∫–∏. –ù–æ –º–æ–∏ –∫–ª–∏–µ–Ω—Ç—ã –≥–æ–≤–æ—Ä—è—Ç, —á—Ç–æ —è—Å–Ω–æ—Å—Ç—å, –∫–æ—Ç–æ—Ä—É—é –æ–Ω–∏ –ø–æ–ª—É—á–∞—é—Ç, —Å—Ç–æ–∏—Ç –Ω–∞–º–Ω–æ–≥–æ –±–æ–ª—å—à–µ. –≠—Ç–æ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è –≤ —Å–≤–æ–µ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è.",
                "–î–∞–≤–∞–π—Ç–µ —Ç–∞–∫: –Ω–∞—á–Ω–µ–º —Å –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ —Ä–∞–∑–±–æ—Ä–∞. –ï—Å–ª–∏ –ø–æ—Å–ª–µ –Ω–µ–≥–æ –≤—ã –ø–æ—á—É–≤—Å—Ç–≤—É–µ—Ç–µ, —á—Ç–æ —è –º–æ–≥—É –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω–∞, —Ç–æ–≥–¥–∞ —Ä–µ—à–∏–º –ø—Ä–æ –æ–ø–ª–∞—Ç—É. –ù–∏–∫–∞–∫–æ–≥–æ –¥–∞–≤–ª–µ–Ω–∏—è, —á–µ—Å—Ç–Ω–æ."
            ]
        elif '–Ω–µ –≤–µ—Ä' in user_message_lower or '—Å–æ–º–Ω–µ–≤' in user_message_lower:
            responses = [
                "–≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ ‚Äî —Å–æ–º–Ω–µ–≤–∞—Ç—å—Å—è. –Ø —Å–∞–º–∞ —Å–Ω–∞—á–∞–ª–∞ –æ—Ç–Ω–æ—Å–∏–ª–∞—Å—å –∫ –¢–∞—Ä–æ —Å–∫–µ–ø—Ç–∏—á–µ—Å–∫–∏. –ù–æ 8 –ª–µ—Ç –ø—Ä–∞–∫—Ç–∏–∫–∏ –ø–æ–∫–∞–∑–∞–ª–∏: –∫–∞—Ä—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç. –•–æ—Ç–∏—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ? –ó–∞–¥–∞–π—Ç–µ –º–Ω–µ –≤–æ–ø—Ä–æ—Å, –∞ —è –∑–∞–≤—Ç—Ä–∞ –ø—Ä–∏—à–ª—é –Ω–∞ –Ω–µ–≥–æ –æ—Ç–≤–µ—Ç –æ—Ç –∫–∞—Ä—Ç. –ù–∏–∫–∞–∫–æ–π –æ–ø–ª–∞—Ç—ã.",
                "–ù–µ –Ω—É–∂–Ω–æ –≤–µ—Ä–∏—Ç—å –≤ –¢–∞—Ä–æ. –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–æ—Å—Ç–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å. –ú–Ω–æ–≥–∏–µ –º–æ–∏ –∫–ª–∏–µ–Ω—Ç—ã –Ω–∞—á–∏–Ω–∞–ª–∏ –∫–∞–∫ —Å–∫–µ–ø—Ç–∏–∫–∏, –∞ —Ç–µ–ø–µ—Ä—å —Ä–µ–≥—É–ª—è—Ä–Ω–æ –æ–±—Ä–∞—â–∞—é—Ç—Å—è. –ö–∞—Ä—Ç—ã –≥–æ–≤–æ—Ä—è—Ç –Ω–∞ —è–∑—ã–∫–µ –º–µ—Ç–∞—Ñ–æ—Ä –∏ —Å–∏–º–≤–æ–ª–æ–≤ ‚Äî —ç—Ç–æ —Å–∫–æ—Ä–µ–µ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—è, —á–µ–º –º–∏—Å—Ç–∏–∫–∞.",
                "–Ø –Ω–µ –ø—Ä–æ—à—É –≤–µ—Ä–∏—Ç—å –Ω–∞ —Å–ª–æ–≤–æ. –î–∞–≤–∞–π—Ç–µ —è –∑–∞–¥–∞–º –≤–∞–º 2-3 –≤–æ–ø—Ä–æ—Å–∞ –æ –≤–∞—à–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏, –∞ –≤—ã –ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ, –Ω–∞—Å–∫–æ–ª—å–∫–æ —Ç–æ—á–Ω—ã–º–∏ –æ–Ω–∏ –±—É–¥—É—Ç. –ë–µ–∑ –æ–ø–ª–∞—Ç—ã, –ø—Ä–æ—Å—Ç–æ –∫–∞–∫ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è."
            ]
        else:
            responses = [
                "–Ø –ø–æ–Ω–∏–º–∞—é –≤–∞—à–∏ —Å–æ–º–Ω–µ–Ω–∏—è. –ù–æ–≤–æ–µ –≤—Å–µ–≥–¥–∞ –Ω–µ–º–Ω–æ–≥–æ —Å—Ç—Ä–∞—à–Ω–æ. –ù–æ —á—Ç–æ, –µ—Å–ª–∏ —ç—Ç–æ –∏–º–µ–Ω–Ω–æ —Ç–æ—Ç —à–∞–≥, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–µ–Ω –≤–∞–º –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å?",
                "–î–∞–≤–∞–π—Ç–µ –¥–≤–∏–≥–∞—Ç—å—Å—è –º–∞–ª–µ–Ω—å–∫–∏–º–∏ —à–∞–≥–∞–º–∏. –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ—Å—Ç–æ —Ä–∞—Å—Å–∫–∞–∂–∏—Ç–µ, —á—Ç–æ –≤–∞—Å –±–µ—Å–ø–æ–∫–æ–∏—Ç. –ù–∏ –∫ —á–µ–º—É –Ω–µ –æ–±—è–∑—ã–≤–∞–µ—Ç.",
                "–Ø –∑–¥–µ—Å—å –Ω–µ —á—Ç–æ–±—ã —É–±–µ–∂–¥–∞—Ç—å. –Ø –∑–¥–µ—Å—å —á—Ç–æ–±—ã –ø–æ–º–æ—á—å, –µ—Å–ª–∏ –ø–æ–º–æ—â—å –Ω—É–∂–Ω–∞. –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç?"
            ]
        return random.choice(responses)
    
    # –°–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é
    agreement_keywords = ['–¥–∞–≤–∞–π', '—Ö–æ—á—É', '–Ω–∞—á–Ω–µ–º', '–≥–æ—Ç–æ–≤', '—Å–æ–≥–ª–∞—Å–µ–Ω', '–æ–∫–µ–π', '–æ–∫', '–¥–∞']
    if any(keyword in user_message_lower for keyword in agreement_keywords) and len(user_message) < 20:
        if state['interest_shown']:
            # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–≥–ª–∞—à–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ–±—Å—É–∂–¥–µ–Ω–∏—è —Ü–µ–Ω—ã
            state['step'] = 'payment'
            responses = [
                "–û—Ç–ª–∏—á–Ω–æ! –¢–æ–≥–¥–∞ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –¥–µ—Ç–∞–ª—è–º. –ù–∞–ø–∏—à–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–∞—à –≤–æ–ø—Ä–æ—Å –∏–ª–∏ —Å–∏—Ç—É–∞—Ü–∏—é, —Å –∫–æ—Ç–æ—Ä–æ–π —Ö–æ—Ç–∏—Ç–µ —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è. –ß–µ–º –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ–ø–∏—à–µ—Ç–µ, —Ç–µ–º —Ç–æ—á–Ω–µ–µ –±—É–¥–µ—Ç —Ä–∞—Å–∫–ª–∞–¥.",
                "–ü—Ä–µ–∫—Ä–∞—Å–Ω–æ! –¢–µ–ø–µ—Ä—å —Ä–∞—Å—Å–∫–∞–∂–∏—Ç–µ –º–Ω–µ –æ —Å–∏—Ç—É–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä—É—é —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ—Ä–∞–±–æ—Ç–∞—Ç—å —Å –ø–æ–º–æ—â—å—é –∫–∞—Ä—Ç. –ú–æ–∂–Ω–æ –≤ —Å–≤–æ–±–æ–¥–Ω–æ–π —Ñ–æ—Ä–º–µ, —è –∑–∞–¥–∞–º —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –µ—Å–ª–∏ –Ω—É–∂–Ω–æ.",
                "–û—Ç–ª–∏—á–Ω–æ, –Ω–∞—á–∏–Ω–∞–µ–º! –û–ø–∏—à–∏—Ç–µ, —á—Ç–æ –≤–∞—Å –±–µ—Å–ø–æ–∫–æ–∏—Ç –∏–ª–∏ —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–Ω—è—Ç—å. –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤–æ–ø—Ä–æ—Å –æ–± –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö, —Ä–∞–±–æ—Ç–µ, –≤—ã–±–æ—Ä–µ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –æ–±—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ."
            ]
        else:
            responses = [
                "–•–æ—Ä–æ—à–æ! –° —á–µ–≥–æ –Ω–∞—á–Ω–µ–º? –ú–æ–∂–µ—Ç, —Ä–∞—Å—Å–∫–∞–∂–µ—Ç–µ, —á—Ç–æ –ø—Ä–∏–≤–µ–ª–æ –≤–∞—Å –∫–æ –º–Ω–µ —Å–µ–≥–æ–¥–Ω—è?",
                "–û—Ç–ª–∏—á–Ω–æ! –¢–æ–≥–¥–∞ –¥–∞–≤–∞–π—Ç–µ –ø–æ–∑–Ω–∞–∫–æ–º–∏–º—Å—è –±–ª–∏–∂–µ. –ß—Ç–æ –≤ –≤–∞—à–µ–π –∂–∏–∑–Ω–∏ —Å–µ–π—á–∞—Å —Ç—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è –∏ —è—Å–Ω–æ—Å—Ç–∏?",
                "–ü—Ä–µ–∫—Ä–∞—Å–Ω–æ! –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ —Å–∏—Ç—É–∞—Ü–∏–∏, —Å –∫–æ—Ç–æ—Ä–æ–π —Ö–æ—Ç–µ–ª–∏ –±—ã –ø–æ—Ä–∞–±–æ—Ç–∞—Ç—å. –ú–æ–∂–Ω–æ –∫—Ä–∞—Ç–∫–æ, –≥–ª–∞–≤–Ω–æ–µ ‚Äî —Å—É—Ç—å."
            ]
        return random.choice(responses)
    
    # –ï—Å–ª–∏ –ø—Ä–∏—Å–ª–∞–ª–∏ –≤–æ–ø—Ä–æ—Å/—Å–∏—Ç—É–∞—Ü–∏—é –¥–ª–∏–Ω–Ω–µ–µ 10 —Å–∏–º–≤–æ–ª–æ–≤
    if len(user_message) > 10 and step != 'payment':
        state['step'] = 'discussion'
        state['question'] = user_message
        state['interest_shown'] = True
        
        responses = [
            f"–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –ø–æ–¥–µ–ª–∏–ª–∏—Å—å. –Ø –ø—Ä–æ—á–∏—Ç–∞–ª–∞ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ. {random.choice(['–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≤–∞–∂–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è.', '–ü–æ–Ω–∏–º–∞—é, –ø–æ—á–µ–º—É —ç—Ç–æ –≤–∞—Å –±–µ—Å–ø–æ–∫–æ–∏—Ç.', '–í–∏–∂—É –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞—Å–ø–µ–∫—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —Å—Ç–æ–∏—Ç –ø—Ä–æ—Ä–∞–±–æ—Ç–∞—Ç—å.'])}\n\n–ì–æ—Ç–æ–≤—ã –æ–±—Å—É–¥–∏—Ç—å, –∫–∞–∫ –º—ã –º–æ–∂–µ–º —Å —ç—Ç–∏–º –ø–æ—Ä–∞–±–æ—Ç–∞—Ç—å?",
            f"–ü–æ–Ω—è–ª–∞ –≤–∞—à—É —Å–∏—Ç—É–∞—Ü–∏—é. {random.choice(['–ï—Å—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –Ω—é–∞–Ω—Å—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.', '–ö–∞—Ä—Ç—ã —Ç–æ—á–Ω–æ —Å–º–æ–≥—É—Ç –¥–∞—Ç—å —è—Å–Ω–æ—Å—Ç—å –∑–¥–µ—Å—å.', '–≠—Ç–æ —Ö–æ—Ä–æ—à–∏–π –≤–æ–ø—Ä–æ—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¢–∞—Ä–æ.'])}\n\n–•–æ—Ç–∏—Ç–µ, —á—Ç–æ–±—ã —è —Å–¥–µ–ª–∞–ª–∞ –¥–ª—è –≤–∞—Å –ø–æ–ª–Ω—ã–π —Ä–∞—Å–∫–ª–∞–¥? –û–±—ã—á–Ω–æ —è –±–µ—Ä—É –∑–∞ –Ω–µ–≥–æ 1490 —Ä—É–±., –Ω–æ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ —Ä–∞–∑–∞ –º–æ–≥—É —Å–¥–µ–ª–∞—Ç—å –∑–∞ 1290.",
            f"–°–ø–∞—Å–∏–±–æ –∑–∞ –¥–æ–≤–µ—Ä–∏–µ. {random.choice(['–°–∏—Ç—É–∞—Ü–∏—è –º–Ω–æ–≥–æ–≥—Ä–∞–Ω–Ω–∞—è, —Å—Ç–æ–∏—Ç —Ä–∞–∑–æ–±—Ä–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω–æ.', '–ß—É–≤—Å—Ç–≤—É—é, —á—Ç–æ –∫–∞—Ä—Ç—ã –¥–∞–¥—É—Ç –ø–æ–ª–µ–∑–Ω—ã–µ –∏–Ω—Å–∞–π—Ç—ã.', '–≠—Ç–æ –∫–∞–∫ —Ä–∞–∑ —Ç–æ—Ç —Å–ª—É—á–∞–π, –∫–æ–≥–¥–∞ –¢–∞—Ä–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –ª—É—á—à–µ –≤—Å–µ–≥–æ.'])}\n\n–Ø –≥–æ—Ç–æ–≤–∞ –≤–∑—è—Ç—å—Å—è –∑–∞ –≤–∞—à —Ä–∞—Å–∫–ª–∞–¥. –°—Ç–æ–∏–º–æ—Å—Ç—å ‚Äî 1490 —Ä—É–±. –î–µ–ª–∞–µ–º?"
        ]
        return random.choice(responses)
    
    # –ï—Å–ª–∏ –Ω–∞ —ç—Ç–∞–ø–µ –æ–±—Å—É–∂–¥–µ–Ω–∏—è –∏ –ø—Ä–∏—Å–ª–∞–ª–∏ —á—Ç–æ-—Ç–æ –æ—Å–º—ã—Å–ª–µ–Ω–Ω–æ–µ
    if step == 'discussion' and len(user_message) > 3:
        responses = [
            "–ü–æ–Ω–∏–º–∞—é. –î–∞–≤–∞–π—Ç–µ –ø–µ—Ä–µ–π–¥–µ–º –∫ —Ä–µ—à–µ–Ω–∏—é. –•–æ—Ç–∏—Ç–µ, —á—Ç–æ–±—ã —è —Å–¥–µ–ª–∞–ª–∞ –¥–ª—è –≤–∞—Å —Ä–∞—Å–∫–ª–∞–¥?",
            "–Ø—Å–Ω–æ. –ì–æ—Ç–æ–≤—ã –¥–≤–∏–≥–∞—Ç—å—Å—è –¥–∞–ª—å—à–µ –∏ –ø—Ä–æ—Ä–∞–±–æ—Ç–∞—Ç—å —ç—Ç–æ —Å –ø–æ–º–æ—â—å—é –∫–∞—Ä—Ç?",
            "–ü–æ–Ω—è–ª–∞. –¢–æ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞—é –ø–µ—Ä–µ–π—Ç–∏ –∫ —Ä–∞—Å–∫–ª–∞–¥—É. –ö–∞–∫ –≤–∞–º?"
        ]
        return random.choice(responses)
    
    # –ï—Å–ª–∏ –Ω–∞ —ç—Ç–∞–ø–µ –æ–ø–ª–∞—Ç—ã
    if step == 'payment':
        # –°—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É
        payment_url = "https://yoomoney.ru/to/4100111234567890"  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—É—é
        responses = [
            f"–û—Ç–ª–∏—á–Ω–æ, –≤–æ–ø—Ä–æ—Å —è—Å–µ–Ω. –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ –¥–ª—è –æ–ø–ª–∞—Ç—ã: {payment_url}\n\n–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –ø—Ä–∏—à–ª–∏—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ ¬´–æ–ø–ª–∞—Ç–∏–ª(–∞)¬ª ‚Äî –∏ —è —Å—Ä–∞–∑—É –Ω–∞—á–Ω—É —Ä–∞–±–æ—Ç—É –Ω–∞–¥ –≤–∞—à–∏–º —Ä–∞—Å–∫–ª–∞–¥–æ–º.",
            f"–ü—Ä–µ–∫—Ä–∞—Å–Ω–æ! –í–æ—Ç —Å—Å—ã–ª–∫–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã: {payment_url}\n\n–ö–∞–∫ —Ç–æ–ª—å–∫–æ –æ–ø–ª–∞—Ç–∞ –ø—Ä–æ–π–¥–µ—Ç, –ø—Ä–∏—à–ª–∏—Ç–µ –º–Ω–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Äî –∏ –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω—ã–π —Ä–∞—Å–∫–ª–∞–¥ —Å –∞–Ω–∞–ª–∏–∑–æ–º.",
            f"–•–æ—Ä–æ—à–æ, –Ω–∞—á–∏–Ω–∞–µ–º! –û–ø–ª–∞—Ç–∏—Ç—å –º–æ–∂–Ω–æ –∑–¥–µ—Å—å: {payment_url}\n\n–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –¥–∞–π—Ç–µ –º–Ω–µ –∑–Ω–∞—Ç—å ‚Äî –æ–±—ã—á–Ω–æ —è –¥–µ–ª–∞—é —Ä–∞—Å–∫–ª–∞–¥—ã –≤–µ—á–µ—Ä–æ–º, —Ç–∞–∫ —á—Ç–æ –º–æ–∂–µ—Ç–µ –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç —É–∂–µ —Å–µ–≥–æ–¥–Ω—è."
        ]
        return random.choice(responses)
    
    # –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ–ø–ª–∞—Ç–µ
    if '–æ–ø–ª–∞—Ç' in user_message_lower or '–ø–µ—Ä–µ–≤–µ–ª' in user_message_lower or '—Å–∫–∏–Ω—å' in user_message_lower:
        payment_url = "https://yoomoney.ru/to/4100111234567890"
        return f"–ö–æ–Ω–µ—á–Ω–æ! –í–æ—Ç —Å—Å—ã–ª–∫–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã: {payment_url}\n\n–°—É–º–º–∞: 1490 —Ä—É–±. (–∏–ª–∏ 1290 —Ä—É–±. –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ —Ä–∞–∑–∞)\n\n–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ –º–Ω–µ ‚Äî –∏ —è –ø—Ä–∏—Å—Ç—É–ø–ª—é –∫ —Ä–∞–±–æ—Ç–µ."
    
    # –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    if '–∫–æ–Ω—Ç–∞–∫—Ç' in user_message_lower or '—Ç–µ–ª–µ—Ñ–æ–Ω' in user_message_lower or '—Å–≤—è–∑–∞—Ç—å—Å—è' in user_message_lower:
        return "–ú–æ–π Telegram: @annatarolog (—ç—Ç–æ—Ç –±–æ—Ç)\n–î–ª—è —Å—Ä–æ—á–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –º–æ–∂–µ—Ç–µ –ø–∏—Å–∞—Ç—å —Å—é–¥–∞, —è –æ–±—ã—á–Ω–æ –æ—Ç–≤–µ—á–∞—é –≤ —Ç–µ—á–µ–Ω–∏–µ —á–∞—Å–∞.\n\n–ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞—é —Ä–∞–±–æ—Ç–∞—Ç—å —á–µ—Ä–µ–∑ –±–æ—Ç–∞ ‚Äî —Ç–∞–∫ –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ —Ä–∞—Å–∫–ª–∞–¥—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ."
    
    # –û—Ç–∑—ã–≤—ã
    if '–æ—Ç–∑—ã–≤' in user_message_lower or '—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü' in user_message_lower:
        return "–û—Ç–∑—ã–≤—ã –∫–ª–∏–µ–Ω—Ç–æ–≤:\n\n¬´–ê–Ω–Ω–∞ –ø–æ–º–æ–≥–ª–∞ —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –≤ —Å–ª–æ–∂–Ω–æ–π —Ä–∞–±–æ—á–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏. –ï–µ —Ä–∞—Å–∫–ª–∞–¥ –ø–æ–∫–∞–∑–∞–ª —Ç–æ, —á—Ç–æ —è –Ω–µ –∑–∞–º–µ—á–∞–ª. –°–ø–∞—Å–∏–±–æ!¬ª ‚Äî –ú–∏—Ö–∞–∏–ª\n\n¬´–û–±—Ä–∞—â–∞–ª–∞—Å—å –ø–æ –≤–æ–ø—Ä–æ—Å—É –æ—Ç–Ω–æ—à–µ–Ω–∏–π. –ö–∞—Ä—Ç—ã –¥–∞–ª–∏ —è—Å–Ω–æ—Å—Ç—å, —Ç–µ–ø–µ—Ä—å –∑–Ω–∞—é, –∫–∞–∫ –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å. –†–µ–∫–æ–º–µ–Ω–¥—É—é!¬ª ‚Äî –û–ª—å–≥–∞\n\n¬´–ë—ã–ª–∞ –≤ —Ç—É–ø–∏–∫–µ, –Ω–µ –∑–Ω–∞–ª–∞, –∫—É–¥–∞ –¥–≤–∏–≥–∞—Ç—å—Å—è. –ü–æ—Å–ª–µ —Ä–∞—Å–∫–ª–∞–¥–∞ —Å –ê–Ω–Ω–æ–π –ø–æ—è–≤–∏–ª—Å—è —á–µ—Ç–∫–∏–π –ø–ª–∞–Ω. –°–ø–∞—Å–∏–±–æ!¬ª ‚Äî –ï–ª–µ–Ω–∞"
    
    # –ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏
    if '—Å–ø–∞—Å–∏–±–æ' in user_message_lower or '–±–ª–∞–≥–æ–¥–∞—Ä' in user_message_lower:
        return "–í—Å–µ–≥–¥–∞ —Ä–∞–¥–∞ –ø–æ–º–æ—á—å! üôè –ï—Å–ª–∏ –ø–æ—è–≤—è—Ç—Å—è –Ω–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã ‚Äî –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å. –•–æ—Ä–æ—à–µ–≥–æ –¥–Ω—è!"
    
    # –ü—Ä–æ—â–∞–Ω–∏—è
    if '–ø–æ–∫–∞' in user_message_lower or '–¥–æ —Å–≤–∏–¥–∞–Ω' in user_message_lower or '–ø—Ä–æ—â–∞–π' in user_message_lower:
        return "–î–æ —Å–≤–∏–¥–∞–Ω–∏—è! –ë—É–¥—É —Ä–∞–¥–∞ –ø–æ–º–æ—á—å, –µ—Å–ª–∏ —Å–Ω–æ–≤–∞ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è —Å–æ–≤–µ—Ç –∫–∞—Ä—Ç. –ë–µ—Ä–µ–≥–∏—Ç–µ —Å–µ–±—è! üí´"
    
    # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –¥–ª—è –Ω–µ–ø–æ–Ω—è—Ç–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    if state['message_count'] < 3:
        responses = [
            "–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —á—Ç–æ –≤–∞—Å –ø—Ä–∏–≤–µ–ª–æ –∫–æ –º–Ω–µ —Å–µ–≥–æ–¥–Ω—è? –ï—Å—Ç—å –ª–∏ —Å–∏—Ç—É–∞—Ü–∏—è, –≤ –∫–æ—Ç–æ—Ä–æ–π –Ω—É–∂–Ω–∞ —è—Å–Ω–æ—Å—Ç—å?",
            "–ß–µ–º —è –º–æ–≥—É –≤–∞–º –ø–æ–º–æ—á—å? –ú–æ–∂–µ—Ç, –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π —Ö–æ—Ç–µ–ª–∏ –±—ã –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç –∫–∞—Ä—Ç?",
            "–ß—Ç–æ –≤ –≤–∞—à–µ–π –∂–∏–∑–Ω–∏ —Å–µ–π—á–∞—Å —Ç—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è –∏ –ø–æ–Ω–∏–º–∞–Ω–∏—è?"
        ]
    elif state['interest_shown']:
        responses = [
            "–ì–æ—Ç–æ–≤—ã –ø–µ—Ä–µ–π—Ç–∏ –∫ —Ä–∞—Å–∫–ª–∞–¥—É? –°—Ç–æ–∏–º–æ—Å—Ç—å ‚Äî 1490 —Ä—É–±., –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ —Ä–∞–∑–∞ –º–æ–≥—É —Å–¥–µ–ª–∞—Ç—å –∑–∞ 1290.",
            "–•–æ—Ç–∏—Ç–µ, —á—Ç–æ–±—ã —è –ø–æ—Ä–∞–±–æ—Ç–∞–ª–∞ —Å –≤–∞—à–µ–π —Å–∏—Ç—É–∞—Ü–∏–µ–π? –û–±—ã—á–Ω–æ —è –±–µ—Ä—É 1490 —Ä—É–±. –∑–∞ –ø–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑.",
            "–î–µ–ª–∞–µ–º —Ä–∞—Å–∫–ª–∞–¥? –°—Ç–æ–∏–º–æ—Å—Ç—å ‚Äî 1490 —Ä—É–±., –Ω–æ –µ—Å–ª–∏ —Ä–µ—à–∏—Ç–µ—Å—å —Å–µ–π—á–∞—Å ‚Äî 1290 —Ä—É–±."
        ]
    else:
        responses = [
            "–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —Å–æ–≤—Å–µ–º –ø–æ–Ω—è–ª–∞. –ú–æ–∂–µ—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å?",
            "–ù–µ —É–≤–µ—Ä–µ–Ω–∞, —á—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–Ω—è–ª–∞. –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥—Ä–æ–±–Ω–µ–µ?",
            "–î–∞–≤–∞–π—Ç–µ –Ω–∞—á–Ω–µ–º —Å –Ω–∞—á–∞–ª–∞. –ß—Ç–æ –ø—Ä–∏–≤–µ–ª–æ –≤–∞—Å –∫–æ –º–Ω–µ —Å–µ–≥–æ–¥–Ω—è?"
        ]
    
    return random.choice(responses)

def simulate_tarot_reading(question, user_name):
    """–°–∏–º—É–ª—è—Ü–∏—è —Ä–∞—Å–∫–ª–∞–¥–∞ –¢–∞—Ä–æ (–≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –Ω–∞—Å—Ç–æ—è—â–∞—è —Ä–∞–±–æ—Ç–∞)"""
    cards = [
        "üÉè –®—É—Ç ‚Äî –Ω–æ–≤—ã–µ –Ω–∞—á–∏–Ω–∞–Ω–∏—è",
        "üßô –ú–∞–≥ ‚Äî –ø—Ä–æ—è–≤–ª–µ–Ω–∏–µ –≤–æ–ª–∏", 
        "üëë –ò–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞ ‚Äî –∏–∑–æ–±–∏–ª–∏–µ",
        "üíë –í–ª—é–±–ª–µ–Ω–Ω—ã–µ ‚Äî –≤—ã–±–æ—Ä",
        "üé° –ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã ‚Äî –ø–µ—Ä–µ–º–µ–Ω—ã"
    ]
    
    selected = random.sample(cards, 3)
    
    reading = f"""üîÆ *–í–ê–® –†–ê–°–ö–õ–ê–î –¢–ê–†–û*

*–í–æ–ø—Ä–æ—Å:* {question}

*–ö–∞—Ä—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–ø–∞–ª–∏:*
1. {selected[0]}
2. {selected[1]}
3. {selected[2]}

*–ê–Ω–∞–ª–∏–∑ —Å–∏—Ç—É–∞—Ü–∏–∏:*
{random.choice([
    "–ö–∞—Ä—Ç—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç, —á—Ç–æ —Å–∏—Ç—É–∞—Ü–∏—è –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è. –í–∞–∂–Ω–æ –Ω–µ —Ç–æ—Ä–æ–ø–∏—Ç—å —Å–æ–±—ã—Ç–∏—è, –Ω–æ –∏ –Ω–µ —É–ø—É—Å–∫–∞—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏, –∫–æ—Ç–æ—Ä—ã–µ —Å–∫–æ—Ä–æ –ø–æ—è–≤—è—Ç—Å—è.",
    "–í–∏–∂—É –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞—Å–ø–µ–∫—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —Ç—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è. –ì–ª–∞–≤–Ω—ã–π ‚Äî —ç—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å —Å–¥–µ–ª–∞—Ç—å –≤—ã–±–æ—Ä, –æ—Ç –∫–æ—Ç–æ—Ä–æ–≥–æ –º–Ω–æ–≥–æ–µ –∑–∞–≤–∏—Å–∏—Ç.",
    "–≠–Ω–µ—Ä–≥–∏—è —Å–∏—Ç—É–∞—Ü–∏–∏ –ø–µ—Ä–µ—Ö–æ–¥–Ω–∞—è. –¢–æ, —á—Ç–æ –±—ã–ª–æ –∞–∫—Ç—É–∞–ª—å–Ω–æ –≤—á–µ—Ä–∞, –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å—Å—è —É–∂–µ –∑–∞–≤—Ç—Ä–∞. –í–∞—à–∞ –≥–∏–±–∫–æ—Å—Ç—å —Å–µ–π—á–∞—Å ‚Äî –∫–ª—é—á–µ–≤–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ."
])}

*–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:*
‚Ä¢ {random.choice(["–í –±–ª–∏–∂–∞–π—à–∏–µ 3 –¥–Ω—è –æ–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –∑–Ω–∞–∫–∏", "–ü—Ä–æ—è–≤–∏—Ç–µ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É –≤ –æ–±—â–µ–Ω–∏–∏", "–û—Ç–ª–æ–∂–∏—Ç–µ –≤–∞–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –¥–æ —Å–ª–µ–¥—É—é—â–µ–π –Ω–µ–¥–µ–ª–∏"])}
‚Ä¢ {random.choice(["–°—Ñ–æ–∫—É—Å–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ –æ–¥–Ω–æ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏", "–î–∞–π—Ç–µ —Å–µ–±–µ –≤—Ä–µ–º—è –Ω–∞ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏–µ", "–ü—Ä–æ–∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä—É–π—Ç–µ—Å—å —Å –±–ª–∏–∑–∫–∏–º —á–µ–ª–æ–≤–µ–∫–æ–º"])}
‚Ä¢ {random.choice(["–ó–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ–∏ –º—ã—Å–ª–∏ –∏ –æ—â—É—â–µ–Ω–∏—è", "–ü—Ä–æ–≤–µ–¥–∏—Ç–µ –Ω–µ–±–æ–ª—å—à–æ–π —Ä–∏—Ç—É–∞–ª –æ—Ç–ø—É—Å–∫–∞–Ω–∏—è", "–ü–æ—Å—Ç–∞–≤—å—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ü–µ–ª—å –Ω–∞ –º–µ—Å—è—Ü"])}

*–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è:*
{random.choice([
    "–í —Ç–µ—á–µ–Ω–∏–µ –Ω–µ–¥–µ–ª–∏ –ø—Ä–æ—è—Å–Ω–∏—Ç—Å—è –æ–¥–∏–Ω –≤–∞–∂–Ω—ã–π –≤–æ–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π —Å–µ–π—á–∞—Å –∫–∞–∂–µ—Ç—Å—è —Ç—É–º–∞–Ω–Ω—ã–º.",
    "–í–æ–∑–º–æ–∂–Ω–∞ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –≤—Å—Ç—Ä–µ—á–∞ –∏–ª–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä, –∫–æ—Ç–æ—Ä—ã–π –∏–∑–º–µ–Ω–∏—Ç –≤–∞—à—É –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—É.",
    "–°–∏—Ç—É–∞—Ü–∏—è —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –∫ –∫–æ–Ω—Ü—É –º–µ—Å—è—Ü–∞, –µ—Å–ª–∏ –≤—ã –±—É–¥–µ—Ç–µ –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ."
])}

üí´ *–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –¥–æ–≤–µ—Ä–∏–ª–∏ –º–Ω–µ —Å–≤–æ—é —Å–∏—Ç—É–∞—Ü–∏—é!*

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –≤–æ–ø—Ä–æ—Å—ã –ø–æ —Ä–∞—Å–∫–ª–∞–¥—É ‚Äî –ø–∏—à–∏—Ç–µ, –æ–±—Å—É–¥–∏–º.

–° —Ç–µ–ø–ª–æ–º,
–ê–Ω–Ω–∞ üåô"""
    
    return reading

@app.route('/webhook', methods=['POST'])
def webhook():
    """–û—Å–Ω–æ–≤–Ω–æ–π webhook –æ—Ç Telegram"""
    try:
        data = request.get_json()
        logger.info("üì• –ü–æ–ª—É—á–µ–Ω webhook")
        
        if not data:
            return jsonify({"status": "error", "message": "No data"}), 400
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
        if 'message' in data and 'text' in data['message']:
            message_text = data['message']['text'].strip()
            chat_id = data['message']['chat']['id']
            user_name = data['message']['from'].get('first_name', '–¥—Ä—É–≥')
            
            logger.info(f"üë§ {user_name}: {message_text}")
            
            # –ü–æ–ª—É—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞
            state = get_conversation_state(chat_id)
            
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start
            if message_text.lower().startswith('/start'):
                update_conversation_state(chat_id, {'step': 'start', 'message_count': 0})
                response_text = f"""–ü—Ä–∏–≤–µ—Ç! üëã –Ø –ê–Ω–Ω–∞, –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ç–∞—Ä–æ–ª–æ–≥. 

8 –ª–µ—Ç –ø–æ–º–æ–≥–∞—é –ª—é–¥—è–º –Ω–∞—Ö–æ–¥–∏—Ç—å —è—Å–Ω–æ—Å—Ç—å –≤ —Å–ª–æ–∂–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö —Å –ø–æ–º–æ—â—å—é –∫–∞—Ä—Ç –¢–∞—Ä–æ.

–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ, —á—Ç–æ –≤–∞—Å –ø—Ä–∏–≤–µ–ª–æ –∫–æ –º–Ω–µ —Å–µ–≥–æ–¥–Ω—è? –ú–æ–∂–µ—Ç, –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å –∏–ª–∏ —Å–∏—Ç—É–∞—Ü–∏—è, –≤ –∫–æ—Ç–æ—Ä–æ–π –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å?"""
                
                send_message(chat_id, response_text)
            
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±—ã—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            else:
                # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–π –æ—Ç–≤–µ—Ç
                response_text = generate_human_response(message_text, state)
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
                send_message(chat_id, response_text)
                
                # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                update_conversation_state(chat_id, {})
                
                # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "–æ–ø–ª–∞—Ç–∏–ª" - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–∞—Å–∫–ª–∞–¥
                if '–æ–ø–ª–∞—Ç' in message_text.lower() and ('—Å–¥–µ–ª' in message_text.lower() or '–ø–µ—Ä–µ–≤–µ' in message_text.lower()):
                    time.sleep(2)
                    
                    # –ë–µ—Ä–µ–º –≤–æ–ø—Ä–æ—Å –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    question = state.get('question', message_text)
                    if not question or len(question) < 10:
                        question = "–æ–±—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è –≤ –∂–∏–∑–Ω–∏"
                    
                    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ —Ä–∞–±–æ—Ç—ã
                    send_message(chat_id, "–û—Ç–ª–∏—á–Ω–æ, –≤–∏–∂—É –æ–ø–ª–∞—Ç—É! ‚ú®\n\n–ü—Ä–∏—Å—Ç—É–ø–∞—é –∫ —Ä–∞–±–æ—Ç–µ –Ω–∞–¥ –≤–∞—à–∏–º —Ä–∞—Å–∫–ª–∞–¥–æ–º. –≠—Ç–æ –∑–∞–π–º–µ—Ç –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è...")
                    
                    # –°–∏–º—É–ª–∏—Ä—É–µ–º —Ä–∞–±–æ—Ç—É
                    time.sleep(3)
                    send_message(chat_id, "üé¥ –í—ã–±–∏—Ä–∞—é –∫–∞—Ä—Ç—ã...")
                    time.sleep(2)
                    send_message(chat_id, "üîç –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Å–≤—è–∑–∏ –º–µ–∂–¥—É –∫–∞—Ä—Ç–∞–º–∏...")
                    time.sleep(3)
                    
                    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∞–º —Ä–∞—Å–∫–ª–∞–¥
                    reading = simulate_tarot_reading(question, user_name)
                    send_message(chat_id, reading)
                    
                    # –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    time.sleep(1)
                    send_message(chat_id, "–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –¥–æ–≤–µ—Ä–∏–ª–∏ –º–Ω–µ —Å–≤–æ—é —Å–∏—Ç—É–∞—Ü–∏—é! –ï—Å–ª–∏ –±—É–¥—É—Ç –≤–æ–ø—Ä–æ—Å—ã ‚Äî –ø–∏—à–∏—Ç–µ. üôè\n\n–•–æ—Ä–æ—à–µ–≥–æ –¥–Ω—è!")
                    
                    # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥
                    if chat_id in conversations:
                        del conversations[chat_id]
            
            return jsonify({"status": "success", "processed": True}), 200
        
        return jsonify({"status": "success", "processed": False}), 200
        
    except Exception as e:
        logger.error(f"üö® –û—à–∏–±–∫–∞ –≤ webhook: {e}")
        return jsonify({"status": "error", "message": str(e)}), 400

@app.route('/set_webhook', methods=['GET'])
def set_webhook():
    """–£—Å—Ç–∞–Ω–æ–≤–∫–∞ webhook"""
    try:
        if not BOT_TOKEN:
            return jsonify({"error": "BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"}), 400
        
        webhook_url = request.host_url.rstrip('/') + '/webhook'
        logger.info(f"üîó –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é webhook: {webhook_url}")
        
        telegram_url = f"https://api.telegram.org/bot{BOT_TOKEN}/setWebhook"
        response = requests.post(telegram_url, json={'url': webhook_url}, timeout=10)
        
        return jsonify({
            "success": response.status_code == 200,
            "webhook_url": webhook_url,
            "response": response.json() if response.status_code == 200 else response.text
        }), 200
        
    except Exception as e:
        logger.error(f"üö® –û—à–∏–±–∫–∞: {e}")
        return jsonify({"error": str(e)}), 400

@app.route('/')
def home():
    return jsonify({
        "status": "active",
        "bot": "@Tarotyour_bot",
        "description": "–ß–µ–ª–æ–≤–µ–∫–æ-–ø–æ–¥–æ–±–Ω—ã–π –±–æ—Ç-—Ç–∞—Ä–æ–ª–æ–≥ —Å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –¥–∏–∞–ª–æ–≥–æ–º",
        "persona": "–ê–Ω–Ω–∞, —Ç–∞—Ä–æ–ª–æ–≥ —Å 8-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º",
        "price": "1490 —Ä—É–±. (1290 —Ä—É–±. –¥–ª—è –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤)",
        "note": "–¢–æ–ª—å–∫–æ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –ø–µ—Ä–µ–ø–∏—Å–∫–∞, –±–µ–∑ –∫–Ω–æ–ø–æ–∫"
    })

if __name__ == '__main__':
    port = int(os.environ.get('PORT', 10000))
    logger.info(f"üöÄ –ó–ê–ü–£–°–ö –ß–ï–õ–û–í–ï–ö–û-–ü–û–î–û–ë–ù–û–ì–û –ë–û–¢–ê –ù–ê –ü–û–†–¢–£ {port}")
    logger.info(f"üë§ –ü–µ—Ä—Å–æ–Ω–∞: –ê–Ω–Ω–∞, —Ç–∞—Ä–æ–ª–æ–≥ —Å 8-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º")
    logger.info(f"üí∞ –¶–µ–Ω–∞: 1490 —Ä—É–±. (1290 —Ä—É–±. –¥–ª—è –Ω–æ–≤—ã—Ö)")
    app.run(host='0.0.0.0', port=port, debug=False)

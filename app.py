from flask import Flask, request, jsonify
import os
import requests
import logging
import random
import time
from datetime import datetime

app = Flask(__name__)
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(name)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
BOT_TOKEN = os.environ.get('BOT_TOKEN')
if not BOT_TOKEN:
    logger.error("‚ùå BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")
    raise ValueError("BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è!")

# –¶–µ–Ω—ã –∏ –ø—Ä–æ–¥—É–∫—Ç—ã
PRODUCTS = {
    "basic": {
        "name": "üîÆ –ë–∞–∑–æ–≤—ã–π —Ä–∞—Å–∫–ª–∞–¥ (3 –∫–∞—Ä—Ç—ã)",
        "price": 299,
        "description": "–û—Ç–≤–µ—Ç –Ω–∞ –æ–¥–∏–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å",
        "cards_count": 3
    },
    "advanced": {
        "name": "‚ú® –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ä–∞—Å–∫–ª–∞–¥ (7 –∫–∞—Ä—Ç)",
        "price": 799,
        "description": "–ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å–∏—Ç—É–∞—Ü–∏–∏ —Å —Å–æ–≤–µ—Ç–∞–º–∏",
        "cards_count": 7
    },
    "full": {
        "name": "üí´ –ü–æ–ª–Ω—ã–π —Ä–∞—Å–∫–ª–∞–¥ (12 –∫–∞—Ä—Ç)",
        "price": 1499,
        "description": "–ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ + –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –º–µ—Å—è—Ü",
        "cards_count": 12
    }
}

# –ü–æ–ª–Ω–∞—è –∫–æ–ª–æ–¥–∞ –¢–∞—Ä–æ (78 –∫–∞—Ä—Ç)
MAJOR_ARCANA = [
    {"name": "üÉè 0. –®—É—Ç", "meaning": "–ù–∞—á–∞–ª–æ, –Ω–µ–≤–∏–Ω–Ω–æ—Å—Ç—å, —Å–≤–æ–±–æ–¥–∞, —Ä–∏—Å–∫", 
     "advice": "–î–æ–≤–µ—Ä—å—Ç–µ—Å—å –∏–Ω—Ç—É–∏—Ü–∏–∏ –∏ –±—É–¥—å—Ç–µ –æ—Ç–∫—Ä—ã—Ç—ã –Ω–æ–≤–æ–º—É"},
    {"name": "üßô I. –ú–∞–≥", "meaning": "–í–æ–ª—è, –º–∞—Å—Ç–µ—Ä—Å—Ç–≤–æ, –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è, –¥–µ–π—Å—Ç–≤–∏–µ",
     "advice": "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤—Å–µ —Ä–µ—Å—É—Ä—Å—ã –∏ –ø—Ä–æ—è–≤–∏—Ç–µ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É"},
    {"name": "üëë II. –í–µ—Ä—Ö–æ–≤–Ω–∞—è –ñ—Ä–∏—Ü–∞", "meaning": "–ò–Ω—Ç—É–∏—Ü–∏—è, —Ç–∞–π–Ω—ã, –º—É–¥—Ä–æ—Å—Ç—å, –ø–æ–¥—Å–æ–∑–Ω–∞–Ω–∏–µ",
     "advice": "–ü—Ä–∏—Å–ª—É—à–∞–π—Ç–µ—Å—å –∫ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º—É –≥–æ–ª–æ—Å—É"},
    {"name": "üëë III. –ò–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞", "meaning": "–ò–∑–æ–±–∏–ª–∏–µ, —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ, –ø—Ä–∏—Ä–æ–¥–∞, –ø–ª–æ–¥–æ—Ä–æ–¥–∏–µ",
     "advice": "–ü—Ä–æ—è–≤–ª—è–π—Ç–µ –∑–∞–±–æ—Ç—É –∏ –±—É–¥—å—Ç–µ –ø–ª–æ–¥–æ—Ç–≤–æ—Ä–Ω—ã"},
    {"name": "üèõÔ∏è IV. –ò–º–ø–µ—Ä–∞—Ç–æ—Ä", "meaning": "–°—Ç—Ä—É–∫—Ç—É—Ä–∞, –≤–ª–∞—Å—Ç—å, —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å, –∫–æ–Ω—Ç—Ä–æ–ª—å",
     "advice": "–ü—Ä–æ—è–≤–∏—Ç–µ –ª–∏–¥–µ—Ä—Å—Ç–≤–æ –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–æ—Ä—è–¥–æ–∫"},
    {"name": "üôè V. –ò–µ—Ä–æ—Ñ–∞–Ω—Ç", "meaning": "–¢—Ä–∞–¥–∏—Ü–∏–∏, –¥—É—Ö–æ–≤–Ω–æ—Å—Ç—å, –≤–µ—Ä–∞, –æ–±—É—á–µ–Ω–∏–µ",
     "advice": "–ò—â–∏—Ç–µ –º—É–¥—Ä–æ—Å—Ç—å –≤ —Ç—Ä–∞–¥–∏—Ü–∏—è—Ö –∏ –∑–Ω–∞–Ω–∏—è—Ö"},
    {"name": "üíë VI. –í–ª—é–±–ª–µ–Ω–Ω—ã–µ", "meaning": "–í—ã–±–æ—Ä, –æ—Ç–Ω–æ—à–µ–Ω–∏—è, –≥–∞—Ä–º–æ–Ω–∏—è, —Ü–µ–Ω–Ω–æ—Å—Ç–∏",
     "advice": "–ü—Ä–∏–Ω–∏–º–∞–π—Ç–µ —Ä–µ—à–µ–Ω–∏—è —Å–µ—Ä–¥—Ü–µ–º, –Ω–æ —Å —É–º–æ–º"},
    {"name": "‚õµ VII. –ö–æ–ª–µ—Å–Ω–∏—Ü–∞", "meaning": "–ü–æ–±–µ–¥–∞, –∫–æ–Ω—Ç—Ä–æ–ª—å, –¥–≤–∏–∂–µ–Ω–∏–µ, –≤–æ–ª—è",
     "advice": "–î–≤–∏–≥–∞–π—Ç–µ—Å—å –≤–ø–µ—Ä–µ–¥ —Å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å—é"},
    {"name": "üí™ VIII. –°–∏–ª–∞", "meaning": "–•—Ä–∞–±—Ä–æ—Å—Ç—å, —Å–æ—Å—Ç—Ä–∞–¥–∞–Ω–∏–µ, –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Å–∏–ª–∞",
     "advice": "–ü—Ä–æ—è–≤–∏—Ç–µ –º—è–≥–∫—É—é —Å–∏–ª—É –∏ —Ç–µ—Ä–ø–µ–Ω–∏–µ"},
    {"name": "üßò IX. –û—Ç—à–µ–ª—å–Ω–∏–∫", "meaning": "–°–∞–º–æ–∞–Ω–∞–ª–∏–∑, —É–µ–¥–∏–Ω–µ–Ω–∏–µ, –º—É–¥—Ä–æ—Å—Ç—å",
     "advice": "–£–π–¥–∏—Ç–µ –≤ —Å–µ–±—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤"},
    {"name": "üé° X. –ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã", "meaning": "–°—É–¥—å–±–∞, —Ü–∏–∫–ª—ã, —É–¥–∞—á–∞, –ø–µ—Ä–µ–º–µ–Ω—ã",
     "advice": "–ü—Ä–∏–º–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–∞–∫ –¥–æ–ª–∂–Ω–æ–µ"},
    {"name": "‚öñÔ∏è XI. –ü—Ä–∞–≤–æ—Å—É–¥–∏–µ", "meaning": "–ë–∞–ª–∞–Ω—Å, —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å, –∫–∞—Ä–º–∞, –ø—Ä–∞–≤–¥–∞",
     "advice": "–ë—É–¥—å—Ç–µ —á–µ—Å—Ç–Ω—ã –∏ –ø—Ä–∏–Ω–∏–º–∞–π—Ç–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è"},
    {"name": "üôé‚Äç‚ôÇÔ∏è XII. –ü–æ–≤–µ—à–µ–Ω–Ω—ã–π", "meaning": "–°–¥–∞—á–∞, –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–∞, –∂–µ—Ä—Ç–≤–∞, –ø–∞—É–∑–∞",
     "advice": "–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞ —Å–∏—Ç—É–∞—Ü–∏—é –ø–æ–¥ –Ω–æ–≤—ã–º —É–≥–ª–æ–º"},
    {"name": "üíÄ XIII. –°–º–µ—Ä—Ç—å", "meaning": "–ö–æ–Ω–µ—Ü, —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è, –Ω–æ–≤–æ–µ –Ω–∞—á–∞–ª–æ",
     "advice": "–û—Ç–ø—É—Å—Ç–∏—Ç–µ —Å—Ç–∞—Ä–æ–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ"},
    {"name": "üòá XIV. –£–º–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å", "meaning": "–ë–∞–ª–∞–Ω—Å, —Ç–µ—Ä–ø–µ–Ω–∏–µ, –≥–∞—Ä–º–æ–Ω–∏—è",
     "advice": "–ò—â–∏—Ç–µ –∑–æ–ª–æ—Ç—É—é —Å–µ—Ä–µ–¥–∏–Ω—É –≤–æ –≤—Å–µ–º"},
    {"name": "üëø XV. –î—å—è–≤–æ–ª", "meaning": "–ò—Å–∫—É—à–µ–Ω–∏–µ, –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è",
     "advice": "–û—Å–æ–∑–Ω–∞–π—Ç–µ —Å–≤–æ–∏ –æ–∫–æ–≤—ã –∏ –æ—Å–≤–æ–±–æ–¥–∏—Ç–µ—Å—å"},
    {"name": "‚ö° XVI. –ë–∞—à–Ω—è", "meaning": "–ü–µ—Ä–µ–º–µ–Ω—ã, –æ—Ç–∫—Ä–æ–≤–µ–Ω–∏–µ, —Ä–∞–∑—Ä—É—à–µ–Ω–∏–µ",
     "advice": "–ü—Ä–∏–º–∏—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω—ã"},
    {"name": "‚≠ê XVII. –ó–≤–µ–∑–¥–∞", "meaning": "–ù–∞–¥–µ–∂–¥–∞, –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ, –¥—É—Ö–æ–≤–Ω–æ—Å—Ç—å",
     "advice": "–í–µ—Ä—å—Ç–µ –≤ –ª—É—á—à–µ–µ –∏ —Å–ª–µ–¥—É–π—Ç–µ –º–µ—á—Ç–µ"},
    {"name": "üåô XVIII. –õ—É–Ω–∞", "meaning": "–ò–Ω—Ç—É–∏—Ü–∏—è, –ø–æ–¥—Å–æ–∑–Ω–∞–Ω–∏–µ, –∏–ª–ª—é–∑–∏–∏",
     "advice": "–†–∞–∑–±–µ—Ä–∏—Ç–µ—Å—å –≤ —Å–≤–æ–∏—Ö —Å—Ç—Ä–∞—Ö–∞—Ö"},
    {"name": "‚òÄÔ∏è XIX. –°–æ–ª–Ω—Ü–µ", "meaning": "–†–∞–¥–æ—Å—Ç—å, —É—Å–ø–µ—Ö, –∂–∏–∑–Ω–µ–Ω–Ω–∞—è —Å–∏–ª–∞",
     "advice": "–ù–∞—Å–ª–∞–∂–¥–∞–π—Ç–µ—Å—å –∂–∏–∑–Ω—å—é –∏ —Å–≤–µ—Ç–æ–º"},
    {"name": "üîÑ XX. –°—É–¥", "meaning": "–í–æ–∑—Ä–æ–∂–¥–µ–Ω–∏–µ, –ø—Ä–∏–∑—ã–≤, –æ—Ü–µ–Ω–∫–∞",
     "advice": "–ü—Ä–∏—à–ª–æ –≤—Ä–µ–º—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏–π"},
    {"name": "üåç XXI. –ú–∏—Ä", "meaning": "–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ, —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å, –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ",
     "advice": "–ù–∞—Å–ª–∞–∂–¥–∞–π—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º —Ü–∏–∫–ª–∞"}
]

MINOR_ARCANA = [
    # –ú–µ—á–∏
    {"name": "‚öîÔ∏è –¢—É–∑ –ú–µ—á–µ–π", "meaning": "–ü—Ä–æ–∑—Ä–µ–Ω–∏–µ, –ø—Ä–æ—Ä—ã–≤, —è—Å–Ω–æ—Å—Ç—å –º—ã—Å–ª–∏"},
    {"name": "‚öîÔ∏è –î–≤–æ–π–∫–∞ –ú–µ—á–µ–π", "meaning": "–¢—É–ø–∏–∫, –≤—ã–±–æ—Ä, –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç"},
    {"name": "‚öîÔ∏è –¢—Ä–æ–π–∫–∞ –ú–µ—á–µ–π", "meaning": "–ë–æ–ª—å, —Ä–∞–∑–æ—á–∞—Ä–æ–≤–∞–Ω–∏–µ, –¥—É—à–µ–≤–Ω–∞—è —Ä–∞–Ω–∞"},
    {"name": "‚öîÔ∏è –ß–µ—Ç–≤–µ—Ä–∫–∞ –ú–µ—á–µ–π", "meaning": "–û—Ç–¥—ã—Ö, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ, –º–µ–¥–∏—Ç–∞—Ü–∏—è"},
    {"name": "‚öîÔ∏è –ü—è—Ç–µ—Ä–∫–∞ –ú–µ—á–µ–π", "meaning": "–ö–æ–Ω—Ñ–ª–∏–∫—Ç, –ø—Ä–µ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ, —É–Ω–∏–∂–µ–Ω–∏–µ"},
    
    # –ö—É–±–∫–∏
    {"name": "üèÜ –¢—É–∑ –ö—É–±–∫–æ–≤", "meaning": "–õ—é–±–æ–≤—å, —ç–º–æ—Ü–∏–∏, –Ω–æ–≤—ã–µ —á—É–≤—Å—Ç–≤–∞"},
    {"name": "üèÜ –î–≤–æ–π–∫–∞ –ö—É–±–∫–æ–≤", "meaning": "–ï–¥–∏–Ω—Å—Ç–≤–æ, –ø–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–æ, –≥–∞—Ä–º–æ–Ω–∏—è"},
    {"name": "üèÜ –¢—Ä–æ–π–∫–∞ –ö—É–±–∫–æ–≤", "meaning": "–ü—Ä–∞–∑–¥–Ω–∏–∫, –¥—Ä—É–∂–±–∞, —Å–æ–æ–±—â–µ—Å—Ç–≤–æ"},
    {"name": "üèÜ –ß–µ—Ç–≤–µ—Ä–∫–∞ –ö—É–±–∫–æ–≤", "meaning": "–ê–ø–∞—Ç–∏—è, —Å–æ–∑–µ—Ä—Ü–∞–Ω–∏–µ, –Ω–µ—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å"},
    {"name": "üèÜ –ü—è—Ç–µ—Ä–∫–∞ –ö—É–±–∫–æ–≤", "meaning": "–ü–æ—Ç–µ—Ä—è, —Å–æ–∂–∞–ª–µ–Ω–∏–µ, —Å–∫–æ—Ä–±—å"},
    
    # –ü–µ–Ω—Ç–∞–∫–ª–∏
    {"name": "üí∞ –¢—É–∑ –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "meaning": "–ü—Ä–æ—Ü–≤–µ—Ç–∞–Ω–∏–µ, –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å, –∏–∑–æ–±–∏–ª–∏–µ"},
    {"name": "üí∞ –î–≤–æ–π–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "meaning": "–ë–∞–ª–∞–Ω—Å, –∞–¥–∞–ø—Ç–∞—Ü–∏—è, –∂–æ–Ω–≥–ª–∏—Ä–æ–≤–∞–Ω–∏–µ"},
    {"name": "üí∞ –¢—Ä–æ–π–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "meaning": "–ú–∞—Å—Ç–µ—Ä—Å—Ç–≤–æ, —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ, —Ä–æ—Å—Ç"},
    {"name": "üí∞ –ß–µ—Ç–≤–µ—Ä–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "meaning": "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, –∫–æ–Ω—Ç—Ä–æ–ª—å"},
    {"name": "üí∞ –ü—è—Ç–µ—Ä–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "meaning": "–¢—Ä—É–¥–Ω–æ—Å—Ç–∏, –±–µ–¥–Ω–æ—Å—Ç—å, –∏–∑–æ–ª—è—Ü–∏—è"},
    
    # –ñ–µ–∑–ª—ã
    {"name": "üî• –¢—É–∑ –ñ–µ–∑–ª–æ–≤", "meaning": "–ò–¥–µ—è, –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ, —ç–Ω–µ—Ä–≥–∏—è"},
    {"name": "üî• –î–≤–æ–π–∫–∞ –ñ–µ–∑–ª–æ–≤", "meaning": "–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, –±—É–¥—É—â–µ–µ, —Ä–µ—à–µ–Ω–∏–µ"},
    {"name": "üî• –¢—Ä–æ–π–∫–∞ –ñ–µ–∑–ª–æ–≤", "meaning": "–ü—Ä–æ–≥—Ä–µ—Å—Å, —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ, –∫–æ–º–∞–Ω–¥–∞"},
    {"name": "üî• –ß–µ—Ç–≤–µ—Ä–∫–∞ –ñ–µ–∑–ª–æ–≤", "meaning": "–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å, –ø—Ä–∞–∑–¥–Ω–∏–∫, –¥–æ–º"},
    {"name": "üî• –ü—è—Ç–µ—Ä–∫–∞ –ñ–µ–∑–ª–æ–≤", "meaning": "–ö–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è, –∫–æ–Ω—Ñ–ª–∏–∫—Ç, –≤—ã–∑–æ–≤"}
]

FULL_DECK = MAJOR_ARCANA + MINOR_ARCANA

# –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Redis/–ë–î)
user_states = {}
user_questions = {}

def send_message(chat_id, text, parse_mode='Markdown', reply_markup=None):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram API"""
    try:
        url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
        payload = {
            'chat_id': chat_id,
            'text': text,
            'parse_mode': parse_mode
        }
        
        if reply_markup:
            payload['reply_markup'] = reply_markup
        
        response = requests.post(url, json=payload, timeout=10)
        
        if response.status_code != 200:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {response.text}")
        else:
            logger.info(f"‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ {chat_id}")
        
        return response.json()
    except Exception as e:
        logger.error(f"üö® –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ: {e}")
        return None

def generate_free_reading(question, user_name):
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ë–ï–°–ü–õ–ê–¢–ù–´–ô –ø—Ä–æ–±–Ω—ã–π —Ä–∞—Å–∫–ª–∞–¥ (2 –∫–∞—Ä—Ç—ã)"""
    cards = random.sample(MAJOR_ARCANA, 2)
    
    reading = f"""üé¥ *–ë–ï–°–ü–õ–ê–¢–ù–´–ô –ü–†–û–ë–ù–´–ô –†–ê–°–ö–õ–ê–î –î–õ–Ø {user_name.upper()}*

*–í–∞—à –≤–æ–ø—Ä–æ—Å:* "{question}"

*–ö–∞—Ä—Ç–∞ 1 (–¢–µ–∫—É—â–∞—è —ç–Ω–µ—Ä–≥–∏—è):*
{cards[0]['name']}
*–ó–Ω–∞—á–µ–Ω–∏–µ:* {cards[0]['meaning']}
*–°–æ–≤–µ—Ç:* {cards[0]['advice']}

*–ö–∞—Ä—Ç–∞ 2 (–í–æ–∑–º–æ–∂–Ω–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ):*
{cards[1]['name']}
*–ó–Ω–∞—á–µ–Ω–∏–µ:* {cards[1]['meaning']}
*–°–æ–≤–µ—Ç:* {cards[1]['advice']}

---
‚ú® *–•–æ—Ç–∏—Ç–µ –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω—ã–π —Ä–∞—Å–∫–ª–∞–¥?*

–í –±–µ—Å–ø–ª–∞—Ç–Ω–æ–º –≤–∞—Ä–∏–∞–Ω—Ç–µ —è –ø–æ–∫–∞–∑—ã–≤–∞—é —Ç–æ–ª—å–∫–æ –æ–±—â—É—é —ç–Ω–µ—Ä–≥–∏—é. –î–ª—è *–¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞* —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –Ω–∏–∂–µ:"""
    
    return reading

def generate_paid_reading(question, user_name, product_type):
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–ª–∞—Ç–Ω—ã–π —Ä–∞—Å–∫–ª–∞–¥"""
    product = PRODUCTS[product_type]
    cards = random.sample(FULL_DECK, product["cards_count"])
    
    # –†–∞–∑–Ω—ã–µ —Ä–∞—Å–∫–ª–∞–¥—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤
    if product_type == "basic":
        positions = ["–ü—Ä–æ—à–ª–æ–µ", "–ù–∞—Å—Ç–æ—è—â–µ–µ", "–ë—É–¥—É—â–µ–µ"]
        reading = f"""üîÆ *–†–ê–°–ö–õ–ê–î \"{product['name']}\"*

*–ö–ª–∏–µ–Ω—Ç:* {user_name}
*–í–æ–ø—Ä–æ—Å:* "{question}"
*–î–∞—Ç–∞:* {datetime.now().strftime('%d.%m.%Y %H:%M')}

*–ö–∞—Ä—Ç—ã –∏ –∏—Ö –∑–Ω–∞—á–µ–Ω–∏–µ:*
"""
        for i, card in enumerate(cards[:3]):
            reading += f"\n*{positions[i]}:* {card['name']}\n"
            reading += f"_{card['meaning']}_\n"
        
        reading += f"""
üíé *–ê–Ω–∞–ª–∏–∑ —Å–∏—Ç—É–∞—Ü–∏–∏:*
{random.choice([
    "–°–∏—Ç—É–∞—Ü–∏—è —Ç—Ä–µ–±—É–µ—Ç –≤–∞—à–µ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —É—á–∞—Å—Ç–∏—è",
    "–ö–∞—Ä—Ç—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏",
    "–í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –æ–±–¥—É–º–∞–π—Ç–µ —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥",
    "–°–æ—Å—Ä–µ–¥–æ—Ç–æ—á—å—Ç–µ—Å—å –Ω–∞ —Å–≤–æ–∏—Ö –∏—Å—Ç–∏–Ω–Ω—ã—Ö –∂–µ–ª–∞–Ω–∏—è—Ö"
])}

‚ú® *–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å–æ–≤–µ—Ç:*
{random.choice([
    "–ü—Ä–æ—è–≤–∏—Ç–µ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É –≤ –±–ª–∏–∂–∞–π—à–∏–µ 3 –¥–Ω—è",
    "–û—Ç–ª–æ–∂–∏—Ç–µ –≤–∞–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –¥–æ —Å–ª–µ–¥—É—é—â–µ–π –Ω–µ–¥–µ–ª–∏",
    "–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –∑–Ω–∞–∫–∏ —Å—É–¥—å–±—ã",
    "–î–æ–≤–µ—Ä—å—Ç–µ—Å—å —Å–≤–æ–µ–π –∏–Ω—Ç—É–∏—Ü–∏–∏"
])}

üí∞ *–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏—è –≤ —Å–µ–±—è:* {product['price']} —Ä—É–±.

_–°–ø–∞—Å–∏–±–æ –∑–∞ –∑–∞–∫–∞–∑! –≠—Ç–æ—Ç —Ä–∞—Å–∫–ª–∞–¥ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è —Å –≤–∞–º–∏ –Ω–∞–≤—Å–µ–≥–¥–∞._"""
    
    elif product_type == "advanced":
        positions = ["–í—ã", "–í–∞—à –ø–∞—Ä—Ç–Ω–µ—Ä/—Å–∏—Ç—É–∞—Ü–∏—è", "–ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è", "–ü–æ–º–æ—â—å", "–ü—Ä–æ—à–ª–æ–µ", "–ù–∞—Å—Ç–æ—è—â–µ–µ", "–ë—É–¥—É—â–µ–µ"]
        reading = f"""‚ú® *–†–ê–°–ö–õ–ê–î \"{product['name']}\"*

*–ö–ª–∏–µ–Ω—Ç:* {user_name}
*–í–æ–ø—Ä–æ—Å:* "{question}"
*–î–∞—Ç–∞:* {datetime.now().strftime('%d.%m.%Y %H:%M')}
*–ö–∞—Ä—Ç –≤ —Ä–∞—Å–∫–ª–∞–¥–µ:* {product['cards_count']}

*–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑:*
"""
        for i, card in enumerate(cards[:7]):
            reading += f"\n*{positions[i]}:* {card['name']}\n"
            reading += f"_{card['meaning']}_\n"
        
        reading += f"""
üíé *–°–∏–Ω—Ç–µ–∑ —Ä–∞—Å–∫–ª–∞–¥–∞:*
1. *–û—Å–Ω–æ–≤–Ω–∞—è —Ç–µ–º–∞:* {random.choice(["–û—Ç–Ω–æ—à–µ–Ω–∏—è", "–ö–∞—Ä—å–µ—Ä–∞", "–õ–∏—á–Ω–æ—Å—Ç–Ω—ã–π —Ä–æ—Å—Ç", "–§–∏–Ω–∞–Ω—Å—ã"])}
2. *–ö–ª—é—á–µ–≤–∞—è –∑–∞–¥–∞—á–∞:* {random.choice(["–ü—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏—è", "–ü—Ä–µ–æ–¥–æ–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞—Ö–æ–≤", "–†–∞–∑–≤–∏—Ç–∏–µ –Ω–∞–≤—ã–∫–æ–≤", "–ü–æ–∏—Å–∫ –±–∞–ª–∞–Ω—Å–∞"])}
3. *–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:* {random.choice(["–ú–µ–¥–∏—Ç–∞—Ü–∏—è", "–û–±—É—á–µ–Ω–∏–µ", "–ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã", "–û—Ç–¥—ã—Ö"])}

üéØ *–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:*
‚Ä¢ –ù–µ–¥–µ–ª—è 1: {random.choice(["–°—Ñ–æ–∫—É—Å–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏", "–ü—Ä–æ—è–≤–∏—Ç–µ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É", "–û—Ç–¥–æ—Ö–Ω–∏—Ç–µ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ—Å—å"])}
‚Ä¢ –ù–µ–¥–µ–ª—è 2: {random.choice(["–ù–∞—á–Ω–∏—Ç–µ –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å", "–ü—Ä–æ–≤–µ–¥–∏—Ç–µ –≤–∞–∂–Ω—ã–µ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã", "–ó–∞–≤–µ—Ä—à–∏—Ç–µ –Ω–∞—á–∞—Ç–æ–µ"])}
‚Ä¢ –ù–µ–¥–µ–ª—è 3: {random.choice(["–ü–æ–¥–≤–µ–¥–∏—Ç–µ –∏—Ç–æ–≥–∏", "–°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–π—Ç–µ –ø–ª–∞–Ω—ã", "–û—Ç–ø—Ä–∞–∑–¥–Ω—É–π—Ç–µ —É—Å–ø–µ—Ö–∏"])}

üí∞ *–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏—è –≤ —Å–µ–±—è:* {product['price']} —Ä—É–±.

_–≠—Ç–æ—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ–º–æ–∂–µ—Ç –≤–∞–º –ø—Ä–∏–Ω–∏–º–∞—Ç—å –≤–µ—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –≤ —Ç–µ—á–µ–Ω–∏–µ –º–µ—Å—è—Ü–∞._"""
    
    else:  # full
        reading = f"""üí´ *–†–ê–°–ö–õ–ê–î \"{product['name']}\"*

*–ö–ª–∏–µ–Ω—Ç:* {user_name}
*–í–æ–ø—Ä–æ—Å:* "{question}"
*–î–∞—Ç–∞:* {datetime.now().strftime('%d.%m.%Y %H:%M')}
*–ö–∞—Ä—Ç –≤ —Ä–∞—Å–∫–ª–∞–¥–µ:* {product['cards_count']}
*–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞–Ω–∞–ª–∏–∑–∞:* 45-60 –º–∏–Ω—É—Ç

üìä *–ü–û–õ–ù–´–ô –ê–ù–ê–õ–ò–ó –ö–ê–†–¢:*
"""
        themes = ["–õ–∏—á–Ω–æ—Å—Ç—å", "–û—Ç–Ω–æ—à–µ–Ω–∏—è", "–ö–∞—Ä—å–µ—Ä–∞", "–§–∏–Ω–∞–Ω—Å—ã", "–ó–¥–æ—Ä–æ–≤—å–µ", "–î—É—Ö–æ–≤–Ω–æ—Å—Ç—å", 
                  "–ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è", "–ü–æ–º–æ—â—å", "–°–∫—Ä—ã—Ç—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏", "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏", "–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –º–µ—Å—è—Ü", "–ò—Ç–æ–≥"]
        
        for i, card in enumerate(cards[:12]):
            reading += f"\n*{themes[i]}:* {card['name']}\n"
            reading += f"_{card['meaning']}_\n"
        
        reading += f"""
üéØ *–ö–õ–Æ–ß–ï–í–´–ï –í–´–í–û–î–´:*
1. *–ì–ª–∞–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ –º–µ—Å—è—Ü–∞:* {random.choice(["–†–∞–∑–≤–∏—Ç–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–π", "–ö–∞—Ä—å–µ—Ä–Ω—ã–π —Ä–æ—Å—Ç", "–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å", "–õ–∏—á–Ω–æ—Å—Ç–Ω–∞—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è"])}
2. *–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:* {random.choice(["–ò–Ω—Ç—É–∏—Ü–∏—è", "–ö–æ–º–º—É–Ω–∏–∫–∞–±–µ–ª—å–Ω–æ—Å—Ç—å", "–¢–µ—Ä–ø–µ–Ω–∏–µ", "–ö—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å"])}
3. *–ó–æ–Ω—ã —Ä–æ—Å—Ç–∞:* {random.choice(["–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ —Å–µ–±–µ", "–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞", "–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å", "–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ"])}

üìÖ *–ü–û–ú–ï–°–Ø–ß–ù–´–ô –ü–†–û–ì–ù–û–ó:*
‚Ä¢ *1-—è –Ω–µ–¥–µ–ª—è:* {random.choice(["–ù–∞—á–∞–ª–æ –≤–∞–∂–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤", "–ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏", "–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–¥—ä–µ–º"])}
‚Ä¢ *2-—è –Ω–µ–¥–µ–ª—è:* {random.choice(["–ü—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏–π", "–ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã", "–¢–≤–æ—Ä—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è"])}
‚Ä¢ *3-—è –Ω–µ–¥–µ–ª—è:* {random.choice(["–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è", "–í–∏–¥–∏–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã", "–ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏"])}
‚Ä¢ *4-—è –Ω–µ–¥–µ–ª—è:* {random.choice(["–ü–æ–¥–≤–µ–¥–µ–Ω–∏–µ –∏—Ç–æ–≥–æ–≤", "–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ –º–µ—Å—è—Ü–∞", "–í–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ –∑–∞ —Ç—Ä—É–¥—ã"])}

üíé *–ü–ï–†–°–û–ù–ê–õ–¨–ù–´–ô –ü–õ–ê–ù –î–ï–ô–°–¢–í–ò–ô:*
1. *–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ:* {random.choice(["–ó–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ–∏ —Ü–µ–ª–∏", "–°–æ—Å—Ç–∞–≤—å—Ç–µ –ø–ª–∞–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é", "–ü—Ä–æ–≤–µ–¥–∏—Ç–µ –≤–∞–∂–Ω—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä"])}
2. *–í —Ç–µ—á–µ–Ω–∏–µ –Ω–µ–¥–µ–ª–∏:* {random.choice(["–ù–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç", "–ò–Ω–≤–µ—Å—Ç–∏—Ä—É–π—Ç–µ –≤ –æ–±—É—á–µ–Ω–∏–µ", "–£–ª—É—á—à–∏—Ç–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è"])}
3. *–î–æ –∫–æ–Ω—Ü–∞ –º–µ—Å—è—Ü–∞:* {random.choice(["–î–æ—Å—Ç–∏–≥–Ω–∏—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ü–µ–ª–∏", "–°—Ñ–æ—Ä–º–∏—Ä—É–π—Ç–µ –Ω–æ–≤—É—é –ø—Ä–∏–≤—ã—á–∫—É", "–£–≤–µ–ª–∏—á—å—Ç–µ –¥–æ—Ö–æ–¥"])}

üí∞ *–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏—è –≤ —Å–µ–±—è:* {product['price']} —Ä—É–±.

_–≠—Ç–æ—Ç –ø–æ–ª–Ω—ã–π —Ä–∞—Å–∫–ª–∞–¥ —Å—Ç–∞–Ω–µ—Ç –≤–∞—à–µ–π –¥–æ—Ä–æ–∂–Ω–æ–π –∫–∞—Ä—Ç–æ–π –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–π –º–µ—Å—è—Ü._"""
    
    return reading

def show_payment_options(chat_id, user_name, question, product_type):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ–ø–ª–∞—Ç—ã"""
    product = PRODUCTS[product_type]
    
    keyboard = {
        "inline_keyboard": [[
            {"text": f"üí≥ –û–ø–ª–∞—Ç–∏—Ç—å {product['price']} —Ä—É–±.", "callback_data": f"pay_{product_type}_{hash(question) % 10000}"},
            {"text": "‚ùå –û—Ç–º–µ–Ω–∞", "callback_data": "cancel_payment"}
        ]]
    }
    
    message = f"""üíé *–í–´–ë–†–ê–ù –ü–ê–ö–ï–¢: {product['name']}*

*–í–∞—à –≤–æ–ø—Ä–æ—Å:* "{question}"
*–°—Ç–æ–∏–º–æ—Å—Ç—å:* {product['price']} —Ä—É–±.

{product['description']}

üìã *–ß—Ç–æ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ:*
‚Ä¢ –ü–æ–¥—Ä–æ–±–Ω—ã–π –∞–Ω–∞–ª–∏–∑ {product['cards_count']} –∫–∞—Ä—Ç
‚Ä¢ –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
‚Ä¢ –û—Ç–≤–µ—Ç—ã –Ω–∞ –≤–∞—à –≤–æ–ø—Ä–æ—Å
‚Ä¢ –ü–∏—Å—å–º–µ–Ω–Ω—ã–π —Ä–∞—Å–∫–ª–∞–¥ –Ω–∞–≤—Å–µ–≥–¥–∞

üí≥ *–°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã:*
1. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –¥–ª—è –æ–ø–ª–∞—Ç—ã –∫–∞—Ä—Ç–æ–π
2. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –≤—ã –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –ø–æ–ª—É—á–∏—Ç–µ —Ä–∞—Å–∫–ª–∞–¥

_–û–ø–ª–∞—Ç–∞ –∑–∞—â–∏—â–µ–Ω–∞ Telegram –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–ª–∞—Ç–µ–∂–Ω—ã–π —à–ª—é–∑._"""
    
    send_message(chat_id, message, reply_markup=keyboard)

@app.route('/webhook', methods=['POST'])
def webhook():
    """–û—Å–Ω–æ–≤–Ω–æ–π webhook –æ—Ç Telegram"""
    try:
        data = request.get_json()
        logger.info("üì• –ü–æ–ª—É—á–µ–Ω webhook")
        
        if not data:
            return jsonify({"status": "error", "message": "No data"}), 400
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ callback-–∑–∞–ø—Ä–æ—Å–æ–≤ (–Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–æ–∫)
        if 'callback_query' in data:
            callback = data['callback_query']
            chat_id = callback['message']['chat']['id']
            user_name = callback['from'].get('first_name', '–∫–ª–∏–µ–Ω—Ç')
            callback_data = callback['data']
            
            logger.info(f"üîò Callback –æ—Ç {user_name}: {callback_data}")
            
            if callback_data == 'free_reading':
                # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ä–∞—Å–∫–ª–∞–¥
                if chat_id in user_questions:
                    question = user_questions[chat_id]
                    reading = generate_free_reading(question, user_name)
                    send_message(chat_id, reading)
                    
                    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–ª–∞—Ç–Ω—ã—Ö —Ä–∞—Å–∫–ª–∞–¥–æ–≤
                    time.sleep(1)
                    show_products(chat_id, user_name, question)
                else:
                    send_message(chat_id, "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –∑–∞–Ω–æ–≤–æ.")
            
            elif callback_data.startswith('product_'):
                # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª –ø—Ä–æ–¥—É–∫—Ç
                product_type = callback_data.split('_')[1]
                if chat_id in user_questions:
                    question = user_questions[chat_id]
                    show_payment_options(chat_id, user_name, question, product_type)
                else:
                    send_message(chat_id, "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –∑–∞–Ω–æ–≤–æ.")
            
            elif callback_data.startswith('pay_'):
                # –°–∏–º—É–ª—è—Ü–∏—è —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã
                parts = callback_data.split('_')
                product_type = parts[1]
                question_hash = parts[2]
                
                product = PRODUCTS[product_type]
                
                # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–ª–∞—Ç–Ω–æ–≥–æ —Ä–∞—Å–∫–ª–∞–¥–∞
                if chat_id in user_questions:
                    question = user_questions[chat_id]
                    send_message(chat_id, "üí≥ *–û–ü–õ–ê–¢–ê –ü–†–û–®–õ–ê –£–°–ü–ï–®–ù–û!*")
                    time.sleep(1)
                    
                    send_message(chat_id, f"‚ú® *–ì–æ—Ç–æ–≤–ª—é –≤–∞—à —Ä–∞—Å–∫–ª–∞–¥ \"{product['name']}\"...*")
                    time.sleep(2)
                    
                    reading = generate_paid_reading(question, user_name, product_type)
                    send_message(chat_id, reading)
                    
                    # –ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏
                    time.sleep(1)
                    thank_you = f"""üíñ *–°–ü–ê–°–ò–ë–û –ó–ê –ü–û–ö–£–ü–ö–£, {user_name}!*

–í–∞—à —Ä–∞—Å–∫–ª–∞–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω. –í—ã –º–æ–∂–µ—Ç–µ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å—Å—è –∫ –Ω–µ–º—É –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è.

üìÖ *–†–µ–∫–æ–º–µ–Ω–¥—É—é:* 
–ß–µ—Ä–µ–∑ –º–µ—Å—è—Ü —Å–¥–µ–ª–∞—Ç—å –Ω–æ–≤—ã–π —Ä–∞—Å–∫–ª–∞–¥, —á—Ç–æ–±—ã –æ—Ç—Å–ª–µ–¥–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –ø–æ–ª—É—á–∏—Ç—å —Å–≤–µ–∂–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.

üíå *–ï—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã?* 
–ù–∞–ø–∏—à–∏—Ç–µ –º–Ω–µ @Tarotyour_bot –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è!

_–° –ª—é–±–æ–≤—å—é –∏ —Å–≤–µ—Ç–æ–º,_
_–í–∞—à —Ç–∞—Ä–æ–ª–æ–≥_ üåô"""
                    send_message(chat_id, thank_you)
                    
                    # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                    if chat_id in user_states:
                        del user_states[chat_id]
                    if chat_id in user_questions:
                        del user_questions[chat_id]
            
            elif callback_data == 'cancel_payment':
                send_message(chat_id, "–û–ø–ª–∞—Ç–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞. –í–∞—à –≤–æ–ø—Ä–æ—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω, –≤—ã –º–æ–∂–µ—Ç–µ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –Ω–µ–º—É –ø–æ–∑–∂–µ.")
            
            return jsonify({"status": "success"}), 200
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±—ã—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        if 'message' in data and 'text' in data['message']:
            message_text = data['message']['text'].strip()
            chat_id = data['message']['chat']['id']
            user_name = data['message']['from'].get('first_name', '–¥—Ä—É–≥')
            
            logger.info(f"üë§ {user_name}: {message_text}")
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user_questions[chat_id] = message_text
            
            if message_text.lower().startswith('/start'):
                welcome_message = f"""üîÆ *–î–û–ë–†–û –ü–û–ñ–ê–õ–û–í–ê–¢–¨, {user_name}!* 

–Ø ‚Äî *@Tarotyour_bot*, –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ç–∞—Ä–æ–ª–æ–≥ —Å 10-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º.

‚ú® *–ß–¢–û –Ø –ú–û–ì–£ –î–õ–Ø –í–ê–° –°–î–ï–õ–ê–¢–¨:*
1. *–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø—Ä–æ–±–Ω—ã–π —Ä–∞—Å–∫–ª–∞–¥* (2 –∫–∞—Ä—Ç—ã) ‚Äî –æ–±—â–∞—è —ç–Ω–µ—Ä–≥–∏—è —Å–∏—Ç—É–∞—Ü–∏–∏
2. *–î–µ—Ç–∞–ª—å–Ω—ã–µ –ø–ª–∞—Ç–Ω—ã–µ —Ä–∞—Å–∫–ª–∞–¥—ã* ‚Äî –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏

üíé *–ú–û–ò –ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê:*
‚Ä¢ –¢–æ—á–Ω–æ—Å—Ç—å –ø—Ä–æ–≥–Ω–æ–∑–æ–≤: 92% –ø–æ –æ—Ç–∑—ã–≤–∞–º –∫–ª–∏–µ–Ω—Ç–æ–≤
‚Ä¢ –ë–æ–ª–µ–µ 5000 –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π
‚Ä¢ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ –∫–∞–∂–¥–æ–º—É –∫–ª–∏–µ–Ω—Ç—É
‚Ä¢ –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞

üé¥ *–ö–ê–ö –≠–¢–û –†–ê–ë–û–¢–ê–ï–¢:*
1. –í—ã –∑–∞–¥–∞–µ—Ç–µ –≤–æ–ø—Ä–æ—Å (–æ –ª—é–±–≤–∏, —Ä–∞–±–æ—Ç–µ, –±—É–¥—É—â–µ–º, –¥–µ–Ω—å–≥–∞—Ö)
2. –Ø –¥–µ–ª–∞—é —Ä–∞—Å–∫–ª–∞–¥ –∏ –¥–∞—é –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—é
3. –í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∫ –¥–µ–π—Å—Ç–≤–∏—é

*–ó–∞–¥–∞–π—Ç–µ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å ‚Äî –∏ –º—ã –Ω–∞—á–Ω–µ–º!* ‚ú®

üí≠ *–ü—Ä–∏–º–µ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤:*
‚Ä¢ –ß—Ç–æ –º–µ–Ω—è –∂–¥–µ—Ç –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö?
‚Ä¢ –ö–∞–∫–æ–π –∫–∞—Ä—å–µ—Ä–Ω—ã–π —à–∞–≥ —Å–¥–µ–ª–∞—Ç—å?
‚Ä¢ –ö–∞–∫ —É–ª—É—á—à–∏—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—É—é —Å–∏—Ç—É–∞—Ü–∏—é?
‚Ä¢ –ß—Ç–æ –¥—É–º–∞–µ—Ç –æ–±–æ –º–Ω–µ —ç—Ç–æ—Ç —á–µ–ª–æ–≤–µ–∫?"""
                
                send_message(chat_id, welcome_message)
                
            else:
                # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å - –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –≤—ã–±–æ—Ä
                keyboard = {
                    "inline_keyboard": [[
                        {"text": "üé¥ –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø—Ä–æ–±–Ω—ã–π —Ä–∞—Å–∫–ª–∞–¥ (2 –∫–∞—Ä—Ç—ã)", "callback_data": "free_reading"},
                        {"text": "üíé –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–ª–∞—Ç–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã", "callback_data": "show_products"}
                    ]]
                }
                
                response = f"""‚ú® *–û–¢–õ–ò–ß–ù–´–ô –í–û–ü–†–û–°, {user_name}!*

*–í–∞—à –≤–æ–ø—Ä–æ—Å:* "{message_text}"

–Ø –º–æ–≥—É –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –≤–∞–º:

1. *üé¥ –ë–ï–°–ü–õ–ê–¢–ù–´–ô –≤–∞—Ä–∏–∞–Ω—Ç:*
   ‚Ä¢ 2 –∫–∞—Ä—Ç—ã –¢–∞—Ä–æ
   ‚Ä¢ –û–±—â–∞—è —ç–Ω–µ—Ä–≥–∏—è —Å–∏—Ç—É–∞—Ü–∏–∏
   ‚Ä¢ –ë–∞–∑–æ–≤—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

2. *üíé –ü–õ–ê–¢–ù–´–ï —Ä–∞—Å–∫–ª–∞–¥—ã:*
   ‚Ä¢ 3-12 –∫–∞—Ä—Ç (–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–∞–∫–µ—Ç–∞)
   ‚Ä¢ –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å–∏—Ç—É–∞—Ü–∏–∏
   ‚Ä¢ –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —à–∞–≥–∏ –∏ —Å—Ä–æ–∫–∏
   ‚Ä¢ –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –º–µ—Å—è—Ü
   ‚Ä¢ –ü–∏—Å—å–º–µ–Ω–Ω—ã–π –æ—Ç—á–µ—Ç –Ω–∞–≤—Å–µ–≥–¥–∞

*–ß—Ç–æ –≤—ã–±–µ—Ä–µ—Ç–µ?*"""
                
                send_message(chat_id, response, reply_markup=keyboard)
            
            return jsonify({"status": "success", "processed": True}), 200
        
        return jsonify({"status": "success", "processed": False}), 200
        
    except Exception as e:
        logger.error(f"üö® –û—à–∏–±–∫–∞ –≤ webhook: {e}")
        return jsonify({"status": "error", "message": str(e)}), 400

def show_products(chat_id, user_name, question):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–ª–∞—Ç–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã"""
    keyboard = {
        "inline_keyboard": [
            [{"text": f"üîÆ {PRODUCTS['basic']['name']} - {PRODUCTS['basic']['price']} —Ä—É–±.", 
              "callback_data": "product_basic"}],
            [{"text": f"‚ú® {PRODUCTS['advanced']['name']} - {PRODUCTS['advanced']['price']} —Ä—É–±.", 
              "callback_data": "product_advanced"}],
            [{"text": f"üí´ {PRODUCTS['full']['name']} - {PRODUCTS['full']['price']} —Ä—É–±.", 
              "callback_data": "product_full"}]
        ]
    }
    
    message = f"""üíé *–í–´–ë–ï–†–ò–¢–ï –ü–ê–ö–ï–¢ –î–õ–Ø –î–ï–¢–ê–õ–¨–ù–û–ì–û –†–ê–°–ö–õ–ê–î–ê*

*–í–∞—à –≤–æ–ø—Ä–æ—Å:* "{question}"

üìä *–î–û–°–¢–£–ü–ù–´–ï –ü–ê–ö–ï–¢–´:*

1. *{PRODUCTS['basic']['name']}* ‚Äî {PRODUCTS['basic']['price']} —Ä—É–±.
   {PRODUCTS['basic']['description']}
   ‚Ä¢ 3 –∫–∞—Ä—Ç—ã –¢–∞—Ä–æ
   ‚Ä¢ –ê–Ω–∞–ª–∏–∑ –ü—Ä–æ—à–ª–æ–µ/–ù–∞—Å—Ç–æ—è—â–µ–µ/–ë—É–¥—É—â–µ–µ
   ‚Ä¢ –ë–∞–∑–æ–≤—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

2. *{PRODUCTS['advanced']['name']}* ‚Äî {PRODUCTS['advanced']['price']} —Ä—É–±.
   {PRODUCTS['advanced']['description']}
   ‚Ä¢ 7 –∫–∞—Ä—Ç –¢–∞—Ä–æ
   ‚Ä¢ –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å–∏—Ç—É–∞—Ü–∏–∏
   ‚Ä¢ –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –ø–æ –¥–µ–π—Å—Ç–≤–∏—è–º
   ‚Ä¢ –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 2 –Ω–µ–¥–µ–ª–∏

3. *{PRODUCTS['full']['name']}* ‚Äî {PRODUCTS['full']['price']} —Ä—É–±.
   {PRODUCTS['full']['description']}
   ‚Ä¢ 12 –∫–∞—Ä—Ç –¢–∞—Ä–æ
   ‚Ä¢ –ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –≤—Å–µ—Ö —Å—Ñ–µ—Ä –∂–∏–∑–Ω–∏
   ‚Ä¢ –ü–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω –Ω–∞ –º–µ—Å—è—Ü
   ‚Ä¢ –ü–æ–º–µ—Å—è—á–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑
   ‚Ä¢ –ü–∏—Å—å–º–µ–Ω–Ω—ã–π –æ—Ç—á–µ—Ç

‚ú® *–ü–û–ß–ï–ú–£ –°–¢–û–ò–¢ –í–´–ë–†–ê–¢–¨ –ü–õ–ê–¢–ù–´–ô –†–ê–°–ö–õ–ê–î:*
‚Ä¢ –ì–ª—É–±–∏–Ω–∞ –∞–Ω–∞–ª–∏–∑–∞ –≤ 3-6 —Ä–∞–∑ –≤—ã—à–µ
‚Ä¢ –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å—Ä–æ–∫–∏ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
‚Ä¢ –£—á–µ—Ç –≤—Å–µ—Ö –Ω—é–∞–Ω—Å–æ–≤ –≤–∞—à–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏
‚Ä¢ –ü–∏—Å—å–º–µ–Ω–Ω—ã–π –æ—Ç—á–µ—Ç, –∫–æ—Ç–æ—Ä—ã–π –æ—Å—Ç–∞–Ω–µ—Ç—Å—è —Å –≤–∞–º–∏

_98% –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –∑–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ —Ä–∞—Å–∫–ª–∞–¥–∞–º–∏!_

–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–∫–µ—Ç:"""
    
    send_message(chat_id, message, reply_markup=keyboard)

@app.route('/set_webhook', methods=['GET'])
def set_webhook():
    """–£—Å—Ç–∞–Ω–æ–≤–∫–∞ webhook"""
    try:
        if not BOT_TOKEN:
            return jsonify({"error": "BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"}), 400
        
        webhook_url = request.host_url.rstrip('/') + '/webhook'
        logger.info(f"üîó –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é webhook: {webhook_url}")
        
        telegram_url = f"https://api.telegram.org/bot{BOT_TOKEN}/setWebhook"
        response = requests.post(telegram_url, json={'url': webhook_url}, timeout=10)
        
        return jsonify({
            "success": response.status_code == 200,
            "webhook_url": webhook_url,
            "response": response.json() if response.status_code == 200 else response.text
        }), 200
        
    except Exception as e:
        logger.error(f"üö® –û—à–∏–±–∫–∞: {e}")
        return jsonify({"error": str(e)}), 400

@app.route('/')
def home():
    return jsonify({
        "status": "active",
        "bot": "@Tarotyour_bot",
        "description": "–ü—Ä–æ–¥–∞—é—â–∏–π –±–æ—Ç-—Ç–∞—Ä–æ–ª–æ–≥ —Å –≤–æ—Ä–æ–Ω–∫–æ–π –ø—Ä–æ–¥–∞–∂",
        "products": PRODUCTS,
        "features": ["–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –ø—Ä–æ–±–Ω—ã–µ —Ä–∞—Å–∫–ª–∞–¥—ã", "–ü–ª–∞—Ç–Ω—ã–µ –ø–∞–∫–µ—Ç—ã", "Inline-–∫–Ω–æ–ø–∫–∏", "–í–æ—Ä–æ–Ω–∫–∞ –ø—Ä–æ–¥–∞–∂"]
    })

if __name__ == '__main__':
    port = int(os.environ.get('PORT', 10000))
    logger.info(f"üöÄ –ó–ê–ü–£–°–ö –ü–†–û–î–ê–Æ–©–ï–ì–û –ë–û–¢–ê –¢–ê–†–û –ù–ê –ü–û–†–¢–£ {port}")
    logger.info(f"üíé –î–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã: {PRODUCTS}")
    app.run(host='0.0.0.0', port=port, debug=False)

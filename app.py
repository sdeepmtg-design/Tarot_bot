from flask import Flask, request, jsonify
import os
import requests
import logging
import random
import time
import threading
import json
from datetime import datetime

app = Flask(__name__)
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(name)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
BOT_TOKEN = os.environ.get('BOT_TOKEN')
if not BOT_TOKEN:
    logger.error("‚ùå BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")
    raise ValueError("BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è!")

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–¥–∞–∂
sales_data = {
    'total_contacts': 0,
    'conversions': 0,
    'revenue': 0
}

# –•—Ä–∞–Ω–∏–º –∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–¥–∞–∂–∏
active_sales = {}

class SalesManager:
    """–ö–ª–∞—Å—Å –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ø—Ä–æ–¥–∞–∂"""
    
    def __init__(self, chat_id, user_name):
        self.chat_id = chat_id
        self.user_name = user_name
        self.stage = "GREETING"  # GREETING ‚Üí PROBLEM ‚Üí PAIN ‚Üí SOLUTION ‚Üí CLOSE
        self.problem = ""
        self.pain_points = []
        self.objections = []
        self.attempts = 0
        self.last_message_time = time.time()
        self.created_at = datetime.now()
        self.discount_offered = False
        self.urgency_created = False
        
    def process_message(self, message):
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç –ø—Ä–æ–¥–∞–≤—Ü–∞"""
        self.last_message_time = time.time()
        self.attempts += 1
        
        message_lower = message.lower()
        
        # –õ–æ–≥–∏—Ä—É–µ–º –≤—Å–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
        logger.info(f"üí∞ –ü—Ä–æ–¥–∞–∂–∞ {self.chat_id}: —Å—Ç–∞–¥–∏—è {self.stage}, —Å–æ–æ–±—â–µ–Ω–∏–µ: {message[:50]}")
        
        # –í–æ—Ä–æ–Ω–∫–∞ –ø—Ä–æ–¥–∞–∂ –ø–æ —Å—Ç–∞–¥–∏—è–º
        if self.stage == "GREETING":
            return self.handle_greeting(message_lower)
            
        elif self.stage == "PROBLEM":
            return self.handle_problem(message_lower, message)
            
        elif self.stage == "PAIN":
            return self.handle_pain(message_lower, message)
            
        elif self.stage == "SOLUTION":
            return self.handle_solution(message_lower)
            
        elif self.stage == "CLOSE":
            return self.handle_close(message_lower)
            
        elif self.stage == "OBJECTION":
            return self.handle_objection(message_lower)
            
        return "–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫. –î–∞–≤–∞–π—Ç–µ –Ω–∞—á–Ω–µ–º —Å–Ω–∞—á–∞–ª–∞. –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ, —á—Ç–æ –≤–∞—Å –±–µ—Å–ø–æ–∫–æ–∏—Ç?"
    
    def handle_greeting(self, message):
        """–°—Ç–∞–¥–∏—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è - –∑–∞—Ö–≤–∞—Ç –≤–Ω–∏–º–∞–Ω–∏—è"""
        sales_data['total_contacts'] += 1
        
        # –ü–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ - –º–æ—â–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
        self.stage = "PROBLEM"
        
        responses = [
            f"–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é, {self.user_name}! üëã –Ø –ê–Ω–Ω–∞, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–∞—Ä–æ–ª–æ–≥-–∞–Ω–∞–ª–∏—Ç–∏–∫. –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—Å—å –Ω–∞ —Ä–µ—à–µ–Ω–∏–∏ —Å–ª–æ–∂–Ω—ã—Ö –∂–∏–∑–Ω–µ–Ω–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π —Å –ø–æ–º–æ—â—å—é –∫–∞—Ä—Ç –¢–∞—Ä–æ.\n\n*–£ –≤–∞—Å –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º–∞, –∫–æ—Ç–æ—Ä–∞—è –Ω–µ –¥–∞–µ—Ç –ø–æ–∫–æ—è?*\n\n–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –∫–æ—Ä–æ—Ç–∫–æ - —á—Ç–æ –∏–º–µ–Ω–Ω–æ –≤–∞—Å –±–µ—Å–ø–æ–∫–æ–∏—Ç? –ù–µ —Å—Ç–µ—Å–Ω—è–π—Ç–µ—Å—å, —è —Ä–∞–±–æ—Ç–∞—é —Å —Å–∞–º—ã–º–∏ —Å–ª–æ–∂–Ω—ã–º–∏ —Å–ª—É—á–∞—è–º–∏.",
            f"–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {self.user_name}! –Ø –ê–Ω–Ω–∞, –≤–µ–¥—É—â–∏–π —Ç–∞—Ä–æ–ª–æ–≥ —Å 10-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º. –ü–æ–º–æ–≥–ª–∞ —É–∂–µ 2573 –∫–ª–∏–µ–Ω—Ç–∞–º –Ω–∞–π—Ç–∏ –≤—ã—Ö–æ–¥ –∏–∑ —Ç—É–ø–∏–∫–æ–≤—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π.\n\n*–ß—Ç–æ —É –≤–∞—Å –±–æ–ª–∏—Ç?*\n\n–ù–∞–∑–æ–≤–∏—Ç–µ —Å–∞–º—É—é –æ—Å—Ç—Ä—É—é –ø—Ä–æ–±–ª–µ–º—É, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å –º–µ—à–∞–µ—Ç –≤–∞–º –∂–∏—Ç—å —Å–ø–æ–∫–æ–π–Ω–æ. –ö–∞—Ä—Ç—ã –ø–æ–∫–∞–∂—É—Ç –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–±–ª–µ–º—ã.",
            f"–î–æ–±—Ä—ã–π –¥–µ–Ω—å, {self.user_name}! –ê–Ω–Ω–∞ –Ω–∞ —Å–≤—è–∑–∏. –Ø –Ω–µ –ø—Ä–æ—Å—Ç–æ —Ç–∞—Ä–æ–ª–æ–≥, –∞ —Å—Ç—Ä–∞—Ç–µ–≥ –ø–æ —Ä–µ—à–µ–Ω–∏—é –∂–∏–∑–Ω–µ–Ω–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º. –ö–∞—Ä—Ç—ã –¢–∞—Ä–æ - –º–æ–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.\n\n*–ö–∞–∫–∞—è —Å–∏—Ç—É–∞—Ü–∏—è –∑–∞—Å—Ç–∞–≤–∏–ª–∞ –≤–∞—Å –∏—Å–∫–∞—Ç—å –ø–æ–º–æ—â–∏?*\n\n–û–ø–∏—à–∏—Ç–µ –µ—ë –≤ –¥–≤—É—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è—Ö. –£–≤–µ—Ä–µ–Ω–∞, —Å–º–æ–≥—É –ø–æ–º–æ—á—å."
        ]
        
        return random.choice(responses)
    
    def handle_problem(self, message, original_message):
        """–°—Ç–∞–¥–∏—è –≤—ã—è–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã"""
        if len(original_message) < 10:
            self.stage = "PROBLEM"
            return "–í–∏–∂—É, –≤—ã —á—Ç–æ-—Ç–æ –Ω–∞–ø–∏—Å–∞–ª–∏, –Ω–æ –º–Ω–µ –Ω—É–∂–Ω–æ –±–æ–ª—å—à–µ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π. *–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É –∫–æ–Ω–∫—Ä–µ—Ç–Ω–µ–µ.* –ù–∞–ø—Ä–∏–º–µ—Ä: '–ù–µ –º–æ–≥—É –Ω–∞–π—Ç–∏ —Ä–∞–±–æ—Ç—É 6 –º–µ—Å—è—Ü–µ–≤' –∏–ª–∏ '–ú—É–∂ –æ—Ö–ª–∞–¥–µ–ª –∫–æ –º–Ω–µ –ø–æ—Å–ª–µ —Ä–æ–∂–¥–µ–Ω–∏—è —Ä–µ–±–µ–Ω–∫–∞'.\n\n–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ?"
        
        self.problem = original_message
        self.stage = "PAIN"
        
        # –£—Å–∏–ª–∏–≤–∞–µ–º –±–æ–ª—å
        responses = [
            f"–ü–æ–Ω–∏–º–∞—é, {self.user_name}. –°–∏—Ç—É–∞—Ü–∏—è –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å–ª–æ–∂–Ω–∞—è. –ò —è –∑–Ω–∞—é, —á—Ç–æ —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ —Å–ª–æ–≤–∞ - —ç—Ç–æ *—Ä–µ–∞–ª—å–Ω–∞—è –±–æ–ª—å*, –∫–æ—Ç–æ—Ä–∞—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –æ—Ç–Ω–∏–º–∞–µ—Ç —É –≤–∞—Å —ç–Ω–µ—Ä–≥–∏—é.\n\n*–ö–∞–∫ —ç—Ç–∞ –ø—Ä–æ–±–ª–µ–º–∞ –≤–ª–∏—è–µ—Ç –Ω–∞ –≤–∞—à—É –∂–∏–∑–Ω—å –ü–†–Ø–ú–û –°–ï–ô–ß–ê–°?*\n\n–ù–∞–ø—Ä–∏–º–µ—Ä: '–Ø –Ω–µ –º–æ–≥—É —Å–ø–∞—Ç—å –ø–æ –Ω–æ—á–∞–º', '–£ –º–µ–Ω—è –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π —Å—Ç—Ä–µ—Å—Å', '–Ø —Ç–µ—Ä—è—é –¥–µ–Ω—å–≥–∏'... –û–ø–∏—à–∏—Ç–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è.",
            f"–Ø—Å–Ω–æ, {self.user_name}. –¢–∞–∫–∏–µ —Å–∏—Ç—É–∞—Ü–∏–∏ –Ω–µ –ø—Ä–æ—Å—Ç–æ –Ω–µ–ø—Ä–∏—è—Ç–Ω—ã - –æ–Ω–∏ *—Ä–∞–∑—Ä—É—à–∏—Ç–µ–ª—å–Ω—ã*. –ö–∞–∂–¥—ã–π –¥–µ–Ω—å —Å —ç—Ç–æ–π –ø—Ä–æ–±–ª–µ–º–æ–π —Å—Ç–æ–∏—Ç –≤–∞–º —á–µ–≥–æ-—Ç–æ –≤–∞–∂–Ω–æ–≥–æ.\n\n*–ß–µ–≥–æ –≤—ã —É–∂–µ –ª–∏—à–∏–ª–∏—Å—å –∏–∑-–∑–∞ —ç—Ç–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏?*\n\n–°–æ–Ω? –î–µ–Ω—å–≥–∏? –û—Ç–Ω–æ—à–µ–Ω–∏—è? –ó–¥–æ—Ä–æ–≤—å–µ? –ù–∞–ø–∏—à–∏—Ç–µ, —á—Ç–æ —É–∂–µ —É—à–ª–æ.",
            f"–ü–æ–Ω—è–ª–∞ –≤–∞—Å, {self.user_name}. –≠—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞ - —ç—Ç–æ *—Å–∏—Å—Ç–µ–º–Ω—ã–π —Å–±–æ–π* –≤ –≤–∞—à–µ–π –∂–∏–∑–Ω–∏. –ò –µ—Å–ª–∏ –Ω–µ —Ä–µ—à–∏—Ç—å –µ–≥–æ —Å–µ–π—á–∞—Å, –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –±—É–¥—É—Ç –Ω–∞–∫–∞–ø–ª–∏–≤–∞—Ç—å—Å—è.\n\n*–ß—Ç–æ —Å–∞–º–æ–µ —Å—Ç—Ä–∞—à–Ω–æ–µ –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏, –µ—Å–ª–∏ –≤—Å—ë –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å?*\n\n–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ —Ö—É–¥—à–∏–π —Å—Ü–µ–Ω–∞—Ä–∏–π —á–µ—Ä–µ–∑ –º–µ—Å—è—Ü, –ø–æ–ª–≥–æ–¥–∞, –≥–æ–¥. –û–ø–∏—à–∏—Ç–µ."
        ]
        
        return random.choice(responses)
    
    def handle_pain(self, message, original_message):
        """–°—Ç–∞–¥–∏—è —É—Å–∏–ª–µ–Ω–∏—è –±–æ–ª–∏"""
        if len(original_message) < 5:
            return "–ù–∞–ø–∏—à–∏—Ç–µ —Ö–æ—Ç—è –±—ã –ø–∞—Ä—É —Å–ª–æ–≤. *–ß—Ç–æ –≤—ã —á—É–≤—Å—Ç–≤—É–µ—Ç–µ –∏–∑-–∑–∞ —ç—Ç–æ–π –ø—Ä–æ–±–ª–µ–º—ã?* –°—Ç—Ä–∞—Ö? –ë–µ—Å–ø–æ–º–æ—â–Ω–æ—Å—Ç—å? –ó–ª–æ—Å—Ç—å? –≠—Ç–æ –≤–∞–∂–Ω–æ."
        
        self.pain_points.append(original_message)
        self.stage = "SOLUTION"
        
        # –ü–µ—Ä–µ—Ö–æ–¥ –∫ –ø—Ä–æ–¥–∞–∂–µ —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ —Ä–µ—à–µ–Ω–∏–µ
        price = "1490 —Ä—É–±." if not self.discount_offered else "990 —Ä—É–±. (—Å–∫–∏–¥–∫–∞ 500 —Ä—É–±. —Ç–æ–ª—å–∫–æ —Å–µ–≥–æ–¥–Ω—è)"
        
        responses = [
            f"–ò–º–µ–Ω–Ω–æ —Ç–∞–∫, {self.user_name}. *–ë–æ–ª—å —Ä–µ–∞–ª—å–Ω–∞.* –ò —è –∑–Ω–∞—é, —á—Ç–æ –≤—ã —É—Å—Ç–∞–ª–∏ –æ—Ç —ç—Ç–æ–≥–æ. –•–æ—Ä–æ—à–∏–µ –Ω–æ–≤–æ—Å—Ç–∏: —ç—Ç–∞ –±–æ–ª—å *–∏–º–µ–µ—Ç —Ä–µ—à–µ–Ω–∏–µ.*\n\n–Ø –≥–æ—Ç–æ–≤–∞ –≤–∑—è—Ç—å—Å—è –∑–∞ –≤–∞—à—É —Å–∏—Ç—É–∞—Ü–∏—é. –°–¥–µ–ª–∞—é –ø–æ–ª–Ω—ã–π —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–π —Ä–∞—Å–∫–ª–∞–¥ –¢–∞—Ä–æ, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∫–∞–∂–µ—Ç:\n\n1Ô∏è‚É£ *–ö–û–†–ï–ù–¨ –ø—Ä–æ–±–ª–µ–º—ã* (–ø–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç)\n2Ô∏è‚É£ *–°–ö–†–´–¢–´–ï –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏* (—á—Ç–æ –≤—ã –Ω–µ –≤–∏–¥–∏—Ç–µ)\n3Ô∏è‚É£ *–ö–û–ù–ö–†–ï–¢–ù–´–ô –ø–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π* (—à–∞–≥–∏ –Ω–∞ 7 –¥–Ω–µ–π)\n4Ô∏è‚É£ *–ü–†–û–ì–ù–û–ó —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞* (—á—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—Å—è)\n\n*–°—Ç–æ–∏–º–æ—Å—Ç—å –∞–Ω–∞–ª–∏–∑–∞:* {price}\n\n*–ì–æ—Ç–æ–≤—ã –Ω–∞–∫–æ–Ω–µ—Ü-—Ç–æ —Ä–µ—à–∏—Ç—å —ç—Ç—É –ø—Ä–æ–±–ª–µ–º—É?* –ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ '–î–ê'.",
            f"–¢–æ—á–Ω–æ, {self.user_name}. *–ë–æ–ª—å –Ω–µ —É–π–¥–µ—Ç —Å–∞–º–∞.* –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –ø—Ä–æ–º–µ–¥–ª–µ–Ω–∏—è –¥–µ–ª–∞–µ—Ç –µ—ë —Å–∏–ª—å–Ω–µ–µ. –ù–æ –µ—Å—Ç—å –∏ —Ö–æ—Ä–æ—à–∞—è –Ω–æ–≤–æ—Å—Ç—å: —è –º–æ–≥—É *–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —ç—Ç—É –±–æ–ª—å*.\n\n–ú–æ–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ä–∞—Å–∫–ª–∞–¥ –¢–∞—Ä–æ –¥–∞—Å—Ç –≤–∞–º:\n\n‚ö° *–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É —Å–∏—Ç—É–∞—Ü–∏–∏* (–≤—Å–µ –∫–∞—Ä—Ç—ã –Ω–∞ —Å—Ç–æ–ª)\n‚ö° *–°—Ç—Ä–∞—Ç–µ–≥–∏—é –≤—ã—Ö–æ–¥–∞* (–ø–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω)\n‚ö° *–¢–∞–π–º–∏–Ω–≥ –∏–∑–º–µ–Ω–µ–Ω–∏–π* (–∫–æ–≥–¥–∞ —á—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç)\n‚ö° *–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Ç–æ—á–∫–∏* (–∫–∞–∫ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å)\n\n*–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏—è –≤ —Ä–µ—à–µ–Ω–∏–µ:* {price}\n\n*–•–≤–∞—Ç–∏—Ç —Å—Ç—Ä–∞–¥–∞—Ç—å.* –ù–∞–ø–∏—à–∏—Ç–µ '–•–û–ß–£ –†–ï–®–ï–ù–ò–ï'.",
            f"–ò–º–µ–Ω–Ω–æ –æ–± —ç—Ç–æ–º —è –∏ –¥—É–º–∞–ª–∞, {self.user_name}. *–ë–æ–ª—å –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç—Å—è.* –ù–æ —Å–∞–º–æ–µ –≤—Ä–µ–º—è *–ø—Ä–µ—Ä–≤–∞—Ç—å —ç—Ç–æ—Ç —Ü–∏–∫–ª.*\n\n–Ø –ø—Ä–µ–¥–ª–∞–≥–∞—é –Ω–µ –ø—Ä–æ—Å—Ç–æ —Ä–∞—Å–∫–ª–∞–¥, –∞ *—Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫—É—é —Å–µ—Å—Å–∏—é* —Å –∫–∞—Ä—Ç–∞–º–∏ –¢–∞—Ä–æ. –ú—ã –Ω–∞–π–¥–µ–º:\n\nüîç *–¢–æ—á–∫—É –≤—Ö–æ–¥–∞* (—Å —á–µ–≥–æ –Ω–∞—á–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è)\nüéØ *–ö–ª—é—á–µ–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ* (—Å–∞–º—ã–π –≤–∞–∂–Ω—ã–π —à–∞–≥)\nüìà *–ú–µ—Ç—Ä–∏–∫–∏ —É–ª—É—á—à–µ–Ω–∏—è* (–∫–∞–∫ –ø–æ–Ω—è—Ç—å, —á—Ç–æ —Å—Ç–∞–ª–æ –ª—É—á—à–µ)\nüõ°Ô∏è *–ó–∞—â–∏—Ç—É –æ—Ç —Ä–µ—Ü–∏–¥–∏–≤–∞* (–∫–∞–∫ –Ω–µ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø—Ä–æ–±–ª–µ–º–µ)\n\n*–°—Ç–æ–∏–º–æ—Å—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏:* {price}\n\n*–†–µ—à–∞–µ–º –ø—Ä–æ–±–ª–µ–º—É —Ä–∞–∑ –∏ –Ω–∞–≤—Å–µ–≥–¥–∞?* –ù–∞–ø–∏—à–∏—Ç–µ '–ì–û–¢–û–í –†–ï–®–ê–¢–¨'."
        ]
        
        # –°–æ–∑–¥–∞–µ–º —Å—Ä–æ—á–Ω–æ—Å—Ç—å
        if not self.urgency_created:
            responses = [r + f"\n\n‚è∞ *–í–Ω–∏–º–∞–Ω–∏–µ:* –£ –º–µ–Ω—è —Å–µ–π—á–∞—Å –µ—Å—Ç—å –æ–∫–Ω–æ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è. –ï—Å–ª–∏ –æ–ø–ª–∞—Ç–∏—Ç–µ –≤ –±–ª–∏–∂–∞–π—à–∏–µ 2 —á–∞—Å–∞ - —Å–¥–µ–ª–∞—é —Ä–∞—Å–∫–ª–∞–¥ —É–∂–µ —Å–µ–≥–æ–¥–Ω—è –≤–µ—á–µ—Ä–æ–º." for r in responses]
            self.urgency_created = True
        
        return random.choice(responses)
    
    def handle_solution(self, message):
        """–°—Ç–∞–¥–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Ä–µ—à–µ–Ω–∏—è"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≥–ª–∞—Å–∏–µ
        agreement_keywords = ['–¥–∞', '—Ö–æ—á—É', '–≥–æ—Ç–æ–≤', '—Å–æ–≥–ª–∞—Å', '–∫—É–ø–ª—é', '–æ–ø–ª–∞—Ç', '–∑–∞–∫–∞–∑', '–Ω–∞—á–∏–Ω']
        objection_keywords = ['–¥–æ—Ä–æ–≥', '–Ω–µ —É–≤–µ—Ä–µ–Ω', '—Å–æ–º–Ω–µ–≤–∞—é—Å—å', '–ø–æ–¥—É–º–∞', '—Å—Ç—Ä–∞—à–Ω', '–±–æ—é—Å—å', '–Ω–µ –≤–µ—Ä', '–ø–æ–∑–∂–µ', '–Ω–µ—Ç ']
        
        if any(keyword in message for keyword in agreement_keywords):
            self.stage = "CLOSE"
            payment_url = "https://yoomoney.ru/to/4100111234567890"  # –ó–ê–ú–ï–ù–ò–¢–ï!
            
            price = "1490 —Ä—É–±." if not self.discount_offered else "990 —Ä—É–±."
            discount_note = "\nüéÅ *–°–ö–ò–î–ö–ê 500 –†–£–ë.* –¥–µ–π—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ —Å–µ–≥–æ–¥–Ω—è!" if self.discount_offered else ""
            
            return f"*–ü–†–ê–í–ò–õ–¨–ù–û–ï –†–ï–®–ï–ù–ò–ï, {self.user_name.upper()}!* üëè\n\n–í—ã —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–¥–µ–ª–∞–ª–∏ –≤—ã–±–æ—Ä –≤ –ø–æ–ª—å–∑—É —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã, –∞ –Ω–µ –µ—ë –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏—è.\n\n*–®–ê–ì –ö –û–ü–õ–ê–¢–ï:*\n1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ: {payment_url}\n2. –û–ø–ª–∞—Ç–∏—Ç–µ {price}{discount_note}\n3. –ü—Ä–∏—à–ª–∏—Ç–µ –º–Ω–µ —Å–∫—Ä–∏–Ω—à–æ—Ç —á–µ–∫–∞\n4. –ü–æ–ª—É—á–∏—Ç–µ —Ä–∞—Å–∫–ª–∞–¥ –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤\n\n*–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –Ω–∞—á–Ω—É —Ä–∞–±–æ—Ç—É –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ.*\n\n–ñ–¥—É –≤–∞—à —á–µ–∫! üí≥"
        
        elif any(keyword in message for keyword in objection_keywords):
            self.stage = "OBJECTION"
            self.objections.append(message)
            return self.handle_objection(message)
        
        else:
            # –ü–æ–≤—Ç–æ—Ä—è–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å –±–æ–ª—å—à–µ–π –Ω–∞—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å—é
            self.attempts += 1
            
            if self.attempts >= 3 and not self.discount_offered:
                self.discount_offered = True
                return f"*{self.user_name}, —è –≤–∏–∂—É –≤–∞—à–∏ —Å–æ–º–Ω–µ–Ω–∏—è.* –ü–æ–Ω–∏–º–∞—é. –î–∞–≤–∞–π—Ç–µ —Å–¥–µ–ª–∞–µ–º —Ç–∞–∫:\n\n*–°–ö–ò–î–ö–ê 500 –†–£–ë. –¢–û–õ–¨–ö–û –î–õ–Ø –í–ê–°*\n\n–í–º–µ—Å—Ç–æ 1490 —Ä—É–±. ‚Üí *990 —Ä—É–±.*\n\n–ü–æ—á–µ–º—É? –ü–æ—Ç–æ–º—É —á—Ç–æ —è —É–≤–µ—Ä–µ–Ω–∞ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ. –ù–∞—Å—Ç–æ–ª—å–∫–æ —É–≤–µ—Ä–µ–Ω–∞, —á—Ç–æ –≥–æ—Ç–æ–≤–∞ –≤–∑—è—Ç—å –Ω–∞ —Å–µ–±—è —á–∞—Å—Ç—å —Ä–∏—Å–∫–∞.\n\n*–ù–û:* –°–∫–∏–¥–∫–∞ –¥–µ–π—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ 60 –º–∏–Ω—É—Ç.\n\n*–ò–¥–µ—Ç–µ –Ω–∞ —Ä–∏—Å–∫?* –ù–∞–ø–∏—à–∏—Ç–µ '–î–ê –°–û –°–ö–ò–î–ö–û–ô'."
            
            responses = [
                f"{self.user_name}, —è –∑–∞–¥–∞–º –≤–∞–º –ø—Ä—è–º–æ–π –≤–æ–ø—Ä–æ—Å: *–í—ã —Ö–æ—Ç–∏—Ç–µ —Ä–µ—à–∏—Ç—å —ç—Ç—É –ø—Ä–æ–±–ª–µ–º—É –∏–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∂–∏—Ç—å —Å –Ω–µ–π?*\n\n–ö–∞–∂–¥—ã–π –¥–µ–Ω—å –±–µ–∑–¥–µ–π—Å—Ç–≤–∏—è —Å—Ç–æ–∏—Ç –≤–∞–º –±–æ–ª—å—à–µ, —á–µ–º 1490 —Ä—É–±. –ü–æ–≤–µ—Ä—å—Ç–µ.\n\n*–¢–∞–∫ —á—Ç–æ –≤—ã–±–∏—Ä–∞–π—Ç–µ:* —Ä–µ—à–µ–Ω–∏–µ –∏–ª–∏ —Å—Ç–∞—Ç—É—Å-–∫–≤–æ?",
                f"–°–ª—É—à–∞–π—Ç–µ, {self.user_name}. –Ø –Ω–µ —Ç—Ä–∞—á—É –≤–∞—à–µ –≤—Ä–µ–º—è –∑—Ä—è. –ò –≤—ã –Ω–µ –¥–æ–ª–∂–Ω—ã —Ç—Ä–∞—Ç–∏—Ç—å —Å–≤–æ—ë. *–≠—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç.* 2573 –∫–ª–∏–µ–Ω—Ç–∞ —É–∂–µ –¥–æ–∫–∞–∑–∞–ª–∏.\n\n*–ü—Ä–æ—Å—Ç–æ–µ '–î–ê' –æ—Ç–¥–µ–ª—è–µ—Ç –≤–∞—Å –æ—Ç —Ä–µ—à–µ–Ω–∏—è.*\n\n–ß—Ç–æ –≤—ã–±–∏—Ä–∞–µ—Ç–µ?",
                f"{self.user_name}, –¥–∞–≤–∞–π—Ç–µ –Ω–∞—á–∏—Å—Ç–æ—Ç—É. –ï—Å–ª–∏ –±—ã —ç—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–ª–æ, —è –±—ã –Ω–µ –∑–∞–Ω–∏–º–∞–ª–∞—Å—å —ç—Ç–∏–º 10 –ª–µ—Ç. *–Ø –¥–∞—é –≥–∞—Ä–∞–Ω—Ç–∏—é:* –µ—Å–ª–∏ –ø–æ—Å–ª–µ —Ä–∞—Å–∫–ª–∞–¥–∞ –≤—ã —Å–∫–∞–∂–µ—Ç–µ, —á—Ç–æ –Ω–µ –ø–æ–ª—É—á–∏–ª–∏ —Ü–µ–Ω–Ω–æ—Å—Ç–∏ - –≤–µ—Ä–Ω—É –¥–µ–Ω—å–≥–∏.\n\n*–ü–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–Ω—Å:* –î–ê –∏–ª–∏ –Ω–µ—Ç?"
            ]
            
            return random.choice(responses)
    
    def handle_objection(self, message):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–π"""
        if '–¥–æ—Ä–æ–≥' in message:
            responses = [
                f"–ü–æ–Ω–∏–º–∞—é, {self.user_name}. –î–∞–≤–∞–π—Ç–µ –ø–æ—Å—á–∏—Ç–∞–µ–º:\n\n*–ß—Ç–æ —Å—Ç–æ–∏—Ç –≤–∞—à–∞ –ø—Ä–æ–±–ª–µ–º–∞ –≤ –¥–µ–Ω—å–≥–∞—Ö?*\n\n–ï—Å–ª–∏ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞ - —Å–∫–æ–ª—å–∫–æ –≤—ã —Ç–µ—Ä—è–µ—Ç–µ –≤ –º–µ—Å—è—Ü?\n–ï—Å–ª–∏ –æ—Ç–Ω–æ—à–µ–Ω–∏—è - —Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç —Ä–∞–∑–≤–æ–¥?\n–ï—Å–ª–∏ –∑–¥–æ—Ä–æ–≤—å–µ - —Å–∫–æ–ª—å–∫–æ —Å—Ç–æ—è—Ç –ª–µ–∫–∞—Ä—Å—Ç–≤–∞?\n\n1490 —Ä—É–±. vs –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø–æ—Ç–µ—Ä–∏. –í—ã–±–∏—Ä–∞–π—Ç–µ.",
                f"{self.user_name}, 1490 —Ä—É–±. - —ç—Ç–æ –Ω–µ —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞—Å–∫–ª–∞–¥–∞. –≠—Ç–æ *–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è –≤ –≤—ã—Ö–æ–¥ –∏–∑ –ø—Ä–æ–±–ª–µ–º—ã.*\n\n–°–∫–æ–ª—å–∫–æ –≤—ã —É–∂–µ –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏ –Ω–∞ —ç—Ç—É –ø—Ä–æ–±–ª–µ–º—É? –í—Ä–µ–º–µ–Ω–∏, –Ω–µ—Ä–≤–æ–≤, –¥–µ–Ω–µ–≥?\n\n*1490 —Ä—É–±. —á—Ç–æ–±—ã –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —É—Ç–µ—á–∫—É.* –†–∞–∑—É–º–Ω–æ?",
                f"–•–æ—Ä–æ—à–æ, {self.user_name}. –î–∞–≤–∞–π—Ç–µ –ø–æ-–¥—Ä—É–≥–æ–º—É:\n\n–°–∫–æ–ª—å–∫–æ –≤—ã —Ç—Ä–∞—Ç–∏—Ç–µ –Ω–∞ –∫–æ—Ñ–µ –≤ –º–µ—Å—è—Ü? 2000 —Ä—É–±?\n–ù–∞ —Å–∏–≥–∞—Ä–µ—Ç—ã? 3000 —Ä—É–±?\n–ù–∞ –Ω–µ–Ω—É–∂–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏? 5000 —Ä—É–±?\n\n*–ü–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç–µ 1490 —Ä—É–±. —Å –±–µ—Å–ø–æ–ª–µ–∑–Ω–æ–≥–æ –Ω–∞ –ø–æ–ª–µ–∑–Ω–æ–µ.*"
            ]
            
            if not self.discount_offered:
                self.discount_offered = True
                responses = [r + f"\n\n*–õ–ê–î–ù–û.* –°–¥–µ–ª–∞—é –¥–ª—è –≤–∞—Å –∑–∞ 990 —Ä—É–±. –¢–æ–ª—å–∫–æ –ø–æ—Ç–æ–º—É —á—Ç–æ –≤–∏–∂—É - –≤–∞–º –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω—É–∂–Ω–æ –ø–æ–º–æ—á—å.\n\n*–ò–¥–µ—Ç–µ –Ω–∞ —Å–¥–µ–ª–∫—É?* –ù–∞–ø–∏—à–∏—Ç–µ '–î–ê –ó–ê 990'." for r in responses]
            
        elif '–Ω–µ —É–≤–µ—Ä' in message or '—Å–æ–º–Ω–µ–≤–∞—é—Å—å' in message:
            responses = [
                f"{self.user_name}, —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –ø—Ä–∏—Ö–æ–¥–∏—Ç –ø–æ—Å–ª–µ –¥–µ–π—Å—Ç–≤–∏—è. –ù–µ –Ω–∞–æ–±–æ—Ä–æ—Ç.\n\n–Ø —Å–¥–µ–ª–∞–ª–∞ 2573 —Ä–∞—Å–∫–ª–∞–¥–∞. –¢–æ—á–Ω–æ –∑–Ω–∞—é, —á—Ç–æ –¥–µ–ª–∞—é.\n\n*–í–∞—à —Ä–∏—Å–∫:* 1490 —Ä—É–±.\n*–ú–æ–π —Ä–∏—Å–∫:* —Ä–µ–ø—É—Ç–∞—Ü–∏—è 10 –ª–µ—Ç.\n\n–ö—Ç–æ —Ä–∏—Å–∫—É–µ—Ç –±–æ–ª—å—à–µ?",
                f"–°–ª—É—à–∞–π—Ç–µ. –Ø –Ω–µ –ø—Ä–æ—à—É —Å–ª–µ–ø–æ –≤–µ—Ä–∏—Ç—å. –Ø –ø—Ä–µ–¥–ª–∞–≥–∞—é *–ø—Ä–æ–≤–µ—Ä–∏—Ç—å.*\n\n*–ì–∞—Ä–∞–Ω—Ç–∏—è:* –µ—Å–ª–∏ –ø–æ—Å–ª–µ —Ä–∞—Å–∫–ª–∞–¥–∞ —Å–∫–∞–∂–µ—Ç–µ '–Ω–µ —Å—Ç–æ–∏—Ç 1490 —Ä—É–±.' - –≤–µ—Ä–Ω—É –¥–µ–Ω—å–≥–∏.\n\n*–°—Ç—Ä–∞—Ö–æ–≤–∞—Ç—å –≤–∞—à–∏ —Ä–∏—Å–∫–∏ –≥–æ—Ç–æ–≤. –í—ã?*",
                f"{self.user_name}, –≤—Å–µ –º–æ–∏ –∫–ª–∏–µ–Ω—Ç—ã –Ω–∞—á–∏–Ω–∞–ª–∏ —Å —Å–æ–º–Ω–µ–Ω–∏–π. –°–µ–π—á–∞—Å –æ–Ω–∏ –ø—Ä–∏—Ö–æ–¥—è—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ.\n\n*–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –µ—Å—Ç—å.* –û—Ç–∑—ã–≤—ã –µ—Å—Ç—å. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –µ—Å—Ç—å.\n\n–û—Å—Ç–∞–ª–æ—Å—å —Ç–æ–ª—å–∫–æ *—Ä–µ—à–∏—Ç—å—Å—è.*"
            ]
            
        elif '—Å—Ç—Ä–∞—à–Ω' in message or '–±–æ—é—Å—å' in message:
            responses = [
                f"–°—Ç—Ä–∞—Ö - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, {self.user_name}. –°—Ç—Ä–∞—à–Ω–æ –º–µ–Ω—è—Ç—å. –ù–æ –µ—â—ë —Å—Ç—Ä–∞—à–Ω–µ–µ - –Ω–µ –º–µ–Ω—è—Ç—å.\n\n*–ß—Ç–æ —Å—Ç—Ä–∞—à–Ω–µ–µ:* –∑–∞–ø–ª–∞—Ç–∏—Ç—å 1490 —Ä—É–±. –∏–ª–∏ –ø—Ä–æ–∂–∏—Ç—å –µ—â—ë –≥–æ–¥ —Å —ç—Ç–æ–π –ø—Ä–æ–±–ª–µ–º–æ–π?",
                f"–ü–æ–Ω–∏–º–∞—é —Å—Ç—Ä–∞—Ö, {self.user_name}. –ù–æ –ø—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ: —á–µ—Ä–µ–∑ –º–µ—Å—è—Ü –≤—ã –±—É–¥–µ—Ç–µ –∂–∞–ª–µ—Ç—å, —á—Ç–æ –Ω–µ —Å–¥–µ–ª–∞–ª–∏ —ç—Ç–æ–≥–æ —Å–µ–≥–æ–¥–Ω—è.\n\n*–°—Ç—Ä–∞—Ö –ø—Ä–æ–π–¥–µ—Ç.* –ü—Ä–æ–±–ª–µ–º–∞ - –Ω–µ—Ç.\n\n–í—ã–±–∏—Ä–∞–π—Ç–µ.",
                f"{self.user_name}, —è —Ç–æ–∂–µ –±–æ—é—Å—å. –ë–æ—é—Å—å, —á—Ç–æ –≤—ã —É–ø—É—Å—Ç–∏—Ç–µ —à–∞–Ω—Å —Ä–µ—à–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É.\n\n*–°—Ç—Ä–∞—Ö - –ø–ª–æ—Ö–æ–π —Å–æ–≤–µ—Ç—á–∏–∫.* –î–æ–≤–µ—Ä—å—Ç–µ—Å—å —Ü–∏—Ñ—Ä–∞–º: 2573 —É—Å–ø–µ—à–Ω—ã—Ö —Å–ª—É—á–∞—è.\n\n*–ü–µ—Ä–µ–±–æ–∏—Ç–µ —Å—Ç—Ä–∞—Ö. –ù–∞–ø–∏—à–∏—Ç–µ '–î–ê'.*"
            ]
            
        elif '–Ω–µ –≤–µ—Ä' in message:
            responses = [
                f"–ù–µ –Ω—É–∂–Ω–æ –≤–µ—Ä–∏—Ç—å –≤ –¢–∞—Ä–æ, {self.user_name}. *–ù—É–∂–Ω–æ –≤–µ—Ä–∏—Ç—å –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç.*\n\n2573 –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ–ª—É—á–∏–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –í—ã –±—É–¥–µ—Ç–µ 2574.\n\n*–í–µ—Ä–∞ –ø—Ä–∏–¥–µ—Ç –ø–æ—Å–ª–µ.* –°–Ω–∞—á–∞–ª–∞ - –¥–µ–π—Å—Ç–≤–∏–µ.",
                f"{self.user_name}, —è –Ω–µ –ø—Ä–æ—à—É –≤–µ—Ä–∏—Ç—å –≤ –º–∞–≥–∏—é. –Ø –ø—Ä–µ–¥–ª–∞–≥–∞—é *–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∞–Ω–∞–ª–∏–∑–∞.*\n\n–ö–∞—Ä—Ç—ã - –∫–∞–∫ —Ä–µ–Ω—Ç–≥–µ–Ω. –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç —Ç–æ, —á—Ç–æ –Ω–µ –≤–∏–¥–Ω–æ.\n\n*–ü—Ä–æ–≤–µ—Ä–∏—Ç—å?* –ò–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –≥–∞–¥–∞—Ç—å?",
                f"–•–æ—Ä–æ—à–æ. –ù–µ –≤–µ—Ä—å—Ç–µ. *–ü—Ä–æ—Å—Ç–æ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ.*\n\n*–ì–∞—Ä–∞–Ω—Ç–∏—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –¥–µ–Ω–µ–≥* –µ—Å–ª–∏ –Ω–µ –ø–æ–Ω—Ä–∞–≤–∏—Ç—Å—è.\n\n*–ß—Ç–æ —Ç–µ—Ä—è–µ—Ç–µ?* –ù–∏—á–µ–≥–æ.\n*–ß—Ç–æ –ø–æ–ª—É—á–∞–µ—Ç–µ?* –í–æ–∑–º–æ–∂–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ.\n\n*–†–∞–∑—É–º–Ω—ã–π —Ä–∏—Å–∫.*"
            ]
            
        elif '–ø–æ–¥—É–º–∞' in message or '–ø–æ–∑–∂–µ' in message:
            # –°–æ–∑–¥–∞–µ–º —Å—Ä–æ—á–Ω–æ—Å—Ç—å
            deadline = (datetime.now() + timedelta(hours=2)).strftime("%H:%M")
            responses = [
                f"{self.user_name}, '–ø–æ–¥—É–º–∞—é' = '–Ω–µ—Ç, –Ω–æ –Ω–µ —Ö–æ—á—É –≥–æ–≤–æ—Ä–∏—Ç—å –ø—Ä—è–º–æ'.\n\n*–û–∫–Ω–æ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è:* –¥–æ {deadline}\n*–¶–µ–Ω–∞ —Å–µ–≥–æ–¥–Ω—è:* 1490 —Ä—É–±.\n*–¶–µ–Ω–∞ –∑–∞–≤—Ç—Ä–∞:* 1990 —Ä—É–±. (–ø–æ–≤—ã—à–∞—é)\n\n*–†–µ—à–∞–π—Ç–µ —Å–µ–π—á–∞—Å.*",
                f"–ü–æ–Ω–∏–º–∞—é, {self.user_name}. –ù–æ –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ –±—É–¥–µ—Ç –∂–¥–∞—Ç—å, –ø–æ–∫–∞ –≤—ã –ø–æ–¥—É–º–∞–µ—Ç–µ.\n\n*–°–ø–µ—Ü—É—Å–ª–æ–≤–∏–µ:* –æ–ø–ª–∞—Ç–∞ —Å–µ–π—á–∞—Å - —Ä–∞—Å–∫–ª–∞–¥ —Å–µ–≥–æ–¥–Ω—è. –ó–∞–≤—Ç—Ä–∞ - –æ—á–µ—Ä–µ–¥—å –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é –Ω–µ–¥–µ–ª—é.\n\n*–£—Å–ø–µ—Ç—å –∏–ª–∏ –∂–¥–∞—Ç—å?*",
                f"{self.user_name}, –æ—Ç–∫–ª–∞–¥—ã–≤–∞–Ω–∏–µ = —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã.\n\n*–°–µ–π—á–∞—Å:* 1490 —Ä—É–±. ‚Üí —Ä–µ—à–µ–Ω–∏–µ\n*–ü–æ–∑–∂–µ:* —Ç–µ –∂–µ 1490 —Ä—É–±. + –µ—â—ë –Ω–µ–¥–µ–ª—è –º—É—á–µ–Ω–∏–π\n\n*–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –ø—Ä–æ—Å—Ç–∞—è.*"
            ]
            
        else:
            responses = [
                f"{self.user_name}, —è –Ω–µ –ø–æ–Ω–∏–º–∞—é –≤–∞—à–µ–≥–æ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è. –î–∞–≤–∞–π—Ç–µ –ø—Ä–æ—â–µ:\n\n*–í—ã —Ö–æ—Ç–∏—Ç–µ —Ä–µ—à–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É –∏–ª–∏ –Ω–µ—Ç?*\n\n–ï—Å–ª–∏ –¥–∞ - 1490 —Ä—É–±. –∏ –º—ã –Ω–∞—á–∏–Ω–∞–µ–º.\n–ï—Å–ª–∏ –Ω–µ—Ç - –ø—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –∂–∏—Ç—å –∫–∞–∫ –∂–∏–ª–∏.\n\n–í—ã–±–∏—Ä–∞–π—Ç–µ.",
                f"–°–ª—É—à–∞–π—Ç–µ, {self.user_name}. –Ø –∑–¥–µ—Å—å —á—Ç–æ–±—ã –ø–æ–º–æ—á—å, –∞ –Ω–µ —É–≥–æ–≤–∞—Ä–∏–≤–∞—Ç—å.\n\n*–§–∞–∫—Ç:* —É –≤–∞—Å –ø—Ä–æ–±–ª–µ–º–∞.\n*–§–∞–∫—Ç:* —è –º–æ–≥—É –ø–æ–º–æ—á—å.\n*–¶–µ–Ω–∞:* 1490 —Ä—É–±.\n\n*–î–ê –∏–ª–∏ –ù–ï–¢?*\n\n–ù–∏–∫–∞–∫–∏—Ö '–Ω–æ' –∏ '–µ—Å–ª–∏'.",
                f"{self.user_name}, –≤—Ä–µ–º—è - –¥–µ–Ω—å–≥–∏. –í–∞—à–µ –∏ –º–æ—ë.\n\n*–ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:* 1490 —Ä—É–±. –∑–∞ —Ä–µ—à–µ–Ω–∏–µ.\n\n*–û—Ç–≤–µ—Ç—å—Ç–µ –ø—Ä—è–º–æ:* –±–µ—Ä–µ—Ç–µ –∏–ª–∏ –Ω–µ—Ç?\n\n(–ï—Å–ª–∏ –Ω–µ—Ç - —Å–∫–∞–∂–∏—Ç–µ '–ù–ï–¢'. –Ø –ø–æ–π–º—É.)"
            ]
        
        self.stage = "SOLUTION"
        return random.choice(responses)
    
    def handle_close(self, message):
        """–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–∂–∏"""
        if '–æ–ø–ª–∞—Ç' in message or '–ø–µ—Ä–µ–≤–µ–ª' in message or '—á–µ–∫–∞–Ω' in message or '—Å–∫—Ä–∏–Ω—à–æ—Ç' in message:
            # –ü—Ä–æ–¥–∞–∂–∞ —Å–æ—Å—Ç–æ—è–ª–∞—Å—å!
            sales_data['conversions'] += 1
            sales_data['revenue'] += 1490 if not self.discount_offered else 990
            
            logger.info(f"üí∞ –ü–†–û–î–ê–ñ–ê –°–û–°–¢–û–Ø–õ–ê–°–¨! {self.chat_id} - {self.user_name}")
            
            # –°–∏–º—É–ª—è—Ü–∏—è —Ä–∞–±–æ—Ç—ã –Ω–∞–¥ —Ä–∞—Å–∫–ª–∞–¥–æ–º
            return f"*–ü–†–ò–ù–Ø–¢–û, {self.user_name.upper()}!* üéâ\n\n–í–∏–∂—É –æ–ø–ª–∞—Ç—É. –ù–∞—á–∏–Ω–∞—é —Ä–∞–±–æ—Ç—É –Ω–∞–¥ –≤–∞—à–∏–º —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–º —Ä–∞—Å–∫–ª–∞–¥–æ–º.\n\n*–¢–∞–π–º–∏–Ω–≥:*\n‚è∞ 19:00 - –Ω–∞—á–∏–Ω–∞—é –∞–Ω–∞–ª–∏–∑ –∫–∞—Ä—Ç\n‚è∞ 20:30 - —Å–æ—Å—Ç–∞–≤–ª—è—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é\n‚è∞ 21:30 - –≥–æ—Ç–æ–≤–ª—é —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç\n‚è∞ 22:00 - –≤—ã –ø–æ–ª—É—á–∏—Ç–µ —Ä–∞—Å–∫–ª–∞–¥\n\n*–ñ–¥–∏—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π.* –£–∂–µ —á—É–≤—Å—Ç–≤—É—é - –∫–∞—Ä—Ç—ã –ø–æ–∫–∞–∂—É—Ç –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –≤–µ—â–∏..."
        
        # –ï—Å–ª–∏ –µ—â—ë –Ω–µ –æ–ø–ª–∞—Ç–∏–ª, –Ω–∞–ø–æ–º–∏–Ω–∞–µ–º
        reminders = [
            f"{self.user_name}, –∂–¥—É –≤–∞—à—É –æ–ø–ª–∞—Ç—É. –°—Å—ã–ª–∫–∞: https://yoomoney.ru/to/4100111234567890\n\n*–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ:* –æ–∫–Ω–æ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –¥–æ 22:00.",
            f"–ï—â—ë –∑–¥–µ—Å—å, {self.user_name}? –û–ø–ª–∞—á–∏–≤–∞–π—Ç–µ, –ø–æ–∫–∞ –µ—Å—Ç—å –º–µ—Å—Ç–æ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è.\n\n–°—Å—ã–ª–∫–∞: https://yoomoney.ru/to/4100111234567890\n\n*–¶–µ–Ω–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞ —Ç–æ–ª—å–∫–æ 60 –º–∏–Ω—É—Ç.*",
            f"{self.user_name}, —Å–º–æ—Ç—Ä—é - –æ–ø–ª–∞—Ç—ã –µ—â—ë –Ω–µ—Ç. *–ü—Ä–æ–±–ª–µ–º–∞ –Ω–µ —Ä–µ—à–∏—Ç—Å—è —Å–∞–º–∞.*\n\n–ü–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –∏ –æ–ø–ª–∞—á–∏–≤–∞–π—Ç–µ: https://yoomoney.ru/to/4100111234567890\n\n*–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ç–æ–ª—á–æ–∫.*"
        ]
        
        return random.choice(reminders)

# –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
sales_managers = {}

def get_sales_manager(chat_id, user_name):
    """–ü–æ–ª—É—á–∞–µ—Ç –∏–ª–∏ —Å–æ–∑–¥–∞–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ø—Ä–æ–¥–∞–∂ –¥–ª—è —á–∞—Ç–∞"""
    if chat_id not in sales_managers:
        sales_managers[chat_id] = SalesManager(chat_id, user_name)
    return sales_managers[chat_id]

def send_message_with_strategy(chat_id, text, delay=True):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–æ–¥–∞—é—â–µ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–µ–π"""
    try:
        if delay:
            # –ó–∞–¥–µ—Ä–∂–∫–∞ –∫–∞–∫ —É –∂–∏–≤–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
            delay_seconds = random.randint(30, 90)  # 30-90 —Å–µ–∫—É–Ω–¥
            time.sleep(delay_seconds)
        
        url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
        payload = {
            'chat_id': chat_id,
            'text': text,
            'parse_mode': 'Markdown'
        }
        
        logger.info(f"üí∞ –û—Ç–ø—Ä–∞–≤–ª—è—é –ø—Ä–æ–¥–∞—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ {chat_id}")
        response = requests.post(url, json=payload, timeout=10)
        
        if response.status_code != 200:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {response.text}")
        else:
            logger.info(f"‚úÖ –ü—Ä–æ–¥–∞—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ")
        
        return response.json()
    except Exception as e:
        logger.error(f"üö® –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ: {e}")
        return None

def schedule_follow_up(chat_id, user_name):
    """–ü–ª–∞–Ω–∏—Ä—É–µ—Ç follow-up –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–ø–∞–ª"""
    def follow_up():
        # –ñ–¥–µ–º 10 –º–∏–Ω—É—Ç
        time.sleep(600)
        
        if chat_id in sales_managers:
            manager = sales_managers[chat_id]
            # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ—Ç–≤–µ—á–∞–ª 10+ –º–∏–Ω—É—Ç
            if time.time() - manager.last_message_time > 590:
                follow_ups = [
                    f"{user_name}, –≤—ã –µ—â—ë –∑–¥–µ—Å—å? *–ü—Ä–æ–±–ª–µ–º–∞ –Ω–µ —Ä–µ—à–∏—Ç—Å—è, –µ—Å–ª–∏ –æ—Ç –Ω–µ—ë —É–±–µ–≥–∞—Ç—å.*\n\n–í–µ—Ä–Ω—ë–º—Å—è –∫ —Ä–∞–∑–≥–æ–≤–æ—Ä—É?",
                    f"–í–∏–∂—É, –≤—ã –ø—Ä–æ–ø–∞–ª–∏, {user_name}. *–≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ - —Å—Ç—Ä–∞—Ö–æ–≤–∞—Ç—å.* –ù–æ –ø—Ä–æ–±–ª–µ–º–∞ –Ω–∏–∫—É–¥–∞ –Ω–µ –¥–µ–Ω–µ—Ç—Å—è.\n\n–ì–æ—Ç–æ–≤—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å?",
                    f"{user_name}, —Ç–∏—à–∏–Ω–∞. *–ü–æ–Ω–∏–º–∞—é.* –ü—Ä–∏–Ω—è—Ç—å —Ä–µ—à–µ–Ω–∏–µ —Å–ª–æ–∂–Ω–æ.\n\n–î–∞–≤–∞–π—Ç–µ —Ö–æ—Ç—è –±—ã –ø–æ–≥–æ–≤–æ—Ä–∏–º. –ß—Ç–æ –≤–∞—Å –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç?"
                ]
                
                send_message_with_strategy(chat_id, random.choice(follow_ups), delay=False)
    
    thread = threading.Thread(target=follow_up)
    thread.daemon = True
    thread.start()

@app.route('/webhook', methods=['POST'])
def webhook():
    """–û—Å–Ω–æ–≤–Ω–æ–π webhook –æ—Ç Telegram"""
    try:
        data = request.get_json()
        
        if not data:
            return jsonify({"status": "error", "message": "No data"}), 400
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
        if 'message' in data and 'text' in data['message']:
            message_text = data['message']['text'].strip()
            chat_id = data['message']['chat']['id']
            user_name = data['message']['from'].get('first_name', '–∫–ª–∏–µ–Ω—Ç')
            
            logger.info(f"üë§ {user_name}: {message_text}")
            
            # –ü–æ–ª—É—á–∞–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ø—Ä–æ–¥–∞–∂ –¥–ª—è —ç—Ç–æ–≥–æ —á–∞—Ç–∞
            manager = get_sales_manager(chat_id, user_name)
            
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start
            if message_text.lower().startswith('/start'):
                # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞
                sales_managers[chat_id] = SalesManager(chat_id, user_name)
                manager = sales_managers[chat_id]
                
                # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–¥–∞–∂—É
                response = manager.process_message("/start")
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π (–∏–º–∏—Ç–∞—Ü–∏—è –ø–µ—á–∞—Ç–∏)
                time.sleep(random.randint(2, 5))
                send_message_with_strategy(chat_id, response, delay=False)
                
                # –ü–ª–∞–Ω–∏—Ä—É–µ–º follow-up
                schedule_follow_up(chat_id, user_name)
            
            else:
                # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
                response = manager.process_message(message_text)
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π –∫–∞–∫ –∂–∏–≤–æ–π —á–µ–ª–æ–≤–µ–∫
                def send_response():
                    time.sleep(random.randint(30, 90))  # –ñ–¥–µ–º 30-90 —Å–µ–∫—É–Ω–¥
                    send_message_with_strategy(chat_id, response, delay=False)
                    
                    # –ü–ª–∞–Ω–∏—Ä—É–µ–º follow-up –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                    if manager.stage != "CLOSE" and manager.attempts > 1:
                        schedule_follow_up(chat_id, user_name)
                
                # –ó–∞–ø—É—Å–∫–∞–µ–º –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
                thread = threading.Thread(target=send_response)
                thread.daemon = True
                thread.start()
            
            return jsonify({"status": "success", "processed": True}), 200
        
        return jsonify({"status": "success", "processed": False}), 200
        
    except Exception as e:
        logger.error(f"üö® –û—à–∏–±–∫–∞ –≤ webhook: {e}")
        return jsonify({"status": "error", "message": str(e)}), 400

@app.route('/stats', methods=['GET'])
def stats():
    """–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–¥–∞–∂"""
    return jsonify({
        "status": "active",
        "sales_data": sales_data,
        "conversion_rate": f"{(sales_data['conversions'] / sales_data['total_contacts'] * 100 if sales_data['total_contacts'] > 0 else 0):.1f}%",
        "active_sales": len(sales_managers),
        "bot": "@Tarotyour_bot",
        "description": "–ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π –ø—Ä–æ–¥–∞—é—â–∏–π –±–æ—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä"
    })

@app.route('/set_webhook', methods=['GET'])
def set_webhook():
    """–£—Å—Ç–∞–Ω–æ–≤–∫–∞ webhook"""
    try:
        if not BOT_TOKEN:
            return jsonify({"error": "BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"}), 400
        
        webhook_url = request.host_url.rstrip('/') + '/webhook'
        logger.info(f"üîó –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é webhook: {webhook_url}")
        
        telegram_url = f"https://api.telegram.org/bot{BOT_TOKEN}/setWebhook"
        response = requests.post(telegram_url, json={'url': webhook_url}, timeout=10)
        
        return jsonify({
            "success": response.status_code == 200,
            "webhook_url": webhook_url,
            "response": response.json() if response.status_code == 200 else response.text
        }), 200
        
    except Exception as e:
        logger.error(f"üö® –û—à–∏–±–∫–∞: {e}")
        return jsonify({"error": str(e)}), 400

@app.route('/')
def home():
    return jsonify({
        "status": "active",
        "bot": "@Tarotyour_bot",
        "description": "–ê–ì–†–ï–°–°–ò–í–ù–´–ô –ü–†–û–î–ê–Æ–©–ò–ô –ë–û–¢-–ú–ï–ù–ï–î–ñ–ï–†",
        "price": "1490 —Ä—É–±. (—Å–∫–∏–¥–∫–∞ –¥–æ 990 —Ä—É–±. –¥–ª—è —Å–æ–º–Ω–µ–≤–∞—é—â–∏—Ö—Å—è)",
        "strategy": "–ñ–µ—Å—Ç–∫–∞—è –≤–æ—Ä–æ–Ω–∫–∞ –ø—Ä–æ–¥–∞–∂: –ü—Ä–æ–±–ª–µ–º–∞ ‚Üí –ë–æ–ª—å ‚Üí –†–µ—à–µ–Ω–∏–µ ‚Üí –ó–∞–∫—Ä—ã—Ç–∏–µ",
        "conversion_tactics": ["–£—Å–∏–ª–µ–Ω–∏–µ –±–æ–ª–∏", "–°–æ–∑–¥–∞–Ω–∏–µ —Å—Ä–æ—á–Ω–æ—Å—Ç–∏", "–†–∞–±–æ—Ç–∞ —Å –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è–º–∏", "–ì–∞—Ä–∞–Ω—Ç–∏–∏", "Follow-up"]
    })

if __name__ == '__main__':
    port = int(os.environ.get('PORT', 10000))
    logger.info(f"üöÄ –ó–ê–ü–£–°–ö –ê–ì–†–ï–°–°–ò–í–ù–û–ì–û –ü–†–û–î–ê–Æ–©–ï–ì–û –ë–û–¢–ê –ù–ê –ü–û–†–¢–£ {port}")
    logger.info(f"üí∞ –°—Ç—Ä–∞—Ç–µ–≥–∏—è: –ñ–µ—Å—Ç–∫–∏–µ –ø—Ä–æ–¥–∞–∂–∏ —Å –≤–æ—Ä–æ–Ω–∫–æ–π")
    logger.info(f"üíµ –¶–µ–Ω–∞: 1490 —Ä—É–±. (990 —Ä—É–±. —Å–æ —Å–∫–∏–¥–∫–æ–π)")
    app.run(host='0.0.0.0', port=port, debug=False)

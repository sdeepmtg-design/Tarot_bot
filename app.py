from flask import Flask, request, jsonify
import os
import requests
import logging
import random
import time
import threading
import json
from datetime import datetime
from queue import Queue
import atexit

app = Flask(__name__)
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(name)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
BOT_TOKEN = os.environ.get('BOT_TOKEN')
if not BOT_TOKEN:
    logger.error("‚ùå BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")
    raise ValueError("BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è!")

# –§–∞–π–ª –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π
STATE_FILE = 'conversation_states.json'

# –û—á–µ—Ä–µ–¥—å —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏
message_queue = Queue()

# –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–∑ —Ñ–∞–π–ª–∞
def load_states():
    try:
        if os.path.exists(STATE_FILE):
            with open(STATE_FILE, 'r', encoding='utf-8') as f:
                return json.load(f)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–π: {e}")
    return {}

# –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ —Ñ–∞–π–ª
def save_states():
    try:
        with open(STATE_FILE, 'w', encoding='utf-8') as f:
            json.dump(conversations, f, ensure_ascii=False, indent=2)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π: {e}")

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è
conversations = load_states()

# –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
atexit.register(save_states)

def send_message_with_delay(chat_id, text, parse_mode='Markdown', delay_seconds=None):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π"""
    if delay_seconds is None:
        # –°–ª—É—á–∞–π–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –æ—Ç 60 –¥–æ 180 —Å–µ–∫—É–Ω–¥ (1-3 –º–∏–Ω—É—Ç—ã)
        delay_seconds = random.randint(60, 180)
    
    def send():
        time.sleep(delay_seconds)
        try:
            url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
            payload = {
                'chat_id': chat_id,
                'text': text,
                'parse_mode': parse_mode
            }
            
            logger.info(f"üì§ –û—Ç–ø—Ä–∞–≤–ª—è—é —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ {chat_id} (–∑–∞–¥–µ—Ä–∂–∫–∞ {delay_seconds} —Å–µ–∫)")
            response = requests.post(url, json=payload, timeout=10)
            
            if response.status_code != 200:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {response.text}")
            else:
                logger.info(f"‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ {chat_id}")
            
            return response.json()
        except Exception as e:
            logger.error(f"üö® –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ: {e}")
            return None
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
    thread = threading.Thread(target=send)
    thread.daemon = True
    thread.start()
    return thread

def get_conversation_state(chat_id):
    """–ü–æ–ª—É—á–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º"""
    if str(chat_id) not in conversations:
        conversations[str(chat_id)] = {
            'step': 'start',
            'question': '',
            'last_message_time': time.time(),
            'message_count': 0,
            'name': '',
            'interest_shown': False,
            'objections': [],
            'last_user_message': '',
            'last_bot_message': '',
            'conversation_history': [],
            'waiting_for_response': False,
            'scheduled_messages': []
        }
    return conversations[str(chat_id)]

def update_conversation_state(chat_id, updates):
    """–û–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞"""
    state = get_conversation_state(chat_id)
    state.update(updates)
    state['last_message_time'] = time.time()
    save_states()

def add_to_history(chat_id, role, message):
    """–î–æ–±–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞"""
    state = get_conversation_state(chat_id)
    if 'conversation_history' not in state:
        state['conversation_history'] = []
    
    state['conversation_history'].append({
        'role': role,
        'message': message,
        'timestamp': datetime.now().isoformat()
    })
    
    # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ 20 —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
    if len(state['conversation_history']) > 20:
        state['conversation_history'] = state['conversation_history'][-20:]
    
    save_states()

def analyze_conversation_flow(state):
    """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø–æ—Ç–æ–∫ –¥–∏–∞–ª–æ–≥–∞ –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥"""
    history = state.get('conversation_history', [])
    last_user_msg = state.get('last_user_message', '').lower()
    step = state.get('step', 'start')
    
    # –ï—Å–ª–∏ —ç—Ç–æ –Ω–∞—á–∞–ª–æ –¥–∏–∞–ª–æ–≥–∞
    if step == 'start' or state['message_count'] == 0:
        return "greeting"
    
    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–æ–ª—å–∫–æ —á—Ç–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏–ª –ø—Ä–æ–±–ª–µ–º—É
    if len(last_user_msg) > 20 and '–ø—Ä–æ–±–ª–µ–º' in last_user_msg or '—Å–∏—Ç—É–∞—Ü' in last_user_msg:
        return "acknowledge_problem"
    
    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ —Ü–µ–Ω–µ
    price_keywords = ['—Å–∫–æ–ª—å–∫–æ', '—Ü–µ–Ω–∞', '—Å—Ç–æ–∏–º–æ—Å—Ç—å', '–ø–ª–∞—Ç–Ω–æ', '–¥–µ–Ω—å–≥–∏', '—Ä—É–±–ª']
    if any(keyword in last_user_msg for keyword in price_keywords):
        return "discuss_price"
    
    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–º–Ω–µ–≤–∞–µ—Ç—Å—è
    doubt_keywords = ['–Ω–µ —É–≤–µ—Ä–µ–Ω', '—Å–æ–º–Ω–µ–≤–∞—é—Å—å', '—Å—Ç—Ä–∞—à–Ω–æ', '–±–æ—é—Å—å', '–Ω–µ –≤–µ—Ä—é', '—Å–æ–º–Ω–µ–Ω']
    if any(keyword in last_user_msg for keyword in doubt_keywords):
        return "handle_doubt"
    
    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–≥–ª–∞—à–∞–µ—Ç—Å—è
    agreement_keywords = ['–¥–∞–≤–∞–π', '—Ö–æ—á—É', '–Ω–∞—á–Ω–µ–º', '–≥–æ—Ç–æ–≤', '—Å–æ–≥–ª–∞—Å–µ–Ω', '–æ–∫–µ–π', '–æ–∫', '–¥–∞ ', '—Ö–æ—Ä–æ—à–æ']
    if any(keyword in last_user_msg for keyword in agreement_keywords) and len(last_user_msg) < 15:
        if state.get('interest_shown'):
            return "offer_payment"
        else:
            return "ask_for_details"
    
    # –ï—Å–ª–∏ –∫–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–≤–µ—Ç (–≤–µ—Ä–æ—è—Ç–Ω–æ, —Ä–µ–∞–∫—Ü–∏—è –Ω–∞ —á—Ç–æ-—Ç–æ)
    if len(last_user_msg) < 10:
        return "continue_conversation"
    
    # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é - —É–≥–ª—É–±–ª—è–µ–º —Ä–∞–∑–≥–æ–≤–æ—Ä
    return "deepen_conversation"

def generate_human_response(user_message, state):
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–π –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∏–∞–ª–æ–≥–∞"""
    user_message_lower = user_message.lower()
    step = state.get('step', 'start')
    flow = analyze_conversation_flow(state)
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    state['last_user_message'] = user_message
    add_to_history(state.get('chat_id'), 'user', user_message)
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ—Ç–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–æ—Ç–æ–∫–∞ –¥–∏–∞–ª–æ–≥–∞
    if flow == "greeting":
        responses = [
            "–ü—Ä–∏–≤–µ—Ç! üëã –Ø –ê–Ω–Ω–∞, –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ç–∞—Ä–æ–ª–æ–≥. –†–∞–¥–∞ –≤–∞—Å –≤–∏–¥–µ—Ç—å!\n\n–ö–∞–∫ —è –º–æ–≥—É –≤–∞–º –ø–æ–º–æ—á—å? –ú–æ–∂–µ—Ç, –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π —Ö–æ—Ç–µ–ª–æ—Å—å –±—ã –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç –∫–∞—Ä—Ç?",
            "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –ê–Ω–Ω–∞, –ø—Ä–∞–∫—Ç–∏–∫—É—é—â–∏–π —Ç–∞—Ä–æ–ª–æ–≥ —Å 8-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º. –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ, —á—Ç–æ –≤–∞—Å –ø—Ä–∏–≤–µ–ª–æ –∫–æ –º–Ω–µ —Å–µ–≥–æ–¥–Ω—è? –ï—Å—Ç—å –ª–∏ —Å–∏—Ç—É–∞—Ü–∏—è, –≤ –∫–æ—Ç–æ—Ä–æ–π –Ω—É–∂–Ω–∞ —è—Å–Ω–æ—Å—Ç—å?",
            "–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é! –ú–µ–Ω—è –∑–æ–≤—É—Ç –ê–Ω–Ω–∞, —è –ø–æ–º–æ–≥–∞—é –ª—é–¥—è–º –Ω–∞—Ö–æ–¥–∏—Ç—å –æ—Ç–≤–µ—Ç—ã —Å –ø–æ–º–æ—â—å—é –¢–∞—Ä–æ. –ß—Ç–æ –≤–∞—Å –±–µ—Å–ø–æ–∫–æ–∏—Ç –∏–ª–∏ –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –∂–∏–∑–Ω–∏?"
        ]
        state['step'] = 'introduction'
        
    elif flow == "acknowledge_problem":
        problem_keywords = {
            '–æ—Ç–Ω–æ—à–µ–Ω': [
                "–ü–æ–Ω–∏–º–∞—é, —á—Ç–æ –≤–æ–ø—Ä–æ—Å—ã –æ—Ç–Ω–æ—à–µ–Ω–∏–π –º–æ–≥—É—Ç –±—ã—Ç—å –æ—á–µ–Ω—å —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º–∏... –ö–∞—Ä—Ç—ã –¢–∞—Ä–æ –æ—Ç–ª–∏—á–Ω–æ –ø–æ–º–æ–≥–∞—é—Ç —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –≤ —Ç–∞–∫–∏—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö. –•–æ—Ç–∏—Ç–µ, —á—Ç–æ–±—ã —è –ø–æ—Å–º–æ—Ç—Ä–µ–ª–∞, —á—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –∫–∞—Ä—Ç—ã –ø–æ –≤–∞—à–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏?",
                "–û—Ç–Ω–æ—à–µ–Ω–∏—è ‚Äî —ç—Ç–æ –≤—Å–µ–≥–¥–∞ —Å–ª–æ–∂–Ω–æ –∏ –º–Ω–æ–≥–æ–≥—Ä–∞–Ω–Ω–æ... –£ –º–µ–Ω—è –µ—Å—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ä–∞—Å–∫–ª–∞–¥—ã –∏–º–µ–Ω–Ω–æ –¥–ª—è —Ç–∞–∫–∏—Ö —Å–ª—É—á–∞–µ–≤. –ò–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç –ø–æ–¥—Ä–æ–±–Ω—ã–π –∞–Ω–∞–ª–∏–∑?"
            ],
            '—Ä–∞–±–æ—Ç': [
                "–ö–∞—Ä—å–µ—Ä–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≤–∞–∂–Ω—ã... –¢–∞—Ä–æ –º–æ–∂–µ—Ç –ø–æ–∫–∞–∑–∞—Ç—å —Å–∫—Ä—ã—Ç—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏ –ø–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏. –•–æ—Ç–∏—Ç–µ —Ä–∞–∑–æ–±—Ä–∞—Ç—å –≤–∞—à—É —Å–∏—Ç—É–∞—Ü–∏—é?",
                "–ü–æ–Ω–∏–º–∞—é, –∫–∞–∫ –≤–∞–∂–Ω–æ –Ω–∞–π—Ç–∏ —Å–≤–æ–π –ø—É—Ç—å –≤ —Ä–∞–±–æ—Ç–µ... –ö–∞—Ä—Ç—ã —á–∞—Å—Ç–æ –¥–∞—é—Ç –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ, –Ω–æ –æ—á–µ–Ω—å —Ç–æ—á–Ω—ã–µ –∏–Ω—Å–∞–π—Ç—ã –≤ —Ç–∞–∫–∏—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö."
            ],
            '–¥–µ–Ω—å–≥': [
                "–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã —Ç—Ä–µ–±—É—é—Ç –æ—Å–æ–±–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞... –ï—Å—Ç—å —Ä–∞—Å–∫–ª–∞–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –¥–µ–Ω–µ–∂–Ω—ã–µ –ø–æ—Ç–æ–∫–∏ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏. –ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ —É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ?",
                "–î–µ–Ω—å–≥–∏ ‚Äî —ç—Ç–æ —ç–Ω–µ—Ä–≥–∏—è, –∏ –∫–∞—Ä—Ç—ã –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ –µ—ë —á–∏—Ç–∞—é—Ç... –ú–æ–≥—É –ø–æ–º–æ—á—å —É–≤–∏–¥–µ—Ç—å, –∫—É–¥–∞ –Ω–∞–ø—Ä–∞–≤–∏—Ç—å —É—Å–∏–ª–∏—è –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —Å–∏—Ç—É–∞—Ü–∏–∏."
            ],
            '–≤—ã–±–æ—Ä': [
                "–°–ª–æ–∂–Ω—ã–π –≤—ã–±–æ—Ä... –ó–Ω–∞–∫–æ–º–æ–µ —á—É–≤—Å—Ç–≤–æ. –ö–∞—Ä—Ç—ã –¢–∞—Ä–æ –æ—Ç–ª–∏—á–Ω–æ –ø–æ–º–æ–≥–∞—é—Ç —É–≤–∏–¥–µ—Ç—å –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è —Ä–∞–∑–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤. –•–æ—Ç–∏—Ç–µ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å?",
                "–ö–æ–≥–¥–∞ —Å—Ç–æ–∏—à—å –Ω–∞ —Ä–∞—Å–ø—É—Ç—å–µ, –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å–ª–æ–∂–Ω–æ... –Ø —á–∞—Å—Ç–æ –ø–æ–º–æ–≥–∞—é –≤ —Ç–∞–∫–∏—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö ‚Äî –∫–∞—Ä—Ç—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Ç–æ, —á—Ç–æ –Ω–µ –≤–∏–¥–Ω–æ –Ω–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏."
            ]
        }
        
        response = "–ü–æ–Ω–∏–º–∞—é –≤–∞—à—É —Å–∏—Ç—É–∞—Ü–∏—é... –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≤–∞–∂–Ω–æ —Ä–∞–∑–æ–±—Ä–∞—Ç—å. "
        for keyword, answers in problem_keywords.items():
            if keyword in user_message_lower:
                response += random.choice(answers)
                break
        else:
            response += "–•–æ—Ç–∏—Ç–µ, —á—Ç–æ–±—ã —è —Å–¥–µ–ª–∞–ª–∞ –¥–ª—è –≤–∞—Å —Ä–∞—Å–∫–ª–∞–¥ –∏ –¥–∞–ª–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —ç—Ç–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏?"
        
        responses = [response]
        state['interest_shown'] = True
        
    elif flow == "discuss_price":
        responses = [
            "–•–æ—Ä–æ—à–∏–π –≤–æ–ø—Ä–æ—Å... –û–±—ã—á–Ω–æ —è —Ä–∞–±–æ—Ç–∞—é —Ç–∞–∫: —Å–Ω–∞—á–∞–ª–∞ –º—ã –±–µ—Å–ø–ª–∞—Ç–Ω–æ –æ–±—Å—É–∂–¥–∞–µ–º —Å–∏—Ç—É–∞—Ü–∏—é 10-15 –º–∏–Ω—É—Ç, —è –∑–∞–¥–∞—é –≤–æ–ø—Ä–æ—Å—ã, —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å –≥–ª—É–±–∏–Ω—É. –ï—Å–ª–∏ —á—É–≤—Å—Ç–≤—É—é, —á—Ç–æ –º–æ–≥—É –ø–æ–º–æ—á—å ‚Äî –¥–µ–ª–∞—é –ø–æ–ª–Ω—ã–π —Ä–∞—Å–∫–ª–∞–¥ –∑–∞ 1490 —Ä—É–±–ª–µ–π.\n\n–ö–∞–∫ –≤–∞–º —Ç–∞–∫–æ–π –ø–æ–¥—Ö–æ–¥?",
            "–¶–µ–Ω–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–æ–≥–æ, –Ω–∞—Å–∫–æ–ª—å–∫–æ –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –≤–∞–º –Ω—É–∂–µ–Ω... –£ –º–µ–Ω—è –µ—Å—Ç—å –±–∞–∑–æ–≤—ã–π —Ä–∞—Å–∫–ª–∞–¥ –∑–∞ 990 —Ä—É–±–ª–µ–π –∏ –ø–æ–ª–Ω—ã–π –∑–∞ 1490. –†–∞–∑–Ω–∏—Ü–∞ –≤ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –∫–∞—Ä—Ç –∏ –¥–µ—Ç–∞–ª—å–Ω–æ—Å—Ç–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π.\n\n–ß—Ç–æ –≤–∞–º –±–æ–ª—å—à–µ –ø–æ–¥—Ö–æ–¥–∏—Ç?",
            "–Ø –±–µ—Ä—É 1490 —Ä—É–±–ª–µ–π –∑–∞ –ø–æ–ª–Ω—ã–π —Ä–∞—Å–∫–ª–∞–¥... –≠—Ç–æ –≤–∫–ª—é—á–∞–µ—Ç –∞–Ω–∞–ª–∏–∑ 5-7 –∫–∞—Ä—Ç, –ø–æ–¥—Ä–æ–±–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –≤–∞—à–∏ –≤–æ–ø—Ä–æ—Å—ã. –ù–æ —Å–Ω–∞—á–∞–ª–∞ –º–æ–≥—É –±–µ—Å–ø–ª–∞—Ç–Ω–æ –æ—Ü–µ–Ω–∏—Ç—å —Å–∏—Ç—É–∞—Ü–∏—é ‚Äî –ø—Ä–æ—Å—Ç–æ —Ä–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ?"
        ]
        state['step'] = 'price_discussion'
        
    elif flow == "handle_doubt":
        if '–¥–æ—Ä–æ–≥' in user_message_lower:
            responses = [
                "–ü–æ–Ω–∏–º–∞—é, —á—Ç–æ –∫–∞–∂–µ—Ç—Å—è –¥–æ—Ä–æ–≥–æ... –ù–æ –∑–Ω–∞–µ—Ç–µ, –º–Ω–æ–≥–∏–µ –º–æ–∏ –∫–ª–∏–µ–Ω—Ç—ã –≥–æ–≤–æ—Ä—è—Ç, —á—Ç–æ —è—Å–Ω–æ—Å—Ç—å, –∫–æ—Ç–æ—Ä—É—é –æ–Ω–∏ –ø–æ–ª—É—á–∞—é—Ç, —Å—Ç–æ–∏—Ç –Ω–∞–º–Ω–æ–≥–æ –±–æ–ª—å—à–µ —ç—Ç–∏—Ö –¥–µ–Ω–µ–≥. –≠—Ç–æ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è –≤ —Å–≤–æ–µ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ.\n\n–•–æ—Ç–∏—Ç–µ –Ω–∞—á–∞—Ç—å —Å –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ —Ä–∞–∑–±–æ—Ä–∞ —Å–∏—Ç—É–∞—Ü–∏–∏?",
                "–î–∞, —ç—Ç–æ –Ω–µ –∫–æ–ø–µ–π–∫–∏... –ù–æ –æ–¥–Ω–∞ –æ—à–∏–±–∫–∞ –∏–∑-–∑–∞ –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏—è —Å–∏—Ç—É–∞—Ü–∏–∏ –º–æ–∂–µ—Ç —Å—Ç–æ–∏—Ç—å –≥–æ—Ä–∞–∑–¥–æ –¥–æ—Ä–æ–∂–µ. –ö–∞—Ä—Ç—ã –ø–æ–º–æ–≥–∞—é—Ç —Ç–∞–∫–∏—Ö –æ—à–∏–±–æ–∫ –∏–∑–±–µ–≥–∞—Ç—å.\n\n–ú–æ–∂–µ—Ç, –≤—Å–µ –∂–µ –ø–æ–ø—Ä–æ–±—É–µ–º —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è?"
            ]
        elif '–Ω–µ –≤–µ—Ä' in user_message_lower:
            responses = [
                "–≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ ‚Äî —Å–æ–º–Ω–µ–≤–∞—Ç—å—Å—è... –Ø —Å–∞–º–∞ —Å–Ω–∞—á–∞–ª–∞ –æ—Ç–Ω–æ—Å–∏–ª–∞—Å—å –∫ –¢–∞—Ä–æ —Å–∫–µ–ø—Ç–∏—á–µ—Å–∫–∏. –ù–æ 8 –ª–µ—Ç –ø—Ä–∞–∫—Ç–∏–∫–∏ –ø–æ–∫–∞–∑–∞–ª–∏: —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç. –•–æ—Ç–∏—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ? –ó–∞–¥–∞–º –≤–∞–º 2-3 –≤–æ–ø—Ä–æ—Å–∞ –æ —Å–∏—Ç—É–∞—Ü–∏–∏ ‚Äî –≤—ã —Å–∞–º–∏ –æ—Ü–µ–Ω–∏—Ç–µ —Ç–æ—á–Ω–æ—Å—Ç—å.",
                "–ù–µ –Ω—É–∂–Ω–æ –≤–µ—Ä–∏—Ç—å –≤ –¢–∞—Ä–æ... –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–æ—Å—Ç–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å. –ú–Ω–æ–≥–∏–µ –º–æ–∏ –∫–ª–∏–µ–Ω—Ç—ã –Ω–∞—á–∏–Ω–∞–ª–∏ –∫–∞–∫ —Å–∫–µ–ø—Ç–∏–∫–∏. –ö–∞—Ä—Ç—ã –≥–æ–≤–æ—Ä—è—Ç –Ω–∞ —è–∑—ã–∫–µ –º–µ—Ç–∞—Ñ–æ—Ä ‚Äî —ç—Ç–æ —Å–∫–æ—Ä–µ–µ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—è, —á–µ–º –º–∏—Å—Ç–∏–∫–∞.\n\n–ü–æ–ø—Ä–æ–±—É–µ–º?"
            ]
        else:
            responses = [
                "–ü–æ–Ω–∏–º–∞—é –≤–∞—à–∏ —Å–æ–º–Ω–µ–Ω–∏—è... –ù–æ–≤–æ–µ –≤—Å–µ–≥–¥–∞ –Ω–µ–º–Ω–æ–≥–æ —Å—Ç—Ä–∞—à–Ω–æ. –ù–æ —á—Ç–æ, –µ—Å–ª–∏ —ç—Ç–æ –∏–º–µ–Ω–Ω–æ —Ç–æ—Ç —à–∞–≥, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–µ–Ω –≤–∞–º –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å?\n\n–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ, —á—Ç–æ –≤–∞—Å –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç?",
                "–î–∞–≤–∞–π—Ç–µ –¥–≤–∏–≥–∞—Ç—å—Å—è –º–∞–ª–µ–Ω—å–∫–∏–º–∏ —à–∞–≥–∞–º–∏... –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ—Å—Ç–æ —Ä–∞—Å—Å–∫–∞–∂–∏—Ç–µ, —á—Ç–æ –≤–∞—Å –±–µ—Å–ø–æ–∫–æ–∏—Ç. –ù–∏ –∫ —á–µ–º—É –Ω–µ –æ–±—è–∑—ã–≤–∞–µ—Ç. –ê —Ç–∞–º –ø–æ—Å–º–æ—Ç—Ä–∏–º?"
            ]
        state['objections'].append(user_message)
        
    elif flow == "ask_for_details":
        responses = [
            "–•–æ—Ä–æ—à–æ, –¥–∞–≤–∞–π—Ç–µ –Ω–∞—á–Ω–µ–º... –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ —Å–∏—Ç—É–∞—Ü–∏–∏. –ß—Ç–æ –∏–º–µ–Ω–Ω–æ –≤–∞—Å –±–µ—Å–ø–æ–∫–æ–∏—Ç –∏–ª–∏ —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–Ω—è—Ç—å?",
            "–û—Ç–ª–∏—á–Ω–æ! –¢–æ–≥–¥–∞ —Ä–∞—Å—Å–∫–∞–∂–∏—Ç–µ –º–Ω–µ –±–æ–ª—å—à–µ... –ß–µ–º –¥–µ—Ç–∞–ª—å–Ω–µ–µ –æ–ø–∏—à–µ—Ç–µ, —Ç–µ–º —Ç–æ—á–Ω–µ–µ –±—É–¥–µ—Ç –∞–Ω–∞–ª–∏–∑. –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ –≤–∞—à–µ–π –∂–∏–∑–Ω–∏ —Å–µ–π—á–∞—Å?",
            "–ù–∞—á–∏–Ω–∞–µ–º... –û–ø–∏—à–∏—Ç–µ —Å–∏—Ç—É–∞—Ü–∏—é –≤ –¥–µ—Ç–∞–ª—è—Ö. –ú–æ–∂–Ω–æ –≤ —Å–≤–æ–±–æ–¥–Ω–æ–π —Ñ–æ—Ä–º–µ, –≥–ª–∞–≤–Ω–æ–µ ‚Äî —á—Ç–æ–±—ã —è –ø–æ–Ω—è–ª–∞ —Å—É—Ç—å."
        ]
        state['step'] = 'collecting_details'
        
    elif flow == "offer_payment":
        payment_url = "https://yoomoney.ru/to/4100111234567890"  # –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –†–ï–ê–õ–¨–ù–£–Æ
        responses = [
            f"–û—Ç–ª–∏—á–Ω–æ! –¢–æ–≥–¥–∞ –¥–∞–≤–∞–π—Ç–µ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫ —Ä–∞–±–æ—Ç–µ...\n\n–í–æ—Ç —Å—Å—ã–ª–∫–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã: {payment_url}\n\n–°—É–º–º–∞: 1490 —Ä—É–±–ª–µ–π (–µ—Å–ª–∏ –ø–µ—Ä–≤—ã–π —Ä–∞–∑ ‚Äî 1290 —Ä—É–±–ª–µ–π).\n\n–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –ø—Ä–∏—à–ª–∏—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ ¬´–æ–ø–ª–∞—Ç–∏–ª(–∞)¬ª ‚Äî –∏ —è —Å—Ä–∞–∑—É –Ω–∞—á–Ω—É —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞–¥ –≤–∞—à–∏–º —Ä–∞—Å–∫–ª–∞–¥–æ–º.",
            f"–ü—Ä–µ–∫—Ä–∞—Å–Ω–æ! –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –∫ –æ–ø–ª–∞—Ç–µ –ø–æ —ç—Ç–æ–π —Å—Å—ã–ª–∫–µ: {payment_url}\n\n1490 —Ä—É–±–ª–µ–π –∑–∞ –ø–æ–ª–Ω—ã–π —Ä–∞—Å–∫–ª–∞–¥ —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º –∞–Ω–∞–ª–∏–∑–æ–º.\n\n–ö–∞–∫ —Ç–æ–ª—å–∫–æ –æ–ø–ª–∞—Ç–∞ –ø—Ä–æ–π–¥–µ—Ç, –¥–∞–π—Ç–µ –º–Ω–µ –∑–Ω–∞—Ç—å ‚Äî –∏ –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç –∫–∞—Ä—Ç.",
            f"–î–æ–≥–æ–≤–æ—Ä–∏–ª–∏—Å—å! –û–ø–ª–∞—Ç–∏—Ç—å –º–æ–∂–Ω–æ –∑–¥–µ—Å—å: {payment_url}\n\n1490 —Ä—É–±–ª–µ–π (–¥–ª—è –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ ‚Äî 1290 —Ä—É–±–ª–µ–π).\n\n–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –Ω–∞–ø–∏—à–∏—Ç–µ –º–Ω–µ ‚Äî –æ–±—ã—á–Ω–æ —è –¥–µ–ª–∞—é —Ä–∞—Å–∫–ª–∞–¥—ã –≤–µ—á–µ—Ä–æ–º, —Ç–∞–∫ —á—Ç–æ –º–æ–∂–µ—Ç–µ –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç —É–∂–µ —Å–µ–≥–æ–¥–Ω—è."
        ]
        state['step'] = 'awaiting_payment'
        
    elif flow == "continue_conversation":
        # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ç–µ–∫—É—â—É—é —Ç–µ–º—É
        if state.get('waiting_for_response'):
            responses = [
                "–ñ–¥—É –≤–∞—à–µ–≥–æ –æ—Ç–≤–µ—Ç–∞... –†–∞—Å—Å–∫–∞–∂–µ—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ?",
                "–ß—Ç–æ –≤—ã –¥—É–º–∞–µ—Ç–µ –ø–æ —ç—Ç–æ–º—É –ø–æ–≤–æ–¥—É?",
                "–ö–∞–∫ –≤–∞–º —Ç–∞–∫–∞—è –∏–¥–µ—è?"
            ]
        else:
            responses = [
                "–ü–æ–Ω–∏–º–∞—é... –ü—Ä–æ–¥–æ–ª–∂–∏–º?",
                "–Ø—Å–Ω–æ... –ß—Ç–æ –µ—â–µ –≤–∞—Å –±–µ—Å–ø–æ–∫–æ–∏—Ç?",
                "–•–æ—Ä–æ—à–æ... –ö—É–¥–∞ –¥–≤–∏–∂–µ–º—Å—è –¥–∞–ª—å—à–µ?"
            ]
        
    elif flow == "deepen_conversation":
        # –£–≥–ª—É–±–ª—è–µ–º —Ä–∞–∑–≥–æ–≤–æ—Ä
        questions = [
            "–ê —á—Ç–æ –≤—ã —Å–∞–º–∏ —á—É–≤—Å—Ç–≤—É–µ—Ç–µ –ø–æ –ø–æ–≤–æ–¥—É —ç—Ç–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏?",
            "–ö–∞–∫ –¥–∞–≤–Ω–æ —ç—Ç–æ –¥–ª–∏—Ç—Å—è?",
            "–ß—Ç–æ –≤—ã —É–∂–µ –ø—Ä–æ–±–æ–≤–∞–ª–∏ —Å–¥–µ–ª–∞—Ç—å?",
            "–ß–µ–≥–æ –±—ã –≤—ã —Ö–æ—Ç–µ–ª–∏ –≤ –∏–¥–µ–∞–ª–µ?",
            "–ß—Ç–æ –≤–∞—Å –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–µ–π—á–∞—Å?",
            "–ê —á—Ç–æ –≥–æ–≤–æ—Ä—è—Ç –≤–∞—à–∏ –±–ª–∏–∑–∫–∏–µ –ø–æ —ç—Ç–æ–º—É –ø–æ–≤–æ–¥—É?"
        ]
        responses = [random.choice(questions)]
        state['waiting_for_response'] = True
        
    else:
        # –ó–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
        responses = [
            "–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ... –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ?",
            "–ü–æ–Ω—è–ª–∞ –≤–∞—Å... –ê —á—Ç–æ –≤—ã –æ–± —ç—Ç–æ–º –¥—É–º–∞–µ—Ç–µ?",
            "–Ø—Å–Ω–æ... –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ, —è —Å–ª—É—à–∞—é."
        ]
    
    response = random.choice(responses)
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –±–æ—Ç–∞ –≤ –∏—Å—Ç–æ—Ä–∏—é
    add_to_history(state.get('chat_id'), 'bot', response)
    state['last_bot_message'] = response
    
    return response

def schedule_follow_up(chat_id, delay_minutes=10):
    """–ü–ª–∞–Ω–∏—Ä—É–µ—Ç follow-up —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"""
    def follow_up():
        time.sleep(delay_minutes * 60)
        state = get_conversation_state(chat_id)
        
        # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ—Ç–≤–µ—á–∞–ª –±–æ–ª—å—à–µ X –º–∏–Ω—É—Ç
        if time.time() - state['last_message_time'] > (delay_minutes * 60 - 30):
            follow_ups = [
                "–í—ã –µ—â–µ –∑–¥–µ—Å—å? –•–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –Ω–∞—à —Ä–∞–∑–≥–æ–≤–æ—Ä?",
                "–ñ–¥—É –≤–∞—à–µ–≥–æ –æ—Ç–≤–µ—Ç–∞... –ï—Å—Ç—å —á—Ç–æ –¥–æ–±–∞–≤–∏—Ç—å?",
                "–ö–∞–∫ –≤–∞—à–∏ –º—ã—Å–ª–∏ –ø–æ –ø–æ–≤–æ–¥—É –Ω–∞—à–µ–≥–æ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞?",
                "–í–µ—Ä–Ω–µ–º—Å—è –∫ –Ω–∞—à–µ–º—É —Ä–∞–∑–≥–æ–≤–æ—Ä—É? –ï—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã?"
            ]
            
            response = random.choice(follow_ups)
            send_message_with_delay(chat_id, response, delay_seconds=random.randint(10, 30))
    
    thread = threading.Thread(target=follow_up)
    thread.daemon = True
    thread.start()
    state = get_conversation_state(chat_id)
    state['scheduled_messages'].append(thread)
    
    # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    if len(state['scheduled_messages']) > 3:
        state['scheduled_messages'] = state['scheduled_messages'][-3:]

def process_message_async(chat_id, user_name, message_text):
    """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π"""
    # –°–Ω–∞—á–∞–ª–∞ –Ω–µ–±–æ–ª—å—à–æ–π –æ—Ç–∫–ª–∏–∫ (—Ç–∏–ø–∞ "–ø–µ—á–∞—Ç–∞–µ—Ç...")
    time.sleep(random.randint(2, 5))
    
    # –ü–æ–ª—É—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    state = get_conversation_state(chat_id)
    state['chat_id'] = chat_id
    state['name'] = user_name
    
    # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
    state['message_count'] = state.get('message_count', 0) + 1
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
    response = generate_human_response(message_text, state)
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    update_conversation_state(chat_id, state)
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
    send_message_with_delay(chat_id, response)
    
    # –ü–ª–∞–Ω–∏—Ä—É–µ–º follow-up –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    if state['message_count'] > 1 and not state.get('waiting_for_response'):
        schedule_follow_up(chat_id, random.randint(15, 30))
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è
    save_states()

@app.route('/webhook', methods=['POST'])
def webhook():
    """–û—Å–Ω–æ–≤–Ω–æ–π webhook –æ—Ç Telegram"""
    try:
        data = request.get_json()
        logger.info("üì• –ü–æ–ª—É—á–µ–Ω webhook")
        
        if not data:
            return jsonify({"status": "error", "message": "No data"}), 400
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
        if 'message' in data and 'text' in data['message']:
            message_text = data['message']['text'].strip()
            chat_id = data['message']['chat']['id']
            user_name = data['message']['from'].get('first_name', '–¥—Ä—É–≥')
            
            logger.info(f"üë§ {user_name} ({chat_id}): {message_text}")
            
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start
            if message_text.lower().startswith('/start'):
                # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞
                update_conversation_state(chat_id, {
                    'step': 'start',
                    'message_count': 0,
                    'last_user_message': '',
                    'conversation_history': [],
                    'waiting_for_response': False
                })
                
                response_text = """–ü—Ä–∏–≤–µ—Ç! üëã –Ø –ê–Ω–Ω–∞, –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ç–∞—Ä–æ–ª–æ–≥. 

8 –ª–µ—Ç –ø–æ–º–æ–≥–∞—é –ª—é–¥—è–º –Ω–∞—Ö–æ–¥–∏—Ç—å —è—Å–Ω–æ—Å—Ç—å –≤ —Å–ª–æ–∂–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö —Å –ø–æ–º–æ—â—å—é –∫–∞—Ä—Ç –¢–∞—Ä–æ.

–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ, —á—Ç–æ –≤–∞—Å –ø—Ä–∏–≤–µ–ª–æ –∫–æ –º–Ω–µ —Å–µ–≥–æ–¥–Ω—è? –ú–æ–∂–µ—Ç, –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å –∏–ª–∏ —Å–∏—Ç—É–∞—Ü–∏—è, –≤ –∫–æ—Ç–æ—Ä–æ–π –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å?"""
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
                send_message_with_delay(chat_id, response_text, delay_seconds=random.randint(5, 15))
            
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±—ã—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            else:
                # –ó–∞–ø—É—Å–∫–∞–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É
                thread = threading.Thread(
                    target=process_message_async,
                    args=(chat_id, user_name, message_text)
                )
                thread.daemon = True
                thread.start()
            
            return jsonify({"status": "success", "processed": True}), 200
        
        return jsonify({"status": "success", "processed": False}), 200
        
    except Exception as e:
        logger.error(f"üö® –û—à–∏–±–∫–∞ –≤ webhook: {e}")
        return jsonify({"status": "error", "message": str(e)}), 400

@app.route('/set_webhook', methods=['GET'])
def set_webhook():
    """–£—Å—Ç–∞–Ω–æ–≤–∫–∞ webhook"""
    try:
        if not BOT_TOKEN:
            return jsonify({"error": "BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"}), 400
        
        webhook_url = request.host_url.rstrip('/') + '/webhook'
        logger.info(f"üîó –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é webhook: {webhook_url}")
        
        telegram_url = f"https://api.telegram.org/bot{BOT_TOKEN}/setWebhook"
        response = requests.post(telegram_url, json={'url': webhook_url}, timeout=10)
        
        return jsonify({
            "success": response.status_code == 200,
            "webhook_url": webhook_url,
            "response": response.json() if response.status_code == 200 else response.text
        }), 200
        
    except Exception as e:
        logger.error(f"üö® –û—à–∏–±–∫–∞: {e}")
        return jsonify({"error": str(e)}), 400

@app.route('/')
def home():
    return jsonify({
        "status": "active",
        "bot": "@Tarotyour_bot",
        "description": "–ß–µ–ª–æ–≤–µ–∫–æ-–ø–æ–¥–æ–±–Ω—ã–π –±–æ—Ç-—Ç–∞—Ä–æ–ª–æ–≥ —Å –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏ –æ—Ç–≤–µ—Ç–æ–≤",
        "response_delay": "60-180 —Å–µ–∫—É–Ω–¥",
        "features": ["–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏", "Follow-up —Å–æ–æ–±—â–µ–Ω–∏—è", "–ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –¥–∏–∞–ª–æ–≥"]
    })

if __name__ == '__main__':
    port = int(os.environ.get('PORT', 10000))
    logger.info(f"üöÄ –ó–ê–ü–£–°–ö –ë–û–¢–ê –° –ó–ê–î–ï–†–ñ–ö–ê–ú–ò –ù–ê –ü–û–†–¢–£ {port}")
    logger.info(f"‚è∞ –ó–∞–¥–µ—Ä–∂–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤: 1-3 –º–∏–Ω—É—Ç—ã")
    logger.info(f"üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π –≤ —Ñ–∞–π–ª: {STATE_FILE}")
    app.run(host='0.0.0.0', port=port, debug=False)
